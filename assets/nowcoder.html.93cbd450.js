import{_ as e}from"./_plugin-vue_export-helper.cdc0426e.js";import{o,c,a as n,d as t,b as s,e as p,r as l}from"./app.8c0e81d7.js";const u={},i={id:"\u9879\u76EE\u6E90\u7801",tabindex:"-1"},k=n("a",{class:"header-anchor",href:"#\u9879\u76EE\u6E90\u7801","aria-hidden":"true"},"#",-1),r=s(),d={href:"https://github.com/xumingyu2018/DemoNowcoder",target:"_blank",rel:"noopener noreferrer"},v=s("\u9879\u76EE\u6E90\u7801"),m=p(`<h2 id="\u4E3B\u9875\u8BA8\u8BBA\u533A\u5206\u9875\u67E5\u8BE2\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u4E3B\u9875\u8BA8\u8BBA\u533A\u5206\u9875\u67E5\u8BE2\u529F\u80FD" aria-hidden="true">#</a> \u4E3B\u9875\u8BA8\u8BBA\u533A\u5206\u9875\u67E5\u8BE2\u529F\u80FD</h2><h3 id="_1-\u9996\u5148\u8BBE\u8BA1dao\u5C42\u63A5\u53E3-\u5B9E\u4F53\u7C7B\u7565" tabindex="-1"><a class="header-anchor" href="#_1-\u9996\u5148\u8BBE\u8BA1dao\u5C42\u63A5\u53E3-\u5B9E\u4F53\u7C7B\u7565" aria-hidden="true">#</a> 1.\u9996\u5148\u8BBE\u8BA1Dao\u5C42\u63A5\u53E3\uFF08\u5B9E\u4F53\u7C7B\u7565\uFF09</h3><p>\u4EE5\u4E0B\u662F\u67E5\u8BE2\u529F\u80FD\u4E0D\u5305\u62EC\u5206\u9875 \uFF08\u5176\u4E2DuserId\u5728DiscussPost\u7C7B\u4E2D\u4F5C\u4E3A\u5916\u952E\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u67E5\u8BE2</span>
<span class="token comment">//userId=0\u4E3A\u6240\u6709\u5E16\u5B50\uFF0C1\u4E3A\u6211\u7684\u5E16\u5B50</span>
<span class="token comment">//\u6BCF\u4E2A\u53C2\u6570\u5FC5\u987B\u52A0@Param(&quot;&quot;)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//\u4E3A\u5206\u9875\u67E5\u8BE2\u670D\u52A1\u7684\u67E5\u8BE2\u603B\u6761\u6570</span>
<span class="token comment">//\u7ED9\u53C2\u6570\u8D77\u522B\u540D\uFF0C\u5982\u679C\u53EA\u6709\u4E00\u4E2A\u53C2\u6570\u5E76\u4E14\u8981\u5728&lt;if&gt;\u91CC\u4F7F\u7528\uFF0C\u5219\u5FC5\u987B\u52A0\u522B\u540D</span>
<span class="token keyword">int</span> <span class="token function">selectDiscussRows</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">------------- Mapper.xml -------------&gt;</span>
  <span class="token operator">&lt;</span><span class="token keyword">sql</span> id<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span>
      id<span class="token punctuation">,</span>user_id<span class="token punctuation">,</span>title<span class="token punctuation">,</span>content<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>comment_count<span class="token punctuation">,</span>score
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">sql</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token keyword">sql</span> id<span class="token operator">=</span><span class="token string">&quot;insertFields&quot;</span><span class="token operator">&gt;</span>
      user_id<span class="token punctuation">,</span>title<span class="token punctuation">,</span>content<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span><span class="token keyword">status</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>comment_count<span class="token punctuation">,</span>score
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">sql</span><span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--\u67E5\u8BE2\u4E0D\u662F\u88AB\u62C9\u9ED1\u7684\u5E16\u5B50\u5E76\u4E14userId\u4E0D\u4E3A0\u6309\u7167type\u6307\u5B9A\uFF0C\u65F6\u95F4\u6392\u5E8F--&gt;</span>
  <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectDiscussPosts&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;DiscussPost&quot;</span><span class="token operator">&gt;</span>
      <span class="token keyword">select</span> <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
      <span class="token keyword">from</span> discuss_post
      <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">!=</span><span class="token number">2</span>
      <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;userId!=0&quot;</span><span class="token operator">&gt;</span>
          <span class="token operator">and</span> user_id<span class="token operator">=</span><span class="token comment">#{userId}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;orderMode==0&quot;</span><span class="token operator">&gt;</span>
          <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">type</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>create_time <span class="token keyword">desc</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;orderMode==1&quot;</span><span class="token operator">&gt;</span>
          <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">type</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>score <span class="token keyword">desc</span><span class="token punctuation">,</span>create_time <span class="token keyword">desc</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
      <span class="token keyword">limit</span> <span class="token comment">#{offset},#{limit}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--userId=0\u67E5\u6240\u6709;userId!=0\u67E5\u4E2A\u4EBA\u53D1\u5E16\u6570--&gt;</span>
  <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectDiscussRows&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
      <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
      <span class="token keyword">from</span> discuss_post
      <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">!=</span><span class="token number">2</span>
      <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;userId!=0&quot;</span><span class="token operator">&gt;</span>
          <span class="token operator">and</span> user_id<span class="token operator">=</span><span class="token comment">#{userId}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7136\u540E\u8BBE\u8BA1service\u5C42\u8C03\u7528dao\u5C42\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-\u7136\u540E\u8BBE\u8BA1service\u5C42\u8C03\u7528dao\u5C42\u63A5\u53E3" aria-hidden="true">#</a> 2.\u7136\u540E\u8BBE\u8BA1Service\u5C42\u8C03\u7528Dao\u5C42\u63A5\u53E3</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">DiscussPostMapper</span> discussPostMapper<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>offset<span class="token punctuation">,</span>limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussRows</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u5176\u6B21\u5C01\u88C5\u5206\u9875\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_3-\u5176\u6B21\u5C01\u88C5\u5206\u9875\u529F\u80FD" aria-hidden="true">#</a> 3.\u5176\u6B21\u5C01\u88C5\u5206\u9875\u529F\u80FD</h3><p>\u5C01\u88C5\u5206\u9875\u529F\u80FD\u76F8\u5173\u4FE1\u606F\u5728Page\u7C7B\uFF01\uFF01</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token punctuation">{</span>

    <span class="token comment">//\u5F53\u524D\u9875\u9762</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> current<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//\u663E\u793A\u4E0A\u9650</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> limit<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token comment">//\u6570\u636E\u603B\u6570(\u7528\u4E8E\u8BA1\u7B97\u603B\u9875\u6570)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> rows<span class="token punctuation">;</span>
    <span class="token comment">//\u67E5\u8BE2\u8DEF\u5F84(\u7528\u4E8E\u590D\u7528\u5206\u9875\u94FE\u63A5)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrent</span><span class="token punctuation">(</span><span class="token keyword">int</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u8981\u4F5C\u8F93\u5165\u5224\u65AD</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> current<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>limit<span class="token operator">&gt;=</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>limit<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">=</span> limit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rows <span class="token operator">=</span> rows<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span> \u83B7\u53D6\u5F53\u524D\u9875\u7684\u8D77\u59CB\u884C<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//current*limit-limit</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>current<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span>\u83B7\u53D6\u603B\u9875\u6570<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//rows/limit[+1]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows<span class="token operator">%</span>limit<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> rows<span class="token operator">/</span>limit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> rows<span class="token operator">/</span>limit<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span>\u83B7\u53D6\u8D77\u59CB\u9875\u7801<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> from<span class="token operator">=</span>current<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> from <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> from<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span>\u83B7\u53D6\u7ED3\u675F\u9875\u7801<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token keyword">to</span><span class="token operator">=</span>current<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> total<span class="token operator">=</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">to</span> <span class="token operator">&gt;</span> total <span class="token operator">?</span> total <span class="token operator">:</span> <span class="token keyword">to</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u6700\u540E\u8BBE\u8BA1controller\u5C42" tabindex="-1"><a class="header-anchor" href="#_4-\u6700\u540E\u8BBE\u8BA1controller\u5C42" aria-hidden="true">#</a> 4.\u6700\u540E\u8BBE\u8BA1Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostService</span> discussPostService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getIndexPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//\u4F20\u5165model\u53C2\u6570\u662F\u56E0\u4E3A\u8981\u8FD4\u56DE\u503C\u7ED9View</span>
        <span class="token comment">/*\u65B9\u6CD5\u8C03\u7528\u524D\uFF0CspringMVC\u81EA\u52A8\u5B9E\u4F8B\u5316Model\u548CPage,\u5E76\u5C06Page\u6CE8\u5165Model
          \u5728thymeleaf\u4E2D\u53EF\u4EE5\u76F4\u63A5\u8BBF\u95EEPage\u5BF9\u8C61\u4E2D\u7684\u6570\u636E */</span>
        
        <span class="token comment">//\u5206\u9875</span>
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/community/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//\u67E5\u8BE2\u6240\u6709\uFF0C\u8D77\u59CB\u4E3Apage.getOffset()\uFF0C\u7EC8\u6B62\u4E3Apage.getLimit()\u4E2A\u5E16\u5B50\uFF0C</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list<span class="token operator">=</span>discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/*\u5C06\u67E5\u8BE2\u7684post\u5E16\u5B50\u548Cuser\u7528\u6237\u540D\u62FC\u63A5\u540E\u653E\u5165map\u4E2D,\u6700\u540E\u628A\u5168\u90E8map\u653E\u5165\u65B0\u7684List\u4E2D,
          \u56E0\u4E3AUserId\u662F\u5916\u952E\uFF0C\u9700\u8981\u663E\u793A\u7684\u662F\u5BF9\u5E94\u7684\u540D\u5B57\u5373\u53EF */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> discussPost <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post<span class="token operator">:</span>list<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5C06\u67E5\u8BE2\u5230\u7684\u5E16\u5B50\u653E\u5165map</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5C06\u53D1\u5E03\u5E16\u5B50\u5BF9\u5E94\u7684\u7528\u6237id\u4F5C\u4E3A\u53C2\u6570</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUser</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5C06\u53D1\u5E16\u5B50\u7684\u6240\u6709\u7528\u6237\u653E\u5165map</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u663E\u793A\u5E16\u5B50\u70B9\u8D5E\u6570\u91CF</span>
                <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">//\u5C06\u7EC4\u5408\u7684map\u653E\u5165List&lt;&gt;</span>
                discussPost<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;discussPosts&quot;</span><span class="token punctuation">,</span>discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u524D\u7AEF\u9875\u9762\u8BBE\u8BA1-thymeleaf" tabindex="-1"><a class="header-anchor" href="#_5-\u524D\u7AEF\u9875\u9762\u8BBE\u8BA1-thymeleaf" aria-hidden="true">#</a> 5.\u524D\u7AEF\u9875\u9762\u8BBE\u8BA1\uFF08Thymeleaf\uFF09</h3><h4 id="_5-1\u67E5\u8BE2\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-1\u67E5\u8BE2\u9875\u9762" aria-hidden="true">#</a> 5.1\u67E5\u8BE2\u9875\u9762</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!-- \u5E16\u5B50\u5217\u8868 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list-unstyled<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:each=&quot;map:\${discussPosts}\u5FAA\u73AF\u904D\u5386model.addAttribute\u4F20\u8FC7\u6765\u7684discussPosts\u8FD9\u4E2A\u96C6\u5408\uFF0C\u6BCF\u6B21\u5FAA\u73AF\u5F97\u5230map\u5BF9\u8C61--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>media pb-3 pt-3 mb-3 border-bottom<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${discussPosts}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>site/profile.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:src=&quot;\${map.user.headerUrl}&quot;\u5E95\u5C42\u662Fmap.get(&quot;user&quot;)-&gt;user.get(&quot;headerUrl&quot;)--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.headerUrl}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mr-4 rounded-circle<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>50px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>50px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>media-body<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mt-0 mb-3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:utext\u53EF\u4EE5\u8F6C\u4E49\u6587\u672C\u4E2D\u7279\u6B8A\u5B57\u7B26--&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.title}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5907\u6218\u6625\u62DB\uFF0C\u9762\u8BD5\u5237\u9898\u8DDF\u4ED6\u590D\u4E60\uFF0C\u4E00\u4E2A\u6708\u5168\u641E\u5B9A\uFF01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>badge badge-secondary bg-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.type==1}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7F6E\u9876<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>badge badge-secondary bg-danger<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.status==1}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7CBE\u534E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-muted font-size-12<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:text=&quot;\${#dates.format(map.post.createTime)} #\u662F\u5F15\u7528thymeleaf\u81EA\u5E26\u7684\u5DE5\u5177--&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mr-3<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5BD2\u6C5F\u96EA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u</span><span class="token punctuation">&gt;</span></span> \u53D1\u5E03\u4E8E <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.post.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-15 15:32:18<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d-inline float-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d-inline ml-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8D5E 11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d-inline ml-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>d-inline ml-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u5E16 7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>            
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2\u5206\u9875\u529F\u80FD\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-2\u5206\u9875\u529F\u80FD\u9875\u9762" aria-hidden="true">#</a> 5.2\u5206\u9875\u529F\u80FD\u9875\u9762</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!-- \u5206\u9875 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mt-5<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${page.rows&gt;0}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>fragment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pagination<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pagination justify-content-center<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:href=&quot;@{\${page.path}(current=1,limit=5)}&quot;\u7B49\u6548\u4E8E/index?current=1&amp;limit=5--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{\${page.path}(current=1)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u9996\u9875<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--th:class=&quot;|page-item \${page.current==1?&#39;disabled&#39;:&#39;&#39;}|&quot; \u52A8\u6001\u4E0A\u4E00\u9875\u7981\u7528  \u56FA\u5B9A\u6570\u636E+\u53D8\u91CF\u4F7F\u7528\u65B9\u6CD5:\u52A0|| --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|page-item \${page.current==1?&#39;disabled&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{\${page.path}(current=\${page.current-1})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4E0A\u4E00\u9875<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!--#numbers.sequence #\u8C03\u7528thymelead\u81EA\u5E26\u5DE5\u5177numbers,\u4ECEfrom\u5230to\u7684\u6570\u7EC4--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|page-item \${i==page.current?&#39;active&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>i:\${#numbers.sequence(page.from,page.to)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${i}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|page-item \${page.current==page.total?&#39;disabled&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{\${page.path}(current=\${page.current+1})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4E0B\u4E00\u9875<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>page-link<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{\${page.path}(current=\${page.total})}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u672B\u9875<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u6CE8\u518C\u767B\u5F55\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u518C\u767B\u5F55\u529F\u80FD" aria-hidden="true">#</a> \u6CE8\u518C\u767B\u5F55\u529F\u80FD</h1><h2 id="\u53D1\u9001\u90AE\u4EF6" tabindex="-1"><a class="header-anchor" href="#\u53D1\u9001\u90AE\u4EF6" aria-hidden="true">#</a> \u53D1\u9001\u90AE\u4EF6</h2><h3 id="_1-\u90AE\u7BB1\u8BBE\u7F6E-\u542F\u7528smtp\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#_1-\u90AE\u7BB1\u8BBE\u7F6E-\u542F\u7528smtp\u670D\u52A1" aria-hidden="true">#</a> 1.\u90AE\u7BB1\u8BBE\u7F6E\uFF1A\u542F\u7528SMTP\u670D\u52A1</h3><h3 id="_2-springemail" tabindex="-1"><a class="header-anchor" href="#_2-springemail" aria-hidden="true">#</a> 2.SpringEmail</h3><h4 id="_2-1\u914D\u7F6Exml\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_2-1\u914D\u7F6Exml\u6587\u4EF6" aria-hidden="true">#</a> 2.1\u914D\u7F6Exml\u6587\u4EF6</h4><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-mail<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2\u5728application-yml\u914D\u7F6E\u90AE\u7BB1\u53C2\u6570" tabindex="-1"><a class="header-anchor" href="#_2-2\u5728application-yml\u914D\u7F6E\u90AE\u7BB1\u53C2\u6570" aria-hidden="true">#</a> 2.2\u5728application.yml\u914D\u7F6E\u90AE\u7BB1\u53C2\u6570</h4><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">#  \u914D\u7F6E\u90AE\u7BB1</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">mail</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> smtp.qq.com
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">465</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> xxx@qq.com //\u672C\u7F51\u7AD9\u7684\u53D1\u9001\u65B9
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx  //\u5BC6\u7801\u4E3A\u751F\u6210\u6388\u6743\u7801\u540E\u7ED9\u7684\u5BC6\u7801
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> smtps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3\u521B\u5EFAmailclient\u90AE\u7BB1\u5DE5\u5177\u7C7B" tabindex="-1"><a class="header-anchor" href="#_2-3\u521B\u5EFAmailclient\u90AE\u7BB1\u5DE5\u5177\u7C7B" aria-hidden="true">#</a> 2.3\u521B\u5EFAMailClient\u90AE\u7BB1\u5DE5\u5177\u7C7B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MailClient</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger<span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MailClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JavaMailSender</span> javaMailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.mail.username}&quot;</span><span class="token punctuation">)</span><span class="token comment">//\u5C06yml\u7684\u5C5E\u6027\u6CE8\u5165\u5230from</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> from<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">,</span><span class="token class-name">String</span> subject<span class="token punctuation">,</span><span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//MimeMessage\u7528\u4E8E\u5C01\u88C5\u90AE\u4EF6\u76F8\u5173\u4FE1\u606F</span>
            <span class="token class-name">MimeMessage</span> message <span class="token operator">=</span> javaMailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u9700\u8981\u4E00\u4E2A\u90AE\u4EF6\u5E2E\u52A9\u5668\uFF0C\u8D1F\u8D23\u6784\u5EFAMimeMessage\u5BF9\u8C61</span>
            <span class="token class-name">MimeMessageHelper</span> helper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            helper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u652F\u6301HTML\u6587\u672C</span>
            helper<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u53D1\u9001\u90AE\u4EF6\u90FD\u6709JavaMailSender\u6765\u505A</span>
            javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span><span class="token function">getMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MessagingException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u53D1\u9001\u90AE\u4EF6\u5931\u8D25\uFF1A&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4\u6D4B\u8BD5\u7C7B" tabindex="-1"><a class="header-anchor" href="#_2-4\u6D4B\u8BD5\u7C7B" aria-hidden="true">#</a> 2.4\u6D4B\u8BD5\u7C7B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">MailClient</span> mailClient<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">TemplateEngine</span> templateEngine<span class="token punctuation">;</span><span class="token comment">//\u6CE8\u5165HTML\u6A21\u677F\u5F15\u64CE\u7C7B\uFF0C\u6A21\u677F\u683C\u5F0F\u5316</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTextMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//\u53D1\u9001\u6587\u672C\u7C7B\u578B\u90AE\u4EF6</span>
    mailClient<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token string">&quot;xmy981022@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Welcome&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testHTMLMail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//\u53D1\u9001thymeleaf html\u7C7B\u578B\u6587\u4EF6</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Nevermore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> content <span class="token operator">=</span> templateEngine<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">&quot;/mail/activation&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mailClient<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token string">&quot;xmy981022@163.com&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HTML&quot;</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


\u6CE8\u610F\uFF1A<span class="token class-name">JavaMailSender</span>\u548C<span class="token class-name">TemplateEngine</span>\u4F1A\u88AB\u81EA\u52A8\u6CE8\u5165\u5230spring\u4E2D

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u6CE8\u518C\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u6CE8\u518C\u529F\u80FD" aria-hidden="true">#</a> \u6CE8\u518C\u529F\u80FD</h2><h3 id="_1-\u914D\u7F6Eapplication-properties\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_1-\u914D\u7F6Eapplication-properties\u6587\u4EF6" aria-hidden="true">#</a> 1.\u914D\u7F6Eapplication.properties\u6587\u4EF6</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">community.path.domain</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8080</span>
<span class="token key atrule">server.servlet.context-path</span><span class="token punctuation">:</span> /community
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u521B\u5EFA\u5DE5\u5177\u7C7B-\u5904\u7406md5\u52A0\u5BC6\u3001\u751F\u6210\u968F\u673A\u6570\u3001\u6FC0\u6D3B\u6807\u5FD7\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-\u521B\u5EFA\u5DE5\u5177\u7C7B-\u5904\u7406md5\u52A0\u5BC6\u3001\u751F\u6210\u968F\u673A\u6570\u3001\u6FC0\u6D3B\u6807\u5FD7\u63A5\u53E3" aria-hidden="true">#</a> 2.\u521B\u5EFA\u5DE5\u5177\u7C7B\uFF08\u5904\u7406MD5\u52A0\u5BC6\u3001\u751F\u6210\u968F\u673A\u6570\u3001\u6FC0\u6D3B\u6807\u5FD7\u63A5\u53E3\uFF09</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommunityUtil</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * \u751F\u6210\u968F\u673A\u5B57\u7B26\u4E32
    * \u7528\u4E8E\u90AE\u4EF6\u6FC0\u6D3B\u7801\uFF0Csalt5\u4F4D\u968F\u673A\u6570\u52A0\u5BC6
    /
    public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll(&quot;-&quot;,&quot;&quot;);
    }
    /* MD5\u52A0\u5BC6
    * hello--&gt;abc123def456
    * hello + 3e4a8--&gt;abc123def456abc
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//MD5\u52A0\u5BC6\u65B9\u6CD5</span>
        <span class="token keyword">return</span> <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u53C2\u6570\u662Fbytes\u578B</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CommuityConstant</span> <span class="token punctuation">{</span>
    <span class="token comment">/*      \u4EE5\u4E0B\u7528\u4E8E\u6CE8\u518C\u529F\u80FD      */</span>
    <span class="token operator">/</span> \u6FC0\u6D3B\u6210\u529F<span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">int</span> <span class="token constant">ACTIVATION_SUCCESS</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">/</span> \u91CD\u590D\u6FC0\u6D3B <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">int</span> <span class="token constant">ACTIVATION_REPEAT</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">/</span> \u6FC0\u6D3B\u5931\u8D25 <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">int</span> <span class="token constant">ACTIVATION_FAILURE</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    
    <span class="token comment">/*      \u4EE5\u4E0B\u7528\u4E8E\u767B\u5F55\u529F\u80FD*      /
    /  
     * \u9ED8\u8BA4\u72B6\u6001\u7684\u767B\u5F55\u51ED\u8BC1\u7684\u8D85\u65F6\u65F6\u95F4
     */</span>
    <span class="token keyword">int</span> <span class="token constant">DEFAULT_EXPIRED_SECONDS</span><span class="token operator">=</span><span class="token number">3600</span><span class="token operator">*</span><span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u8BB0\u4F4F\u72B6\u6001\u7684\u767B\u5F55\u51ED\u8BC1\u8D85\u65F6\u65F6\u95F4
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">int</span> <span class="token constant">REMEMBER_EXPIRED_SECONDS</span><span class="token operator">=</span><span class="token number">3600</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">7</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199service\u4E1A\u52A1\u5C42-\u5B9E\u73B0commuityconstant\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199service\u4E1A\u52A1\u5C42-\u5B9E\u73B0commuityconstant\u63A5\u53E3" aria-hidden="true">#</a> 3.\u7F16\u5199Service\u4E1A\u52A1\u5C42(\u5B9E\u73B0CommuityConstant\u63A5\u53E3)</h3><h4 id="_3-1\u6CE8\u518C\u4E1A\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-1\u6CE8\u518C\u4E1A\u52A1" aria-hidden="true">#</a> 3.1\u6CE8\u518C\u4E1A\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//..\u6CE8\u5165userMapper\uFF0CmailClient\uFF0CtemplateEngine</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${community.path.domain}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${server.servlet.context-path}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>
<span class="token comment">//\u6CE8\u518C\u529F\u80FD</span>
<span class="token operator">/</span>\u4E3A\u4EC0\u4E48\u8FD4\u56DE\u7684\u662F<span class="token class-name">Map</span>\u7C7B\u578B\uFF0C\u56E0\u4E3A\u7528<span class="token class-name">Map</span>\u6765\u5B58\u5404\u79CD\u60C5\u51B5\u4E0B\u7684\u4FE1\u606F\uFF0C\u8FD4\u56DE\u7ED9\u524D\u7AEF\u9875\u9762<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        \u5224\u8F93\u5165
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u8D26\u6237\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
        \u5224\u5B58\u5728
     */</span>
    <span class="token class-name">User</span> u <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u8BE5\u8D26\u53F7\u5DF2\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    u <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u8BE5\u90AE\u7BB1\u5DF2\u88AB\u6CE8\u518C\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
        \u6CE8\u518C\u8D26\u6237
        1.\u8BBE\u7F6Esalt\u52A0\u5BC6(\u968F\u673A5\u4F4D\u6570\u52A0\u5165\u5BC6\u7801)
        2.\u8BBE\u7F6E\u5BC6\u7801+salt
        3.\u8BBE\u7F6E\u968F\u673A\u6570\u6FC0\u6D3B\u7801
        4.\u8BBE\u7F6Estatus,type=0,\u65F6\u95F4
        5.\u8BBE\u7F6E\u5934\u50CF(\u52A8\u6001)
          user.setHeaderUrl(String.format(&quot;http://images.nowcoder.com/head/%dt.png&quot;,new Random().nextInt(1000))
     */</span>
    user<span class="token punctuation">.</span><span class="token function">setSalt</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setActivationCode</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setHeaderUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
        \u6FC0\u6D3B\u90AE\u4EF6
        1.\u521B\u5EFAContext\u5BF9\u8C61--&gt;context.setVariable(name,value)\u5C06name\u4F20\u5165\u524D\u7AEF
          \u4E3Athymeleaf\u63D0\u4F9B\u53D8\u91CF
        2.\u8BBE\u7F6Eemail\u548Curl
        3.templateEngine.process\u6267\u884C\u76F8\u5E94HTML
        4.\u53D1\u9001\u90AE\u4EF6
     */</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//http://localhost:8080/community/activation/101/code\u6FC0\u6D3B\u94FE\u63A5</span>
    <span class="token class-name">String</span> url<span class="token operator">=</span>domain<span class="token operator">+</span>contextPath<span class="token operator">+</span><span class="token string">&quot;/activation/&quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getActivationCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span><span class="token function">setVariable</span><span class="token punctuation">(</span><span class="token string">&quot;url&quot;</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> content <span class="token operator">=</span> templateEngine<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token string">&quot;/mail/activation&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mailClient<span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;\u6FC0\u6D3B\u8D26\u53F7&quot;</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2\u6FC0\u6D3B\u90AE\u4EF6\u4E1A\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-2\u6FC0\u6D3B\u90AE\u4EF6\u4E1A\u52A1" aria-hidden="true">#</a> 3.2\u6FC0\u6D3B\u90AE\u4EF6\u4E1A\u52A1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>\u6FC0\u6D3B\u90AE\u4EF6\u529F\u80FD<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">activation</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token constant">ACTIVATION_REPEAT</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getActivationCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          userMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token constant">ACTIVATION_SUCCESS</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token constant">ACTIVATION_FAILURE</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199controller\u5C42" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199controller\u5C42" aria-hidden="true">#</a> 4.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//\u6CE8\u518CController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u6CE8\u518C\u6210\u529F,\u6211\u4EEC\u5DF2\u7ECF\u5411\u60A8\u7684\u90AE\u4EF6\u53D1\u9001\u4E86\u4E00\u5C01\u6FC0\u6D3B\u90AE\u4EF6,\u8BF7\u5C3D\u5FEB\u6FC0\u6D3B\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/operate-result&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/register&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>\u6FC0\u6D3B\u90AE\u4EF6<span class="token class-name">Controller</span><span class="token operator">/</span>
<span class="token comment">//http://localhost:8080/community/activation/101/code\u6FC0\u6D3B\u94FE\u63A5</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/activation/{userId}/{code}&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">activation</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">activation</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">ACTIVATION_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u6FC0\u6D3B\u6210\u529F,\u4F60\u7684\u8D26\u53F7\u5DF2\u7ECF\u53EF\u4EE5\u6B63\u5E38\u4F7F\u7528\u4E86\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">ACTIVATION_REPEAT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u65E0\u6548\u64CD\u4F5C,\u8BE5\u8D26\u53F7\u5DF2\u7ECF\u6FC0\u6D3B\u8FC7\u4E86\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u6FC0\u6D3B\u5931\u8D25,\u4F60\u63D0\u4F9B\u7684\u6FC0\u6D3B\u7801\u4E0D\u6B63\u786E\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;/site/operate-result&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199\u524D\u7AEFthymeleaf\u9875\u9762\u6838\u5FC3\u70B9" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199\u524D\u7AEFthymeleaf\u9875\u9762\u6838\u5FC3\u70B9" aria-hidden="true">#</a> 5.\u7F16\u5199\u524D\u7AEFThymeleaf\u9875\u9762\u6838\u5FC3\u70B9</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>/\u6CE8\u518C\u9875\u9762 */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mt-5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/register}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${usernameMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${user!=null?user.username:&#39;&#39;}<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u60A8\u7684\u8D26\u53F7!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>invalid-feedback<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${usernameMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      \u8BE5\u8D26\u53F7\u5DF2\u5B58\u5728!    <span class="token comment">&lt;!--\u8BE5div\u7684\u663E\u793A\u4E0Eis-invalid\u6709\u5173--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-info text-white form-control<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7ACB\u5373\u6CE8\u518C<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

/\u8D26\u53F7\u6FC0\u6D3B\u4E2D\u95F4\u9875* */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jumbotron<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>lead<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${msg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6FC0\u6D3B\u72B6\u6001\u4FE1\u606F<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
    \u7CFB\u7EDF\u4F1A\u5728 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>seconds<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-danger<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span> \u79D2\u540E\u81EA\u52A8\u8DF3\u8F6C,
    \u60A8\u4E5F\u53EF\u4EE5\u70B9\u6B64 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>target<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{\${target}}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u94FE\u63A5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>, \u624B\u52A8\u8DF3\u8F6C!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--\u81EA\u52A8\u8DF3\u8F6CJs --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">var</span> seconds <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#seconds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token operator">--</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>seconds <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#target&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

/\u90AE\u7BB1\u6A21\u677F\u9875* */
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${email}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>xxx@xxx.com<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>, \u60A8\u597D!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
    \u60A8\u6B63\u5728\u6CE8\u518Cxxx, \u8FD9\u662F\u4E00\u5C01\u6FC0\u6D3B\u90AE\u4EF6, \u8BF7\u70B9\u51FB 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6B64\u94FE\u63A5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>,
    \u6FC0\u6D3B\u60A8\u7684xxx\u8D26\u53F7!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u751F\u6210\u9A8C\u8BC1\u7801" tabindex="-1"><a class="header-anchor" href="#\u751F\u6210\u9A8C\u8BC1\u7801" aria-hidden="true">#</a> \u751F\u6210\u9A8C\u8BC1\u7801</h2>`,46),b=s("\u53C2\u8003\u7F51\u7AD9 \uFF1A"),g={href:"http://code.google.com/archive/p/kaptcha/",title:"http://code.google.com/archive/p/kaptcha/",target:"_blank",rel:"noopener noreferrer"},y=s("http://code.google.com/archive/p/kaptcha/"),q=p(`<p>\u6CE8\u610F\uFF1A</p><ol><li><p>Producer\u662FKaptcha\u7684\u6838\u5FC3\u63A5\u53E3</p></li><li><p>DefaultKaptcha\u662FKaptcha\u6838\u5FC3\u63A5\u53E3\u7684\u9ED8\u8BA4\u5B9E\u73B0\u7C7B</p></li><li><p>Spring Boot\u6CA1\u6709\u4E3AKaptcha\u63D0\u4F9B\u81EA\u52A8\u914D\u7F6E</p></li></ol><h3 id="_1-\u5F15\u5165pom-xml" tabindex="-1"><a class="header-anchor" href="#_1-\u5F15\u5165pom-xml" aria-hidden="true">#</a> 1.\u5F15\u5165pom.xml</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.penggle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kaptcha<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u521B\u5EFA\u914D\u7F6E\u7C7B\u88C5\u914D\u7B2C\u4E09\u65B9bean" tabindex="-1"><a class="header-anchor" href="#_2-\u521B\u5EFA\u914D\u7F6E\u7C7B\u88C5\u914D\u7B2C\u4E09\u65B9bean" aria-hidden="true">#</a> 2.\u521B\u5EFA\u914D\u7F6E\u7C7B\u88C5\u914D\u7B2C\u4E09\u65B9bean</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KaptchaConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Producer</span> <span class="token class-name">KaptchaProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">/</span>         
         <span class="token operator">*</span> \u624B\u52A8\u521B\u5EFAproperties<span class="token punctuation">.</span>xml\u914D\u7F6E\u6587\u4EF6\u5BF9\u8C61<span class="token operator">*</span>         
         <span class="token operator">*</span> \u8BBE\u7F6E\u9A8C\u8BC1\u7801\u56FE\u7247\u7684\u6837\u5F0F\uFF0C\u5927\u5C0F\uFF0C\u9AD8\u5EA6\uFF0C\u8FB9\u6846\uFF0C\u5B57\u4F53\u7B49
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">Properties</span> properties<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.border&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;yes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.border.color&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;105,179,90&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.textproducer.font.color&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;black&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.image.width&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;110&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.image.height&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;40&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.textproducer.font.size&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;32&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.textproducer.char.string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.textproducer.char.length&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha.textproducer.font.names&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u5B8B\u4F53,\u6977\u4F53,\u5FAE\u8F6F\u96C5\u9ED1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DefaultKaptcha</span> <span class="token class-name">Kaptcha</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DefaultKaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Config</span> config<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Kaptcha</span><span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Kaptcha</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u63A5\u53E3" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u63A5\u53E3</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/kaptcha&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getKaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//\u751F\u6210\u9A8C\u8BC1\u7801</span>
    <span class="token class-name">String</span> text <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5C06\u9A8C\u8BC1\u7801\u5B58\u5165session</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha&quot;</span><span class="token punctuation">,</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//\u5C06\u56FE\u7247\u8F93\u51FA\u7ED9\u6D4F\u89C8\u5668</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;image/png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServletOutputStream</span> os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token string">&quot;png&quot;</span><span class="token punctuation">,</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u54CD\u5E94\u9A8C\u8BC1\u7801\u5931\u8D25:&quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-thymeleaf\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9" tabindex="-1"><a class="header-anchor" href="#_4-thymeleaf\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9" aria-hidden="true">#</a> 4.Thymeleaf\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/kaptcha}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>kaptchaImage<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>100px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>40px<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mr-2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:refresh_kaptcha();<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>font-size-12 align-bottom<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5237\u65B0\u9A8C\u8BC1\u7801<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--\u5BF9\u5E94\u7684Js--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">refresh_kaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/kaptcha?p=&quot;</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#kaptchaImage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--\u5168\u5C40Js\u914D\u7F6E\u6587\u4EF6--&gt;</span>
var CONTEXT_PATH=&quot;/community&quot;;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u767B\u5F55\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u767B\u5F55\u529F\u80FD" aria-hidden="true">#</a> \u767B\u5F55\u529F\u80FD</h2><p>\u9A8C\u8BC1\u8D26\u53F7,\u5BC6\u7801,\u9A8C\u8BC1\u7801\uFF08\u6210\u529F\uFF1A\u751F\u6210\u767B\u5F55\u51ED\u8BC1ticket\uFF0C\u53D1\u653E\u7ED9\u5BA2\u6237\u7AEF \u5931\u8D25\uFF1A\u8DF3\u8F6C\u56DE\u767B\u5F55\u9875 \uFF09</p><h3 id="_1-\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u5B9E\u4F53\u7C7B-\u767B\u5F55\u51ED\u8BC1\u76F8\u5F53\u4E8Esession\u7684\u4F5C\u7528" tabindex="-1"><a class="header-anchor" href="#_1-\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u5B9E\u4F53\u7C7B-\u767B\u5F55\u51ED\u8BC1\u76F8\u5F53\u4E8Esession\u7684\u4F5C\u7528" aria-hidden="true">#</a> 1.\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u5B9E\u4F53\u7C7B\uFF08\u767B\u5F55\u51ED\u8BC1\u76F8\u5F53\u4E8ESession\u7684\u4F5C\u7528\uFF09</h3><p>\u6CE8\u610F :\u4E3A\u4EC0\u4E48\u8981\u641E\u4E00\u4E2A\u767B\u5F55\u51ED\u8BC1\uFF0C\u56E0\u4E3A\u6700\u597D\u4E0D\u8981\u5C06User\u4FE1\u606F\u5B58\u5165Model\u8FD4\u56DE\u7ED9\u524D\u7AEF\uFF0C\u654F\u611F\u4FE1\u606F\u5C3D\u91CF\u4E0D\u8981\u8FD4\u56DE\u7ED9\u6D4F\u89C8\u5668\uFF0C\u4E0D\u5B89\u5168\uFF0C\u800C\u662F\u9009\u62E9ticket\u51ED\u8BC1\uFF0C\u901A\u8FC7ticket\u53EF\u4EE5\u5728\u670D\u52A1\u5668\u7AEF\u5F97\u5230User</p><h3 id="_2-\u7F16\u5199dao\u5C42\u63A5\u53E3-\u6CE8\u89E3\u65B9\u5F0F\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199dao\u5C42\u63A5\u53E3-\u6CE8\u89E3\u65B9\u5F0F\u5B9E\u73B0" aria-hidden="true">#</a> 2.\u7F16\u5199Dao\u5C42\u63A5\u53E3(\u6CE8\u89E3\u65B9\u5F0F\u5B9E\u73B0)</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token string">&quot;insert into login_ticket(user_id,ticket,status,expired) &quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;values (#{userId},#{ticket},#{status},#{expired})&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@Options</span><span class="token punctuation">(</span>useGeneratedKeys <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>keyProperty <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">//\u767B\u5F55\u529F\u80FD\u9700\u8981\u6DFB\u52A0\u767B\u5F55\u51ED\u8BC1ticket</span>
  <span class="token keyword">int</span> <span class="token function">insertLoginTicket</span><span class="token punctuation">(</span><span class="token class-name">LoginTicket</span> loginTicket<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token string">&quot;select id,user_id,ticket,status,expired &quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;from login_ticket &quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;where ticket=#{ticket}&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//\u68C0\u67E5\u767B\u5F55\u72B6\u6001</span>
  <span class="token class-name">LoginTicket</span> <span class="token function">selectByTicket</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token operator">/</span>
   <span class="token operator">*</span>  \u4E00\u5B9A\u8981\u52A0<span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\u4E0D\u7136\u4F1A\u62A5\u9519
   <span class="token operator">*</span>  \u9000\u51FA\u529F\u80FD\u9700\u8981\u4FEE\u6539status\u72B6\u6001
   <span class="token operator">*</span>  <span class="token annotation punctuation">@return</span> error<span class="token operator">:</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>MysqlDataTruncation</span><span class="token operator">:</span><span class="token class-name">Data</span> truncation<span class="token operator">:</span><span class="token class-name">Truncated</span> incorrect <span class="token constant">DOUBLE</span> value<span class="token operator">:</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token string">&quot;update login_ticket set status=#{status} where ticket=#{ticket} &quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">int</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ticket<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199service\u5C42\u767B\u5F55\u4E1A\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199service\u5C42\u767B\u5F55\u4E1A\u52A1" aria-hidden="true">#</a> 3.\u7F16\u5199Service\u5C42\u767B\u5F55\u4E1A\u52A1</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u767B\u5F55\u529F\u80FD<span class="token operator">/</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">String</span> password<span class="token punctuation">,</span><span class="token keyword">int</span> expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u7A7A\u503C\u5904\u7406</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u53F7\u7801\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u9A8C\u8BC1\u8D26\u53F7</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u8BE5\u8D26\u53F7\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u9A8C\u8BC1\u6FC0\u6D3B\u72B6\u6001</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u8BE5\u8D26\u53F7\u672A\u6FC0\u6D3B\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u9A8C\u8BC1\u5BC6\u7801(\u5148\u52A0\u5BC6\u518D\u5BF9\u6BD4)</span>
      password<span class="token operator">=</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password<span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u5BC6\u7801\u8F93\u5165\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u751F\u6210\u767B\u5F55\u51ED\u8BC1(\u76F8\u5F53\u4E8E\u8BB0\u4F4F\u6211\u8FD9\u4E2A\u529F\u80FD==session)</span>
      <span class="token class-name">LoginTicket</span> ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ticket<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ticket<span class="token punctuation">.</span><span class="token function">setTicket</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ticket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u5F53\u524D\u65F6\u95F4\u7684\u6BEB\u79D2\u6570+\u8FC7\u671F\u65F6\u95F4\u6BEB\u79D2\u6570</span>
      ticket<span class="token punctuation">.</span><span class="token function">setExpired</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expiredSeconds <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      loginTicketMapper<span class="token punctuation">.</span><span class="token function">insertLoginTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>

      map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">,</span>ticket<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199controller\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199controller\u5C42-1" aria-hidden="true">#</a> 4.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>   <span class="token operator">/</span>
    <span class="token operator">*</span> \u767B\u5F55\u529F\u80FD
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> username
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> password
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> code \u7528\u4E8E\u6821\u9A8C\u9A8C\u8BC1\u7801
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> rememberme  \u8BB0\u4F4F\u6211\uFF08\u767B\u5F55\u51ED\u8BC1\uFF09
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> model \u7528\u4E8E\u5C06\u6570\u636E\u4F20\u9012\u7ED9\u524D\u7AEF\u9875\u9762
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> session \u7528\u4E8E\u83B7\u53D6kaptcha\u9A8C\u8BC1\u7801
    <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> response \u7528\u4E8E\u6D4F\u89C8\u5668\u63A5\u53D7cookie
    <span class="token operator">*</span> <span class="token annotation punctuation">@return</span>
    <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token operator">/</span>\u6CE8\u610Fusername<span class="token punctuation">,</span>password\u8FD9\u4E9B\u6CA1\u6709\u5C01\u88C5\u8FDBmodel<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token keyword">boolean</span> rememberme<span class="token punctuation">,</span>
                        <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//\u9996\u5148\u68C0\u9A8C\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> kaptcha <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>kaptcha<span class="token punctuation">)</span><span class="token operator">||</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token operator">||</span><span class="token operator">!</span>kaptcha<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;codeMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u9A8C\u8BC1\u7801\u4E0D\u6B63\u786E\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> <span class="token number">1.</span>\u9A8C\u8BC1\u7528\u6237\u540D\u548C\u5BC6\u7801<span class="token punctuation">(</span>\u91CD\u70B9<span class="token punctuation">)</span>
         <span class="token operator">*</span> <span class="token number">2.</span>\u4F20\u5165\u6D4F\u89C8\u5668cookie<span class="token operator">=</span>ticket
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">int</span> expiredSeconds<span class="token operator">=</span>rememberme<span class="token operator">?</span><span class="token constant">REMEMBER_EXPIRED_SECONDS</span><span class="token operator">:</span><span class="token constant">DEFAULT_EXPIRED_SECONDS</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:/index&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199\u524D\u7AEFthymeleaf\u9875\u9762\u6838\u5FC3\u70B9-1" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199\u524D\u7AEFthymeleaf\u9875\u9762\u6838\u5FC3\u70B9-1" aria-hidden="true">#</a> 5.\u7F16\u5199\u524D\u7AEFThymeleaf\u9875\u9762\u6838\u5FC3\u70B9</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${usernameMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name">&lt;!--\u6CE8\u610Fparam,\u56E0\u4E3Ausername,password\u8FD9\u4E9B\u6CA1\u6709\u5C01\u88C5\u8FDBmodel--</span><span class="token punctuation">&gt;</span></span>
       th:value=&quot;\${param.username}&quot;
       id=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;\u8BF7\u8F93\u5165\u60A8\u7684\u8D26\u53F7!&quot; required&gt;
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>invalid-feedback<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${usernameMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    \u8BE5\u8D26\u53F7\u4E0D\u5B58\u5728!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remember-me<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rememberme<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">th:</span>checked</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.rememberme}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form-check-label<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remember-me<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8BB0\u4F4F\u6211<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>forget.html<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-danger float-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5FD8\u8BB0\u5BC6\u7801?<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u9000\u51FA\u767B\u5F55\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u9000\u51FA\u767B\u5F55\u529F\u80FD" aria-hidden="true">#</a> \u9000\u51FA\u767B\u5F55\u529F\u80FD</h2><p>\u5C06\u767B\u5F55\u51ED\u8BC1loginTicket\u4E2D\u7684status\u7F6E\u4E3A\u65E0\u6548</p><h3 id="_1-\u7F16\u5199service\u5C42" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199service\u5C42" aria-hidden="true">#</a> 1.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span><span class="token punctuation">{</span>
    loginTicketMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//\u6765\u6E90\u4E8ELoginTicket\u7684Dao\u5C42</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199controller\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199controller\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>
   <span class="token operator">*</span> \u9000\u51FA\u767B\u5F55\u529F\u80FD
   <span class="token operator">*</span> <span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\u6CE8\u89E3<span class="token operator">:</span>\u5C06\u6D4F\u89C8\u5668\u4E2D\u7684<span class="token class-name">Cookie</span>\u503C\u4F20\u7ED9\u53C2\u6570 
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ticket<span class="token punctuation">)</span><span class="token punctuation">{</span>
      userService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login&quot;</span><span class="token punctuation">;</span><span class="token comment">//\u91CD\u5B9A\u5411</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u663E\u793A\u767B\u5F55\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#\u663E\u793A\u767B\u5F55\u4FE1\u606F" aria-hidden="true">#</a> \u663E\u793A\u767B\u5F55\u4FE1\u606F</h2><p>\u6D89\u53CA\u5230 \uFF1A\u62E6\u622A\u5668\uFF0C\u591A\u7EBF\u7A0B</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/1_Q3VZ7GYwuG.PNG" alt="\u663E\u793A\u767B\u5F55\u4FE1\u606F\u539F\u7406"></p><h3 id="\u62E6\u622A\u5668demo\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#\u62E6\u622A\u5668demo\u793A\u4F8B" aria-hidden="true">#</a> \u62E6\u622A\u5668Demo\u793A\u4F8B</h3><p>\u6CE8\u610F\uFF1A</p><ul><li><p>\u62E6\u622A\u5668\u9700\u5B9E\u73B0HandlerInterceptor\u63A5\u53E3\u800C\u914D\u7F6E\u7C7B\u9700\u5B9E\u73B0WebMvcConfigurer\u63A5\u53E3\u3002</p></li><li><p>preHandle\u65B9\u6CD5\u5728Controller\u4E4B\u524D\u6267\u884C\uFF0C\u82E5\u8FD4\u56DEfalse\uFF0C\u5219\u7EC8\u6B62\u6267\u884C\u540E\u7EED\u7684\u8BF7\u6C42\u3002</p></li><li><p>postHandle\u65B9\u6CD5\u5728Controller\u4E4B\u540E\u3001\u6A21\u677F\u9875\u9762\u4E4B\u524D\u6267\u884C\u3002</p></li><li><p>afterCompletion\u65B9\u6CD5\u5728\u6A21\u677F\u4E4B\u540E\u6267\u884C\u3002</p></li><li><p>\u901A\u8FC7addInterceptors\u65B9\u6CD5\u5BF9\u62E6\u622A\u5668\u8FDB\u884C\u914D\u7F6E</p></li></ul><p>1.\u521B\u5EFA\u62E6\u622A\u5668\u7C7B\uFF0C\u5B9E\u73B0HandlerInterceptor\u63A5\u53E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;preHandle:\u5728Controller\u4E4B\u524D\u6267\u884C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterCompletion:\u5728\u6A21\u677F\u4E4B\u540E\u6267\u884C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;postHandle:\u5728Controller\u4E4B\u540E\uFF0C\u524D\u7AEF\u6A21\u677F\u5F15\u64CE\u9875\u9762\u6E32\u67D3\u4E4B\u524D\u6267\u884C&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2.\u521B\u5EFA\u62E6\u622A\u5668\u914D\u7F6E\u7C7B\uFF0C\u5B9E\u73B0WebMvcConfigurer\u63A5\u53E3</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DemoInterceptor</span> demoInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>demoInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/ / *.css&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.js&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;// *.png&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.jpg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/ / *.jpeg&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-\u9996\u5148\u521B\u5EFA\u4E24\u4E2A\u5DE5\u5177\u7C7B\u964D\u4F4E\u8026\u5408" tabindex="-1"><a class="header-anchor" href="#_1-\u9996\u5148\u521B\u5EFA\u4E24\u4E2A\u5DE5\u5177\u7C7B\u964D\u4F4E\u8026\u5408" aria-hidden="true">#</a> 1.\u9996\u5148\u521B\u5EFA\u4E24\u4E2A\u5DE5\u5177\u7C7B\u964D\u4F4E\u8026\u5408</h3><p>\uFF08Request\u83B7\u53D6Cookie\u5DE5\u5177\u7C7B\uFF0C\u83B7\u53D6\u51ED\u8BC1ticket\u591A\u7EBF\u7A0B\u5DE5\u5177\u7C7B\uFF09 \u6CE8\u610F:</p><ol><li>ThreadLocal\u91C7\u7528\u7EBF\u7A0B\u9694\u79BB\u7684\u65B9\u5F0F\u5B58\u653E\u6570\u636E\uFF0C\u53EF\u4EE5\u907F\u514D\u591A\u7EBF\u7A0B\u4E4B\u95F4\u51FA\u73B0\u6570\u636E\u8BBF\u95EE\u51B2\u7A81\u3002</li><li>ThreadLocal\u63D0\u4F9Bset\u65B9\u6CD5\uFF0C\u80FD\u591F\u4EE5\u5F53\u524D\u7EBF\u7A0B\u4E3Akey\u5B58\u653E\u6570\u636E\u3002get\u65B9\u6CD5\uFF0C\u80FD\u591F\u4EE5\u5F53\u524D\u7EBF\u7A0B\u4E3Akey\u83B7\u53D6\u6570\u636E\u3002</li><li>ThreadLocal\u63D0\u4F9Bremove\u65B9\u6CD5\uFF0C\u80FD\u591F\u4EE5\u5F53\u524D\u7EBF\u7A0B\u4E3Akey\u5220\u9664\u6570\u636E\u3002</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">||</span>name<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span> cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>  <span class="token comment">//\u653E\u5165\u5BB9\u5668\u91CC\u4E0D\u7528\u8BBE\u4E3A\u9759\u6001\u65B9\u6CD5</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HostHolder</span> <span class="token punctuation">{</span>
<span class="token comment">//key\u5C31\u662F\u7EBF\u7A0B\u5BF9\u8C61\uFF0C\u503C\u4E3A\u7EBF\u7A0B\u7684\u53D8\u91CF\u526F\u672C</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>\u4EE5\u7EBF\u7A0B\u4E3Akey\u5B58\u5165<span class="token class-name">User</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        users<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>\u4ECE<span class="token class-name">ThreadLocal</span>\u7EBF\u7A0B\u4E2D\u53D6\u51FA<span class="token class-name">User</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> users<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>\u91CA\u653E\u7EBF\u7A0B<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        users<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>\u901A\u8FC7<span class="token class-name">Cookie</span><span class="token operator">=</span>ticket\u83B7\u53D6\u767B\u5F55\u7528\u6237<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token class-name">LoginTicket</span> <span class="token function">getLoginTicket</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> loginTicketMapper<span class="token punctuation">.</span><span class="token function">selectByTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668\u7C7B-\u7B49\u540C\u4E8Econtroller\u7C7B" tabindex="-1"><a class="header-anchor" href="#_3-\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668\u7C7B-\u7B49\u540C\u4E8Econtroller\u7C7B" aria-hidden="true">#</a> 3.\u521B\u5EFA\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668\u7C7B\uFF08\u7B49\u540C\u4E8EController\u7C7B\uFF09</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginTicketInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token operator">/</span>\u5728<span class="token class-name">Controller</span>\u8BBF\u95EE\u6240\u6709\u8DEF\u5F84\u4E4B\u524D\u83B7\u53D6\u51ED\u8BC1<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span>\u4ECE\u6D4F\u89C8\u5668<span class="token class-name">Cookie</span>\u4E2D\u83B7\u53D6\u51ED\u8BC1<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">String</span> ticket<span class="token operator">=</span><span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//\u67E5\u8BE2\u51ED\u8BC1</span>
            <span class="token class-name">LoginTicket</span> loginTicket <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getLoginTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//\u68C0\u67E5\u51ED\u8BC1\u662F\u5426\u6709\u6548(after\uFF1A\u5F53\u524D\u65F6\u95F4\u4E4B\u540E)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket<span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>loginTicket<span class="token punctuation">.</span><span class="token function">getExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//\u6839\u636E\u51ED\u8BC1\u67E5\u8BE2\u7528\u6237</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">/</span>\u5728\u672C\u6B21\u8BF7\u6C42\u4E2D\u6301\u6709\u7528\u6237
                 <span class="token operator">*</span> \u7C7B\u4F3C\u4E8E\u5B58\u5165<span class="token class-name">Map</span><span class="token punctuation">,</span>\u53EA\u662F\u8003\u8651\u5230\u591A\u7EBF\u7A0B
                 <span class="token operator">*</span><span class="token operator">/</span>
                hostHolder<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token operator">/</span>\u6A21\u677F\u4E4B\u524D\u5904\u7406\u6570\u636E<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token operator">!=</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> modelAndView <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u91CA\u653E\u7EBF\u7A0B\u8D44\u6E90</span>
        hostHolder<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u62E6\u622A\u5668\u914D\u7F6E\u7C7B" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u62E6\u622A\u5668\u914D\u7F6E\u7C7B" aria-hidden="true">#</a> 4.\u7F16\u5199\u62E6\u622A\u5668\u914D\u7F6E\u7C7B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginTicketInterceptor</span> loginTicketInterceptor<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginTicketInterceptor<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/* */*.css&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;// *.js&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.png&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/ / *.jpg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9\u4FEE\u6539" tabindex="-1"><a class="header-anchor" href="#_5-\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9\u4FEE\u6539" aria-hidden="true">#</a> 5.\u524D\u7AEF\u9875\u9762\u6838\u5FC3\u70B9\u4FEE\u6539</h3><p>th:if=&quot;\${loginUser!=null}&quot; \u5B58\u5728\u51ED\u8BC1\u663E\u793A&lt;li&gt;,\u4E0D\u5B58\u5728\u5219\u4E0D\u663E\u793A</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-item ml-3 btn-group-vertical<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${loginUser!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-link position-relative<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>site/letter.html<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6D88\u606F<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>badge badge-danger<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u62E6\u622A\u672A\u767B\u5F55\u9875\u9762\u7684\u8DEF\u5F84\u8BBF\u95EE" tabindex="-1"><a class="header-anchor" href="#\u62E6\u622A\u672A\u767B\u5F55\u9875\u9762\u7684\u8DEF\u5F84\u8BBF\u95EE" aria-hidden="true">#</a> \u62E6\u622A\u672A\u767B\u5F55\u9875\u9762\u7684\u8DEF\u5F84\u8BBF\u95EE</h2><p>\u5E38\u7528\u7684\u5143\u6CE8\u89E3\uFF1A</p><ul><li>@Target\uFF1A\u6CE8\u89E3\u4F5C\u7528\u76EE\u6807\uFF08\u65B9\u6CD5or\u7C7B\uFF09</li><li>@Retention\uFF1A\u6CE8\u89E3\u4F5C\u7528\u65F6\u95F4\uFF08\u8FD0\u884C\u65F6or\u7F16\u8BD1\u65F6\uFF09</li><li>@Document\uFF1A\u6CE8\u89E3\u662F\u5426\u53EF\u4EE5\u751F\u6210\u5230\u6587\u6863\u91CC</li><li>@Inherited\uFF1A\u6CE8\u89E3\u7EE7\u627F\u8BE5\u7C7B\u7684\u5B50\u7C7B\u5C06\u81EA\u52A8\u4F7F\u7528@Inherited\u4FEE\u9970</li></ul><p>\u6CE8\u610F\uFF1A \u82E5\u67092\u4E2A\u62E6\u622A\u5668\uFF0C\u62E6\u622A\u5668\u6267\u884C\u987A\u5E8F\u4E3A\u6CE8\u518C\u5728WebMvcConfig\u914D\u7F6E\u7C7B\u4E2D\u7684\u987A\u5E8F</p><h3 id="_1-\u81EA\u5B9A\u4E49\u62E6\u622A\u5668\u6CE8\u89E3" tabindex="-1"><a class="header-anchor" href="#_1-\u81EA\u5B9A\u4E49\u62E6\u622A\u5668\u6CE8\u89E3" aria-hidden="true">#</a> 1.\u81EA\u5B9A\u4E49\u62E6\u622A\u5668\u6CE8\u89E3</h3><p>\u81EA\u5B9A\u4E49\u62E6\u622A\u65B9\u6CD5\u7C7B\u6CE8\u89E3(annotation\u5305)\u5E76\u52A0\u5728\u9700\u8981\u62E6\u622A\u7684\u65B9\u6CD5\u4E0A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token operator">/</span>
 <span class="token operator">*</span> \u6807\u8BB0\u672A\u767B\u5F55\u65F6\u8981\u62E6\u622A\u7684\u8DEF\u5F84\u8BBF\u95EE\u65B9\u6CD5
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoginRequired</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token operator">/</span>\u52A0\u5728\u9700\u8981\u62E6\u622A\u7684\u65B9\u6CD5<span class="token operator">/</span>
<span class="token annotation punctuation">@LoginRequired</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199\u62E6\u622A\u5668\u7C7B\u5B9E\u73B0handlerinterceptor\u7236\u7C7B" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199\u62E6\u622A\u5668\u7C7B\u5B9E\u73B0handlerinterceptor\u7236\u7C7B" aria-hidden="true">#</a> 2.\u7F16\u5199\u62E6\u622A\u5668\u7C7B\u5B9E\u73B0HandlerInterceptor\u7236\u7C7B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token comment">//\u6CE8\u5165hostHolder\u5DE5\u5177\u7C7B\u83B7\u53D6\u5F53\u524D\u72B6\u6001\u767B\u5F55\u7528\u6237</span>
  <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
  
  <span class="token annotation punctuation">@Override</span>
  <span class="token operator">/</span>\u5728\u8BF7\u6C42\u8DEF\u5F84\u524D\u6267\u884C\u8BE5\u65B9\u6CD5<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">//\u5224\u65AD\u62E6\u622A\u7684\u76EE\u6807\u662F\u4E0D\u662F\u4E00\u4E2A\u65B9\u6CD5</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//\u5982\u679C\u662F\u4E00\u4E2A\u65B9\u6CD5\uFF0C\u5C06handler\u8F6C\u5316\u6211HandlerMethod\u7C7B\u578B</span>
          <span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
          <span class="token class-name">Method</span> method <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//\u83B7\u53D6\u65B9\u6CD5\u4E0A\u7684\u81EA\u5B9A\u4E49\u6CE8\u89E3</span>
          <span class="token class-name">LoginRequired</span> loginRequired <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token operator">/</span>
          <span class="token operator">*</span> \u5982\u679C\u6CA1\u6709\u767B\u5F55\u5E76\u4E14\u6709\u81EA\u5B9A\u4E49\u6CE8\u89E3\uFF08\u9700\u8981\u767B\u5F55\u624D\u80FD\u8BBF\u95EE\u7684\u65B9\u6CD5\u6CE8\u89E3\uFF09
          <span class="token operator">*</span> \u901A\u8FC7response\u6765\u91CD\u5B9A\u5411\uFF0C\u8FD9\u91CC\u4E0D\u53EF\u4EE5\u901A\u8FC7<span class="token keyword">return</span> \u91CD\u5B9A\u5411
          <span class="token operator">*</span><span class="token operator">/</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>loginRequired<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u6CE8\u518C\u8FDB\u62E6\u622A\u5668\u914D\u7F6E\u7C7Bwebmvcconfig" tabindex="-1"><a class="header-anchor" href="#_3-\u6CE8\u518C\u8FDB\u62E6\u622A\u5668\u914D\u7F6E\u7C7Bwebmvcconfig" aria-hidden="true">#</a> 3.\u6CE8\u518C\u8FDB\u62E6\u622A\u5668\u914D\u7F6E\u7C7BWebMvcConfig</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">LoginRequiredInterceptor</span> loginRequiredInterceptor<span class="token punctuation">;</span>
  
   <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginRequiredInterceptor<span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/* */*.css&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;// *.js&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.png&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/ / *.jpg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/* */*.jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4FEE\u6539\u5BC6\u7801" tabindex="-1"><a class="header-anchor" href="#\u4FEE\u6539\u5BC6\u7801" aria-hidden="true">#</a> \u4FEE\u6539\u5BC6\u7801</h2><h3 id="_1-\u7F16\u5199dao\u5C42" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">int</span> <span class="token function">updatePassword</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span>update id<span class="token operator">=</span><span class="token string">&quot;updatePassword&quot;</span><span class="token operator">&gt;</span>
    update user set password<span class="token operator">=</span>#<span class="token punctuation">{</span>password<span class="token punctuation">}</span> where id<span class="token operator">=</span>#<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>update<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42-1" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u4FEE\u6539\u5BC6\u7801<span class="token operator">/</span>
  <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">updatePassword</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token class-name">String</span> oldPassword<span class="token punctuation">,</span><span class="token class-name">String</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token comment">// \u7A7A\u503C\u5904\u7406</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>oldPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;oldPasswordMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u539F\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>newPassword<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;newPasswordMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u65B0\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  
      <span class="token comment">// \u9A8C\u8BC1\u539F\u59CB\u5BC6\u7801</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      oldPassword <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>oldPassword <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldPassword<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;oldPasswordMsg&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u60A8\u8F93\u5165\u7684\u539F\u5BC6\u7801\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> map<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newPassword <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>newPassword <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      userMapper<span class="token punctuation">.</span><span class="token function">updatePassword</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token keyword">return</span> map<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u5C42" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u4FEE\u6539\u5BC6\u7801 <span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/updatePassword&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">updatePassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> oldPassword<span class="token punctuation">,</span> <span class="token class-name">String</span> newPassword<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">updatePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> oldPassword<span class="token punctuation">,</span> newPassword<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token operator">/</span>\u5982\u679C\u66F4\u6539\u5BC6\u7801\u6210\u529F\uFF0C\u9000\u51FA\u767B\u5F55\uFF0C\u5E76\u8DF3\u5230\u767B\u5F55\u9875\u9762 <span class="token operator">/</span>
          <span class="token keyword">return</span> <span class="token string">&quot;redirect:/logout&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;oldPasswordMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;oldPasswordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;newPasswordMsg&quot;</span><span class="token punctuation">,</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;newPasswordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token string">&quot;/site/setting&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5FD8\u8BB0\u5BC6\u7801" tabindex="-1"><a class="header-anchor" href="#\u5FD8\u8BB0\u5BC6\u7801" aria-hidden="true">#</a> \u5FD8\u8BB0\u5BC6\u7801</h2><h3 id="_1-\u7F16\u5199service\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199service\u5C42-1" aria-hidden="true">#</a> 1.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u5224\u65AD\u90AE\u7BB1\u662F\u5426\u5DF2\u6CE8\u518C</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmailExist</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
     <span class="token operator">/</span>
      <span class="token operator">*</span> \u91CD\u7F6E\u5FD8\u8BB0\u5BC6\u7801
      <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">resetPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u7A7A\u503C\u5904\u7406</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u90AE\u7BB1\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u6839\u636E\u90AE\u7BB1\u67E5\u627E\u7528\u6237</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByEmail</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u8BE5\u90AE\u7BB1\u5C1A\u672A\u6CE8\u518C!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u91CD\u7F6E\u5BC6\u7801</span>
        password <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userMapper<span class="token punctuation">.</span><span class="token function">updatePassword</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6E05\u7406\u7F13\u5B58</span>
        <span class="token function">clearCache</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u6CE8\u610F\u8FD9\u91CC\uFF01</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199controller\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199controller\u5C42-1" aria-hidden="true">#</a> 2.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u5FD8\u8BB0\u5BC6\u7801\u9875\u9762
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/forget&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getForgetPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/forget&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u91CD\u7F6E\u5BC6\u7801
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/forget/password&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resetPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> verifyCode<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>email <span class="token operator">+</span> <span class="token string">&quot;_verifyCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>verifyCode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>verifyCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;codeMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9A8C\u8BC1\u7801\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/forget&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">resetPassword</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;emailMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/forget&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206" aria-hidden="true">#</a> 3.\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/forget/password}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-email<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u90AE\u7BB1:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u60A8\u7684\u90AE\u7BB1!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${emailMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.email}<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${emailMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u60A8\u7684\u90AE\u7BB1!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${emailMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.email}<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>email<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${emailMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  \u8BE5\u90AE\u7BB1\u5DF2\u88AB\u6CE8\u518C!
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifycode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u9A8C\u8BC1\u7801:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifycode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifyCode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801!<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${codeMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.verifyCode}<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifycode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifyCode<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u9A8C\u8BC1\u7801!<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${codeMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.verifyCode}<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${codeMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  \u9A8C\u8BC1\u7801\u4E0D\u6B63\u786E!
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>verifyCodeBtn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u83B7\u53D6\u9A8C\u8BC1\u7801<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u65B0\u5BC6\u7801:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u65B0\u7684\u5BC6\u7801!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${passwordMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.password}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>your-password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u8BF7\u8F93\u5165\u65B0\u7684\u5BC6\u7801!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span>
                     <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|form-control \${passwordMsg!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span>
                     <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${param.password}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>invalid-feedback<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${passwordMsg}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                  \u5BC6\u7801\u957F\u5EA6\u4E0D\u80FD\u5C0F\u4E8E8\u4F4D!
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u91CD\u7F6E\u5BC6\u7801<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u4F18\u5316\u767B\u5F55\u529F\u80FD-\u4F7F\u7528redis" tabindex="-1"><a class="header-anchor" href="#\u4F18\u5316\u767B\u5F55\u529F\u80FD-\u4F7F\u7528redis" aria-hidden="true">#</a> \u4F18\u5316\u767B\u5F55\u529F\u80FD(\u4F7F\u7528Redis)</h1><h2 id="\u4F7F\u7528redis\u5B58\u50A8\u9A8C\u8BC1\u7801" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528redis\u5B58\u50A8\u9A8C\u8BC1\u7801" aria-hidden="true">#</a> \u4F7F\u7528Redis\u5B58\u50A8\u9A8C\u8BC1\u7801</h2><h3 id="_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u9A8C\u8BC1\u7801key\u503C" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u9A8C\u8BC1\u7801key\u503C" aria-hidden="true">#</a> 1.\u7F16\u5199RedisUtil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u9A8C\u8BC1\u7801key\u503C</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisKeyUtil</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u9A8C\u8BC1\u7801</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_KAPTCHA</span> <span class="token operator">=</span> <span class="token string">&quot;kaptcha&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>\u767B\u5F55\u9A8C\u8BC1\u7801<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getKaptchaKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_KAPTCHA</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> owner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u4F18\u5316logincontroller\u9A8C\u8BC1\u7801\u76F8\u5173\u4EE3\u7801-\u4F18\u5316\u524D\u662F\u5B58\u5728session\u4E2D\u7684" tabindex="-1"><a class="header-anchor" href="#_2-\u4F18\u5316logincontroller\u9A8C\u8BC1\u7801\u76F8\u5173\u4EE3\u7801-\u4F18\u5316\u524D\u662F\u5B58\u5728session\u4E2D\u7684" aria-hidden="true">#</a> 2.\u4F18\u5316LoginController\u9A8C\u8BC1\u7801\u76F8\u5173\u4EE3\u7801\uFF08\u4F18\u5316\u524D\u662F\u5B58\u5728session\u4E2D\u7684\uFF09</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u9A8C\u8BC1\u7801\u529F\u80FD <span class="token punctuation">(</span><span class="token class-name">Redis</span>\u4F18\u5316<span class="token punctuation">)</span>
     <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> response
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/kaptcha&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getKaptcha</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u751F\u6210\u9A8C\u8BC1\u7801</span>
        <span class="token class-name">String</span> text <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedImage</span> image <span class="token operator">=</span> kaptchaProducer<span class="token punctuation">.</span><span class="token function">createImage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u4F18\u5316\u524D\uFF1A\u5C06\u9A8C\u8BC1\u7801\u5B58\u5165session.....</span>

        <span class="token comment">//\u4F18\u5316\u540E\uFF1A\u751F\u6210\u9A8C\u8BC1\u7801\u7684\u5F52\u5C5E\u4F20\u7ED9\u6D4F\u89C8\u5668Cookie</span>
        <span class="token class-name">String</span> kaptchaOwner <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;kaptchaOwner&quot;</span><span class="token punctuation">,</span> kaptchaOwner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u4F18\u5316\u540E\uFF1A\u5C06\u9A8C\u8BC1\u7801\u5B58\u5165Redis</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getKaptchaKey</span><span class="token punctuation">(</span>kaptchaOwner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token number">60</span> <span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u5C06\u56FE\u7247\u8F93\u51FA\u7ED9\u6D4F\u89C8\u5668</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;image/png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServletOutputStream</span> os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ImageIO</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token string">&quot;png&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u54CD\u5E94\u9A8C\u8BC1\u7801\u5931\u8D25:&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u767B\u5F55\u529F\u80FD
     <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> redisKey \u7528\u4E8E\u83B7\u53D6kaptcha\u9A8C\u8BC1\u7801
     <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> <span class="token annotation punctuation">@CookieValue</span>\u7528\u4E8E\u6D4F\u89C8\u5668\u63A5\u53D7cookie
     <span class="token operator">*</span> <span class="token annotation punctuation">@return</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token operator">/</span>\u6CE8\u610Fusername<span class="token punctuation">,</span>password\u8FD9\u4E9B\u6CA1\u6709\u5C01\u88C5\u8FDBmodel<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">,</span> <span class="token keyword">boolean</span> rememberme<span class="token punctuation">,</span>
                        <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">&quot;kaptchaOwner&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> kaptchaOwner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> \u4F18\u5316\u524D\uFF1A\u9996\u5148\u68C0\u9A8C\u9A8C\u8BC1\u7801<span class="token punctuation">(</span>\u4ECEsession\u53D6\u9A8C\u8BC1\u7801<span class="token punctuation">)</span>
         <span class="token operator">*</span> <span class="token class-name">String</span> kaptcha <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;kaptcha&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token operator">*</span><span class="token operator">/</span>

        <span class="token comment">// \u4F18\u5316\u540E\uFF1A\u4ECEredis\u4E2D\u83B7\u53D6kaptcha\u7684key</span>
        <span class="token class-name">String</span> kaptcha <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5224\u65AD\u4ECE\u6D4F\u89C8\u5668\u4F20\u6765\u7684Cookie\u662F\u5426\u4E3A\u7A7A</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>kaptchaOwner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getKaptchaKey</span><span class="token punctuation">(</span>kaptchaOwner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u83B7\u53D6key\u4E3A\u9A8C\u8BC1\u7801\u7684redis\u6570\u636E</span>
            kaptcha  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>kaptcha<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>kaptcha<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;codeMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u9A8C\u8BC1\u7801\u4E0D\u6B63\u786E\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> <span class="token number">1.</span>\u9A8C\u8BC1\u7528\u6237\u540D\u548C\u5BC6\u7801<span class="token punctuation">(</span>\u91CD\u70B9<span class="token punctuation">)</span>
         <span class="token operator">*</span> <span class="token number">2.</span>\u4F20\u5165\u6D4F\u89C8\u5668cookie<span class="token operator">=</span>ticket
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">int</span> expiredSeconds <span class="token operator">=</span> rememberme <span class="token operator">?</span> <span class="token constant">REMEMBER_EXPIRED_SECONDS</span> <span class="token operator">:</span> <span class="token constant">DEFAULT_EXPIRED_SECONDS</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>contextPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>expiredSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;redirect:/index&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/login&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4F7F\u7528redis\u5B58\u5B58\u767B\u5F55\u51ED\u8BC1" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528redis\u5B58\u5B58\u767B\u5F55\u51ED\u8BC1" aria-hidden="true">#</a> \u4F7F\u7528Redis\u5B58\u5B58\u767B\u5F55\u51ED\u8BC1</h2><h3 id="_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u767B\u5F55\u51ED\u8BC1key\u503C" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u767B\u5F55\u51ED\u8BC1key\u503C" aria-hidden="true">#</a> 1.\u7F16\u5199RedisUtil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u767B\u5F55\u51ED\u8BC1key\u503C</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u767B\u5F55\u51ED\u8BC1</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_TICKET</span> <span class="token operator">=</span> <span class="token string">&quot;ticket&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>\u767B\u5F55\u51ED\u8BC1<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTicketKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_TICKET</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> ticket<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u4F18\u5316userservice\u4E2Dloginticket\u76F8\u5173\u4EE3\u7801-\u5E9F\u5F03loginticket\u6570\u636E\u5E93\u8868-\u4F7F\u7528redis" tabindex="-1"><a class="header-anchor" href="#_2-\u4F18\u5316userservice\u4E2Dloginticket\u76F8\u5173\u4EE3\u7801-\u5E9F\u5F03loginticket\u6570\u636E\u5E93\u8868-\u4F7F\u7528redis" aria-hidden="true">#</a> 2.\u4F18\u5316UserService\u4E2DLoginTicket\u76F8\u5173\u4EE3\u7801\uFF08\u5E9F\u5F03LoginTicket\u6570\u636E\u5E93\u8868\uFF0C\u4F7F\u7528redis\uFF09</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u767B\u5F55\u529F\u80FD\uFF08redis\u4F18\u5316\uFF09
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token keyword">int</span> expiredSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u7A7A\u503C\u5904\u7406</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u53F7\u7801\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u5BC6\u7801\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u9A8C\u8BC1\u8D26\u53F7</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u8BE5\u8D26\u53F7\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u9A8C\u8BC1\u6FC0\u6D3B\u72B6\u6001</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;usernameMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u8BE5\u8D26\u53F7\u672A\u6FC0\u6D3B\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u9A8C\u8BC1\u5BC6\u7801(\u5148\u52A0\u5BC6\u518D\u5BF9\u6BD4)</span>
        password <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span>password <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;passwordMsg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\u5BC6\u7801\u8F93\u5165\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> map<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u751F\u6210\u767B\u5F55\u51ED\u8BC1(\u76F8\u5F53\u4E8E\u8BB0\u4F4F\u6211\u8FD9\u4E2A\u529F\u80FD==session)</span>
        <span class="token class-name">LoginTicket</span> ticket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ticket<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ticket<span class="token punctuation">.</span><span class="token function">setTicket</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ticket<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5F53\u524D\u65F6\u95F4\u7684\u6BEB\u79D2\u6570+\u8FC7\u671F\u65F6\u95F4\u6BEB\u79D2\u6570</span>
        ticket<span class="token punctuation">.</span><span class="token function">setExpired</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expiredSeconds<span class="token operator">*</span>  <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u4F18\u5316\u524D\uFF1AloginTicketMapper.insertLoginTicket(ticket);</span>
        
        <span class="token comment">// \u4F18\u5316\u540E\uFF1Aloginticket\u5BF9\u8C61\u653E\u5165redis\u4E2D</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getTicketKey</span><span class="token punctuation">(</span>ticket<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// opsForValue\u5C06ticket\u5BF9\u8C61\u5E8F\u5217\u5316\u4E3Ajson\u5B57\u7B26\u4E32</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>

        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">,</span> ticket<span class="token punctuation">.</span><span class="token function">getTicket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
    <span class="token operator">*</span> \u901A\u8FC7<span class="token class-name">Cookie</span><span class="token operator">=</span>ticket\u83B7\u53D6\u767B\u5F55\u7528\u6237<span class="token punctuation">(</span>redis\u4F18\u5316<span class="token punctuation">)</span>
    <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">LoginTicket</span> <span class="token function">getLoginTicket</span><span class="token punctuation">(</span><span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//\u4F18\u5316\u524D\uFF1A return loginTicketMapper.selectByTicket(ticket);</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getTicketKey</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">LoginTicket</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4F7F\u7528redis\u7F13\u5B58\u7528\u6237\u4FE1\u606F" tabindex="-1"><a class="header-anchor" href="#\u4F7F\u7528redis\u7F13\u5B58\u7528\u6237\u4FE1\u606F" aria-hidden="true">#</a> \u4F7F\u7528Redis\u7F13\u5B58\u7528\u6237\u4FE1\u606F</h2><h3 id="_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u7528\u6237\u7F13\u5B58key\u503C" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199redisutil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u7528\u6237\u7F13\u5B58key\u503C" aria-hidden="true">#</a> 1.\u7F16\u5199RedisUtil\u5DE5\u5177\u7C7B\u8BBE\u7F6E\u7528\u6237\u7F13\u5B58key\u503C</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u7528\u6237\u7F13\u5B58</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_USER</span> <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>\u7528\u6237\u7F13\u5B58<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_USER</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u4F18\u5316userservice\u4E2Dfinduserbyid\u548Cusermapper-updatexxx\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_2-\u4F18\u5316userservice\u4E2Dfinduserbyid\u548Cusermapper-updatexxx\u65B9\u6CD5" aria-hidden="true">#</a> 2.\u4F18\u5316UserService\u4E2DfindUserById\u548CuserMapper.updateXXX\u65B9\u6CD5</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>     <span class="token operator">/</span>
     <span class="token operator">*</span> \u56E0\u4E3A\u7ECF\u5E38\u4F7F\u7528\u8FD9\u4E2A\u65B9\u6CD5\uFF0C\u6240\u4EE5\u5C06\u5B83\u7528redis\u7F13\u5B58\u4F18\u5316
     <span class="token operator">*</span> \u82E5\u7F13\u5B58\u4E2D\u6709\u8BBF\u95EE\u7684\u7528\u6237\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u53D6\u51FA\uFF0C\u5426\u5219\u4ECE\u6570\u636E\u5E93\u67E5\u8BE2\u540E\u52A0\u5165redis\u4E2D\u4F5C\u4E3A\u7F13\u5B58
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// return userMapper.selectById(userId);</span>
        <span class="token comment">// \u4ECEredis\u7F13\u5B58\u4E2D\u53D6\u503C</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">getCache</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            user <span class="token operator">=</span> <span class="token function">initCache</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">/</span>
    <span class="token operator">*</span> \u66F4\u65B0\u5934\u50CF
    <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateHeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> headerUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span> \u540C\u65F6\u5904\u7406mysql\u548Credis\u4E8B\u52A1\u7684\u65B9\u6CD5\uFF0C\u62A5\u9519\u56DE\u6EDA<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">int</span> rows <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">clearCache</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   
    <span class="token comment">// 1.\u4F18\u5148\u4ECE\u7F13\u5B58\u4E2D\u53D6\u503C</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2.\u53D6\u4E0D\u5230\u65F6\u521D\u59CB\u5316\u7F13\u5B58\u6570\u636E(redis\u5B58\u503C)</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">initCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.\u6570\u636E\u53D8\u66F4\u65F6\u6E05\u9664\u7F13\u5B58(\u5220\u9664redis\u7684key)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4F1A\u8BDD\u7BA1\u7406-\u6682\u65F6\u4EC5\u6709demo" tabindex="-1"><a class="header-anchor" href="#\u4F1A\u8BDD\u7BA1\u7406-\u6682\u65F6\u4EC5\u6709demo" aria-hidden="true">#</a> \u4F1A\u8BDD\u7BA1\u7406\uFF08\u6682\u65F6\u4EC5\u6709demo\uFF09</h2><h3 id="_1-\u9762\u8BD5\u9898cookie\u548Csession\u7684\u533A\u522B" tabindex="-1"><a class="header-anchor" href="#_1-\u9762\u8BD5\u9898cookie\u548Csession\u7684\u533A\u522B" aria-hidden="true">#</a> 1.\u9762\u8BD5\u9898Cookie\u548CSession\u7684\u533A\u522B\uFF1F</h3><p>1.cookie\u662F\u5B58\u653E\u5728\u6D4F\u89C8\u5668\u4E0A\u7684\uFF0Csession\u662F\u5B58\u653E\u5728\u670D\u52A1\u5668\u4E0A\u7684\u3002</p><p>2.cookie\u6570\u636E\u4E0D\u5B89\u5168\uFF0C\u5982\u679C\u8003\u8651\u5230\u5B89\u5168\u5E94\u4F7F\u7528session\u3002</p><p>3.session\u4F1A\u589E\u52A0\u670D\u52A1\u7AEF\u7684\u5185\u5B58\u538B\u529B,\u8003\u8651\u5230\u51CF\u8F7B\u670D\u52A1\u5668\u6027\u80FD\u65B9\u9762\uFF0C\u5E94\u5F53\u4F7F\u7528cookie\u3002</p><p>4.cookie\u53EA\u80FD\u5B58\u653E\u4E00\u5BF9\u5B57\u7B26\u4E32k-v</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/cookie_lTxnC6khx5.PNG" alt="cookie\u539F\u7406"></p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/session_p8ugXNzzqS.PNG" alt="Session\u539F\u7406"></p><h3 id="_2-cookie\u662F\u5E72\u561B\u7684" tabindex="-1"><a class="header-anchor" href="#_2-cookie\u662F\u5E72\u561B\u7684" aria-hidden="true">#</a> 2.Cookie\u662F\u5E72\u561B\u7684\uFF1F</h3><p>\u56E0\u4E3AHttp\u662F\u65E0\u72B6\u6001\u7684\uFF0C\u6240\u4EE5\u9700\u8981\u7528\u5230cookie\u3002\u901A\u4FD7\u8BF4cookie\u662F\u7528\u6765\u8BA9\u670D\u52A1\u5668\u8BB0\u4F4F\u6D4F\u89C8\u5668\u7684\u3002</p><h3 id="_3-\u5206\u5E03\u5F0Fsession\u5171\u4EAB\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#_3-\u5206\u5E03\u5F0Fsession\u5171\u4EAB\u65B9\u6848" aria-hidden="true">#</a> 3.\u5206\u5E03\u5F0Fsession\u5171\u4EAB\u65B9\u6848</h3><p>1\u3001\u7C98\u6027session\uFF1A\u5728nginx\u4E2D\u63D0\u4F9B\u4E00\u81F4\u6027\u54C8\u5E0C\u7B56\u7565\uFF0C\u53EF\u4EE5\u4FDD\u6301\u7528\u6237ip\u8FDB\u884Chash\u503C\u8BA1\u7B97\u56FA\u5B9A\u5206\u914D\u5230\u67D0\u53F0\u670D\u52A1\u5668\u4E0A\uFF0C\u8D1F\u8F7D\u4E5F\u6BD4\u8F83\u5747\u8861\uFF0C\u5176\u95EE\u9898\u662F\u5047\u5982\u6709\u4E00\u53F0\u670D\u52A1\u5668\u6302\u4E86\uFF0Csession\u4E5F\u4E22\u5931\u4E86\u3002</p><p>2\u3001\u540C\u6B65session\uFF1A\u5F53\u67D0\u4E00\u53F0\u670D\u52A1\u5668\u5B58\u4E86session\u540E\uFF0C\u540C\u6B65\u5230\u5176\u4ED6\u670D\u52A1\u5668\u4E2D\uFF0C\u5176\u95EE\u9898\u662F\u540C\u6B65session\u5230\u5176\u4ED6\u670D\u52A1\u5668\u4F1A\u5BF9\u670D\u52A1\u5668\u6027\u80FD\u4EA7\u751F\u5F71\u54CD\uFF0C\u670D\u52A1\u5668\u4E4B\u95F4\u8026\u5408\u6027\u8F83\u5F3A\u3002</p><p>3\u3001\u5171\u4EABsession\uFF1A\u5355\u72EC\u641E\u4E00\u53F0\u670D\u52A1\u5668\u7528\u6765\u5B58session\uFF0C\u5176\u4ED6\u670D\u52A1\u5668\u90FD\u5411\u8FD9\u53F0\u670D\u52A1\u5668\u83B7\u53D6session\uFF0C\u5176\u95EE\u9898\u662F\u8FD9\u53F0\u670D\u52A1\u5668\u6302\u4E86\uFF0Csession\u5C31\u5168\u90E8\u4E22\u5931\u3002</p><p>4\u3001redis\u96C6\u4E2D\u7BA1\u7406session(\u4E3B\u6D41\u65B9\u6CD5)\uFF1Aredis\u4E3A\u5185\u5B58\u6570\u636E\u5E93\uFF0C\u8BFB\u5199\u6548\u7387\u9AD8\uFF0C\u5E76\u53EF\u5728\u96C6\u7FA4\u73AF\u5883\u4E0B\u505A\u9AD8\u53EF\u7528\u3002</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/Session\u96C6\u7FA42_FgCe_BZeb2.PNG" alt="Session\u96C6\u7FA4"></p><h3 id="_4-\u7B80\u5355api\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_4-\u7B80\u5355api\u5B9E\u73B0" aria-hidden="true">#</a> 4.\u7B80\u5355API\u5B9E\u73B0</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token class-name">Cookie</span>\u793A\u4F8B<span class="token punctuation">(</span>\u83B7\u53D6<span class="token class-name">Cookie</span>\u65F6<span class="token annotation punctuation">@CookieValue</span>\u6709\u70B9\u95EE\u9898\uFF01\uFF01<span class="token punctuation">)</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/cookie/set&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//cookie\u5B58\u7684\u5FC5\u987B\u662F\u5B57\u7B26\u4E32</span>
    <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/Community/test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token string">&quot;set cookie!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/cookie/get&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getCookie</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;get cookie!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token class-name">Session</span>\u793A\u4F8B
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/session/set&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setSession</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    session<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;xmy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;set session!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/session/get&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSession</span><span class="token punctuation">(</span><span class="token class-name">HttpSession</span> session<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;get session!&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4E0A\u4F20\u5934\u50CF\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u4E0A\u4F20\u5934\u50CF\u529F\u80FD" aria-hidden="true">#</a> \u4E0A\u4F20\u5934\u50CF\u529F\u80FD</h2><p>\u6CE8\u610F\uFF1A</p><ol><li>\u5FC5\u987B\u662FPost\u8BF7\u6C42</li><li>\u8868\u5355\uFF1Aenctype=&quot;multipart/form-data&quot;</li><li>\u53C2\u6570\u7C7B\u578BMultipartFile\u53EA\u80FD\u5C01\u88C5\u4E00\u4E2A\u6587\u4EF6</li></ol><p>\u4E0A\u4F20\u8DEF\u5F84\u53EF\u4EE5\u662F\u672C\u5730\u8DEF\u5F84\u4E5F\u53EF\u4EE5\u662Fweb\u8DEF\u5F84</p><p>\u8BBF\u95EE\u8DEF\u5F84\u5FC5\u987B\u662F\u7B26\u5408HTTP\u534F\u8BAE\u7684Web\u8DEF\u5F84</p><h3 id="_1-\u7F16\u5199service\u548Cdao\u5C42" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199service\u548Cdao\u5C42" aria-hidden="true">#</a> 1.\u7F16\u5199Service\u548CDao\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Dao\u5C42</span>
<span class="token operator">&lt;</span>update id<span class="token operator">=</span><span class="token string">&quot;updatePassword&quot;</span><span class="token operator">&gt;</span>
    update user set password<span class="token operator">=</span>#<span class="token punctuation">{</span>password<span class="token punctuation">}</span> where id<span class="token operator">=</span>#<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>update<span class="token operator">&gt;</span>
<span class="token keyword">int</span> <span class="token function">updateHeader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;headerUrl&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Service\u5C42</span>
<span class="token operator">/</span>\u66F4\u6362\u4E0A\u4F20\u5934\u50CF<span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateHeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token class-name">String</span> headerUrl<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u7A0Bcontroller\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u7A0Bcontroller\u5C42" aria-hidden="true">#</a> 2.\u7F16\u7A0BController\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">UserController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//community.path.upload = d:/DemoNowcoder/upload</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${community.path.upload}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> uploadPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${community.path.domain}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${server.servlet.context-path}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token operator">/</span>\u83B7\u5F97\u5F53\u524D\u767B\u5F55\u7528\u6237\u7684\u4FE1\u606F<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/setting&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSettingPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/setting&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//\u4E0A\u4F20\u5934\u50CF</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/upload&quot;</span><span class="token punctuation">,</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">uploadHeader</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> headerImage<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//StringUtils.isBlank(headerImage)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>headerImage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u60A8\u8FD8\u6CA1\u6709\u9009\u62E9\u56FE\u7247\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/setting&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/*
        * \u83B7\u5F97\u539F\u59CB\u6587\u4EF6\u540D\u5B57
        * \u76EE\u7684\u662F\uFF1A\u751F\u6210\u968F\u673A\u4E0D\u91CD\u590D\u6587\u4EF6\u540D\uFF0C\u9632\u6B62\u540C\u540D\u6587\u4EF6\u8986\u76D6
        * \u65B9\u6CD5\uFF1A\u83B7\u53D6.\u540E\u9762\u7684\u56FE\u7247\u7C7B\u578B \u52A0\u4E0A \u968F\u673A\u6570
        */</span>
        <span class="token class-name">String</span> filename <span class="token operator">=</span> headerImage<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> suffix <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u4EFB\u4F55\u6587\u4EF6\u90FD\u53EF\u4EE5\u4E0A\u4F20,\u6839\u636E\u4E1A\u52A1\u5728\u6B64\u52A0\u9650\u5236</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\u6587\u4EF6\u683C\u5F0F\u4E0D\u6B63\u786E\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;/site/setting&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//\u751F\u6210\u968F\u673A\u6587\u4EF6\u540D</span>
        filename <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
        <span class="token comment">//\u786E\u5B9A\u6587\u4EF6\u5B58\u653E\u8DEF\u52B2</span>
        <span class="token class-name">File</span> dest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>uploadPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">//\u5C06\u6587\u4EF6\u5B58\u5165\u6307\u5B9A\u4F4D\u7F6E</span>
            headerImage<span class="token punctuation">.</span><span class="token function">transferTo</span><span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25\uFF1A &quot;</span><span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25\uFF0C\u670D\u52A1\u5668\u53D1\u751F\u5F02\u5E38\uFF01&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//\u66F4\u65B0\u5F53\u524D\u7528\u6237\u7684\u5934\u50CF\u7684\u8DEF\u5F84\uFF08web\u8BBF\u95EE\u8DEF\u5F84\uFF09</span>
        <span class="token comment">//http://localhost:8080/community/user/header/xxx.png</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> headerUrl <span class="token operator">=</span> domain <span class="token operator">+</span> contextPath <span class="token operator">+</span> <span class="token string">&quot;/user/header/&quot;</span> <span class="token operator">+</span> filename<span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>headerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">//\u5F97\u5230\u670D\u52A1\u5668\u56FE\u7247</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/header/{fileName}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token operator">/</span><span class="token keyword">void</span><span class="token operator">:</span>\u8FD4\u56DE\u7ED9\u6D4F\u89C8\u5668\u7684\u662F\u7279\u8272\u7684\u56FE\u7247\u7C7B\u578B\u6240\u4EE5\u7528<span class="token keyword">void</span><span class="token operator">/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u670D\u52A1\u5668\u5B58\u653E\u8DEF\u5F84(\u672C\u5730\u8DEF\u5F84)</span>
      fileName <span class="token operator">=</span> uploadPath <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
      <span class="token comment">// \u6587\u4EF6\u540E\u7F00</span>
      <span class="token class-name">String</span> suffix <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u6D4F\u89C8\u5668\u54CD\u5E94\u56FE\u7247</span>
      response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;image/&quot;</span> <span class="token operator">+</span> suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">(</span>
              <span class="token comment">//\u56FE\u7247\u662F\u4E8C\u8FDB\u5236\u7528\u5B57\u8282\u6D41</span>
              <span class="token class-name">FileInputStream</span> fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//\u8BBE\u7F6E\u7F13\u51B2\u533A</span>
          <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">//\u8BBE\u7F6E\u6E38\u6807</span>
          <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              os<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BFB\u53D6\u5934\u50CF\u5931\u8D25: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_3-\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 3.\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mt-5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/user/upload}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>custom-file<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span>
           <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|custom-file-input \${error!=null?&#39;is-invalid&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span>
           <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>headerImage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>head-image<span class="token punctuation">&quot;</span></span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>es<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>custom-file-label<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>head-image<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-browse</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u6587\u4EF6<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u9009\u62E9\u4E00\u5F20\u56FE\u7247<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>invalid-feedback<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${error}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        \u8BE5\u8D26\u53F7\u4E0D\u5B58\u5728!
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8FC7\u6EE4\u654F\u611F\u8BCD" tabindex="-1"><a class="header-anchor" href="#\u8FC7\u6EE4\u654F\u611F\u8BCD" aria-hidden="true">#</a> \u8FC7\u6EE4\u654F\u611F\u8BCD</h2><p>\u524D\u7F00\u6811\uFF1A</p><ol><li>\u6839\u8282\u70B9\u4E0D\u5305\u542B\u5B57\u7B26\uFF0C\u9664\u6839\u8282\u70B9\u4EE5\u5916\u7684\u6BCF\u4E2A\u8282\u70B9\uFF0C\u53EA\u5305\u542B\u4E00\u4E2A\u5B57\u7B26</li><li>\u4ECE\u6839\u8282\u70B9\u5230\u67D0\u4E00\u4E2A\u8282\u70B9\uFF0C\u8DEF\u5F84\u4E0A\u7ECF\u8FC7\u7684\u5B57\u7B26\u8FDE\u63A5\u8D77\u6765\uFF0C\u4E3A\u8BE5\u8282\u70B9\u5BF9\u5E94\u5B57\u7B26\u4E32</li><li>\u6BCF\u4E2A\u8282\u70B9\u7684\u6240\u6709\u5B50\u8282\u70B9\uFF0C\u5305\u542B\u7684\u5B57\u7B26\u4E32\u4E0D\u76F8\u540C</li></ol><p>\u6838\u5FC3\uFF1A</p><ol><li>\u6709\u4E00\u4E2A\u6307\u9488\u6307\u5411\u524D\u7F00\u6811\uFF0C\u7528\u4EE5\u904D\u5386\u654F\u611F\u8BCD\u7684\u6BCF\u4E00\u4E2A\u5B57\u7B26</li><li>\u6709\u4E00\u4E2A\u6307\u9488\u6307\u5411\u88AB\u8FC7\u6EE4\u5B57\u7B26\u4E32\uFF0C\u7528\u4EE5\u6807\u8BC6\u654F\u611F\u8BCD\u7684\u5F00\u5934</li><li>\u6709\u4E00\u4E2A\u6307\u9488\u6307\u5411\u88AB\u8FC7\u6EE4\u5B57\u7B26\u4E32\uFF0C\u7528\u4EE5\u6807\u8BC6\u654F\u611F\u8BCD\u7684\u7ED3\u5C3E</li></ol><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/\u524D\u7F00\u6811_iqtqXZxYU3.PNG" alt="\u524D\u7F00\u6811\u5B9E\u73B0\u8FC7\u6EE4\u654F\u611F\u8BCD"></p><h3 id="_1-\u8FC7\u6EE4\u654F\u611F\u8BCD\u7B97\u6CD5" tabindex="-1"><a class="header-anchor" href="#_1-\u8FC7\u6EE4\u654F\u611F\u8BCD\u7B97\u6CD5" aria-hidden="true">#</a> 1.\u8FC7\u6EE4\u654F\u611F\u8BCD\u7B97\u6CD5</h3><p>\u5728resources\u521B\u5EFAsensitive-words.txt\u6587\u654F\u611F\u8BCD\u6587\u672C</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> \u8FC7\u6EE4\u654F\u611F\u8BCD\u5DE5\u5177\u7C7B
 <span class="token operator">*</span> \u7C7B\u4F3C\u4E8E\u4E8C\u53C9\u6811\u7684\u7B97\u6CD5
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SensitiveFilter</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SensitiveFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u66FF\u6362\u7B26</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REPLACEMENT</span> <span class="token operator">=</span> <span class="token string">&quot;* &quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// \u6839\u8282\u70B9</span>
    <span class="token keyword">private</span> <span class="token class-name">TrieNode</span> rootNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u7F16\u8BD1\u4E4B\u524D\u8FD0\u884C</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token comment">// \u8BFB\u53D6\u6587\u4EF6\u6D41 BufferedReader\u5E26\u7F13\u51B2\u533A\u6548\u7387\u66F4\u9AD8</span>
                <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;sensitive-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> keyword<span class="token punctuation">;</span>
            <span class="token comment">// \u4E00\u884C\u4E00\u884C\u8BFB\u53D6\u6587\u4EF6\u4E2D\u7684\u5B57\u7B26</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keyword <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u6DFB\u52A0\u5230\u524D\u7F00\u6811</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u52A0\u8F7D\u654F\u611F\u8BCD\u6587\u4EF6\u5931\u8D25: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u5C06\u4E00\u4E2A\u654F\u611F\u8BCD\u6DFB\u52A0\u5230\u524D\u7F00\u6811\u4E2D
     <span class="token operator">*</span> \u7C7B\u4F3C\u4E8E\u7A7A\u4E8C\u53C9\u6811\u7684\u63D2\u5165
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TrieNode</span> tempNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyword<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//\u5C06\u6C49\u5B57\u8F6C\u5316\u4E3AChar\u503C</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> keyword<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrieNode</span> subNode <span class="token operator">=</span> tempNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>subNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u521D\u59CB\u5316\u5B50\u8282\u70B9\u5E76\u52A0\u5165\u5230\u524D\u7F00\u6811\u4E2D</span>
                subNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tempNode<span class="token punctuation">.</span><span class="token function">addSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> subNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// \u6307\u5411\u5B50\u8282\u70B9,\u8FDB\u5165\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span>
            tempNode <span class="token operator">=</span> subNode<span class="token punctuation">;</span>

            <span class="token comment">// \u8BBE\u7F6E\u7ED3\u675F\u6807\u8BC6</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> keyword<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tempNode<span class="token punctuation">.</span><span class="token function">setKeywordEnd</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u8FC7\u6EE4\u654F\u611F\u8BCD
     <span class="token operator">*</span> <span class="token annotation punctuation">@param</span> text \u5F85\u8FC7\u6EE4\u7684\u6587\u672C
     <span class="token operator">*</span> <span class="token annotation punctuation">@return</span> \u8FC7\u6EE4\u540E\u7684\u6587\u672C
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u6307\u94881</span>
        <span class="token class-name">TrieNode</span> tempNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token comment">// \u6307\u94882</span>
        <span class="token keyword">int</span> begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6307\u94883</span>
        <span class="token keyword">int</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// \u7ED3\u679C(StringBuilder\uFF1A\u53EF\u53D8\u957F\u5EA6\u7684String\u7C7B)</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>position <span class="token operator">&lt;</span> text<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8DF3\u8FC7\u7B26\u53F7</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u82E5\u6307\u94881\u5904\u4E8E\u6839\u8282\u70B9,\u5C06\u6B64\u7B26\u53F7\u8BA1\u5165\u7ED3\u679C,\u8BA9\u6307\u94882\u5411\u4E0B\u8D70\u4E00\u6B65</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tempNode <span class="token operator">==</span> rootNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    begin<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// \u65E0\u8BBA\u7B26\u53F7\u5728\u5F00\u5934\u6216\u4E2D\u95F4,\u6307\u94883\u90FD\u5411\u4E0B\u8D70\u4E00\u6B65</span>
                position<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// \u68C0\u67E5\u4E0B\u7EA7\u8282\u70B9</span>
            tempNode <span class="token operator">=</span> tempNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tempNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u4EE5begin\u5F00\u5934\u7684\u5B57\u7B26\u4E32\u4E0D\u662F\u654F\u611F\u8BCD</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u8FDB\u5165\u4E0B\u4E00\u4E2A\u4F4D\u7F6E</span>
                position <span class="token operator">=</span> <span class="token operator">++</span>begin<span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u65B0\u6307\u5411\u6839\u8282\u70B9</span>
                tempNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tempNode<span class="token punctuation">.</span><span class="token function">isKeywordEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u53D1\u73B0\u654F\u611F\u8BCD,\u5C06begin~position\u5B57\u7B26\u4E32\u66FF\u6362\u6389</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">REPLACEMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u8FDB\u5165\u4E0B\u4E00\u4E2A\u4F4D\u7F6E</span>
                begin <span class="token operator">=</span> <span class="token operator">++</span>position<span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u65B0\u6307\u5411\u6839\u8282\u70B9</span>
                tempNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u68C0\u67E5\u4E0B\u4E00\u4E2A\u5B57\u7B26</span>
                position<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u5C06\u6700\u540E\u4E00\u6279\u5B57\u7B26\u8BA1\u5165\u7ED3\u679C</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u5224\u65AD\u662F\u5426\u4E3A\u7B26\u53F7</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSymbol</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 0x2E80~0x9FFF \u662F\u4E1C\u4E9A\u6587\u5B57\u8303\u56F4</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">CharUtils</span><span class="token punctuation">.</span><span class="token function">isAsciiAlphanumeric</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0x2E80</span> <span class="token operator">||</span> c <span class="token operator">&gt;</span> <span class="token number">0x9FFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u6784\u9020\u524D\u7F00\u6811\u6570\u636E\u7ED3\u6784</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">{</span>

        <span class="token comment">// \u5173\u952E\u8BCD\u7ED3\u675F\u6807\u8BC6</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isKeywordEnd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5B50\u8282\u70B9(key\u662F\u4E0B\u7EA7\u5B57\u7B26,value\u662F\u4E0B\u7EA7\u8282\u70B9)</span>
        <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">TrieNode</span><span class="token punctuation">&gt;</span></span> subNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isKeywordEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> isKeywordEnd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeywordEnd</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keywordEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isKeywordEnd <span class="token operator">=</span> keywordEnd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u6DFB\u52A0\u5B50\u8282\u70B9</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">,</span> <span class="token class-name">TrieNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            subNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u83B7\u53D6\u5B50\u8282\u70B9</span>
        <span class="token keyword">public</span> <span class="token class-name">TrieNode</span> <span class="token function">getSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> subNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u5F15\u5165\u7B2C\u4E09\u65B9maven-\u5982\u4E0B" tabindex="-1"><a class="header-anchor" href="#_2-\u5F15\u5165\u7B2C\u4E09\u65B9maven-\u5982\u4E0B" aria-hidden="true">#</a> 2.\u5F15\u5165\u7B2C\u4E09\u65B9Maven,\u5982\u4E0B</h3>`,135),f={href:"https://github.com/jinrunheng/sensitive-words-filter",title:"https://github.com/jinrunheng/sensitive-words-filter",target:"_blank",rel:"noopener noreferrer"},h=n("em",null,"https://github.com/jinrunheng/sensitive-words-filter",-1),w=p(`<div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.jinrunheng<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sensitive-words-filter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u53D1\u5E03\u8D34\u5B50\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u53D1\u5E03\u8D34\u5B50\u529F\u80FD" aria-hidden="true">#</a> \u53D1\u5E03\u8D34\u5B50\u529F\u80FD</h2><p>\u6838\u5FC3 \uFF1Aajax\u5F02\u6B65\uFF1A\u6574\u4E2A\u7F51\u9875\u4E0D\u5237\u65B0\uFF0C\u8BBF\u95EE\u670D\u52A1\u5668\u8D44\u6E90\u8FD4\u56DE\u7ED3\u679C\uFF0C\u5B9E\u73B0\u5C40\u90E8\u7684\u5237\u65B0\u3002</p><p>\u5B9E\u8D28\uFF1AJavaScript\u548CXML\uFF08\u4F46\u76EE\u524DJSON\u7684\u4F7F\u7528\u6BD4XML\u66F4\u52A0\u666E\u904D\uFF09</p><p>\u5C01\u88C5Fastjson\u5DE5\u5177\u7C7B</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//\u4F7F\u7528fastjson\uFF0C\u5C06JSON\u5BF9\u8C61\u8F6C\u4E3AJSON\u5B57\u7B26\u4E32(\u524D\u63D0\u8981\u5F15\u5165Fastjson)</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token parameter">int code<span class="token punctuation">,</span> String msg<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">&gt;</span> map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      JSONObject json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;msg&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//\u4ECEmap\u91CC\u7684key\u96C6\u5408\u4E2D\u53D6\u51FA\u6BCF\u4E00\u4E2Akey</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              json<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token parameter">int code<span class="token punctuation">,</span> String msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getJSONString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token parameter">int code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getJSONString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ajax\u5F02\u6B65demo\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#ajax\u5F02\u6B65demo\u793A\u4F8B" aria-hidden="true">#</a> ajax\u5F02\u6B65Demo\u793A\u4F8B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>
   <span class="token operator">*</span> <span class="token class-name">Ajax</span>\u5F02\u6B65\u8BF7\u6C42\u793A\u4F8B
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/ajax&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ResponseBody</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testAjax</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;\u64CD\u4F5C\u6210\u529F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>  <span class="token comment">//\u5F02\u6B65JS</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;button&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;\u53D1\u9001&quot;</span> onclick<span class="token operator">=</span><span class="token string">&quot;send();&quot;</span><span class="token operator">&gt;</span>
  <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
          <span class="token string">&quot;/community/test/ajax&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;\u5F20\u4E09&quot;</span><span class="token punctuation">,</span><span class="token string-property property">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token comment">//\u56DE\u8C03\u51FD\u6570\u8FD4\u56DE\u7ED3\u679C</span>
          <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//\u8FD4\u56DEjson\u5B57\u7B26\u4E32\u683C\u5F0F(fastJson)</span>
              data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
              console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-\u7F16\u5199mapper\u5C42" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199mapper\u5C42" aria-hidden="true">#</a> 1.\u7F16\u5199Mapper\u5C42</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>int insertDiscussPost(DiscussPost discussPost);

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sql</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insertFields<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    user_id,title,content,type,status,create_time,comment_count,score
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sql</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>insert</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insertDiscussPost<span class="token punctuation">&quot;</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DiscussPost<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    insert into discuss_post(<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>insertFields<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>)
    values (#{userId}, #{title}, #{content}, #{type}, #{status}, #{createTime}, #{commentCount}, #{score})
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>insert</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42-2" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42-2" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>post <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//\u4E0D\u7528map\u76F4\u63A5\u629B\u5F02\u5E38</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//\u8F6C\u4E49HTML\u6807\u7B7E,Springboot\u81EA\u5E26\u8F6C\u4E49\u5DE5\u5177HtmlUtils.htmlEscape()</span>
      post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8FC7\u6EE4\u654F\u611F\u8BCD</span>
      post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>sensitiveFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>sensitiveFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">insertDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u63A7\u5236\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u63A7\u5236\u5C42" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u63A7\u5236\u5C42</h3><p>(\u5F02\u6B65\u8BF7\u6C42\u8981\u52A0@ResponseBody,\u4E14\u4E0D\u7528\u5728Controller\u5C42\u7528Model\uFF0C\u7528Js)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">DiscussPostService</span> discussPostService<span class="token punctuation">;</span>
  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
  
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ResponseBody</span>    <span class="token comment">//\u8FD4\u56DEJson\u683C\u5F0F\uFF0C\u4E00\u5B9A\u8981\u52A0@ResponseBody</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7684\u7528\u6237</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">//403\u6743\u9650\u4E0D\u591F</span>
          <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span><span class="token string">&quot;\u4F60\u8FD8\u6CA1\u6709\u767B\u5F55\u54E6\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiscussPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      post<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u4E1A\u52A1\u5904\u7406\uFF0C\u5C06\u7528\u6237\u7ED9\u7684title\uFF0Ccontent\u8FDB\u884C\u5904\u7406\u5E76\u6DFB\u52A0\u8FDB\u6570\u636E\u5E93</span>
      discussPostService<span class="token punctuation">.</span><span class="token function">addDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u8FD4\u56DEJson\u683C\u5F0F\u5B57\u7B26\u4E32\u7ED9\u524D\u7AEFJS,\u62A5\u9519\u7684\u60C5\u51B5\u5C06\u6765\u7EDF\u4E00\u5904\u7406</span>
      <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;\u53D1\u5E03\u6210\u529F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u524D\u7AEF\u5F02\u6B65js" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u524D\u7AEF\u5F02\u6B65js" aria-hidden="true">#</a> 4.\u7F16\u5199\u524D\u7AEF\u5F02\u6B65JS</h3><p>\u6CE8\u610F\uFF1A$.parseJSON(data) \u2192\u901A\u8FC7jQuery\uFF0C\u5C06\u670D\u52A1\u7AEF\u8FD4\u56DE\u7684JSON\u683C\u5F0F\u7684\u5B57\u7B26\u4E32\u8F6C\u4E3Ajs\u5BF9\u8C61</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#publishBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>publish<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#publishModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">/</span>
  <span class="token operator">*</span> \u670D\u52A1\u5668\u5904\u7406
  <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token comment">// \u83B7\u53D6\u6807\u9898\u548C\u5185\u5BB9</span>
  <span class="token keyword">var</span> title <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#recipient-name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#message-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// \u53D1\u9001\u5F02\u6B65\u8BF7\u6C42(POST)</span>
  $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
    <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/discuss/add&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">//\u4E0EController\u5C42\u4E24\u4E2A\u5C5E\u6027\u8981\u4E00\u81F4\uFF01\uFF01\uFF01</span>
    <span class="token punctuation">{</span><span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span>title<span class="token punctuation">,</span><span class="token string-property property">&quot;content&quot;</span><span class="token operator">:</span>content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//\u628Ajson\u5B57\u7B26\u4E32\u8F6C\u5316\u6210Js\u5BF9\u8C61,\u540E\u9762\u624D\u53EF\u4EE5\u8C03\u7528data.msg</span>
      data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u5728\u63D0\u793A\u6846\u4E2D\u663E\u793A\u8FD4\u56DE\u6D88\u606F</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintBody&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u663E\u793A\u63D0\u793A\u6846</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;show&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2\u79D2\u540E,\u81EA\u52A8\u9690\u85CF\u63D0\u793A\u6846</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5237\u65B0\u9875\u9762</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u67E5\u770B\u5E16\u5B50\u8BE6\u60C5\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u67E5\u770B\u5E16\u5B50\u8BE6\u60C5\u529F\u80FD" aria-hidden="true">#</a> \u67E5\u770B\u5E16\u5B50\u8BE6\u60C5\u529F\u80FD</h2><h3 id="_1-\u7F16\u5199mapper\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199mapper\u5C42-1" aria-hidden="true">#</a> 1.\u7F16\u5199Mapper\u5C42</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>DiscussPost selectDiscussPostById(int id);
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>----------------------</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectDiscussPostById<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>DiscussPost<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    select <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>selectFields<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include</span><span class="token punctuation">&gt;</span></span>
    from discuss_post
    where id = #{id}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42-3" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42-3" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">DiscussPost</span> <span class="token function">findDiscussPostById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u5C42-1" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/detail/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDiscusspost</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u901A\u8FC7\u524D\u7AEF\u4F20\u6765\u7684Id\u67E5\u8BE2\u5E16\u5B50</span>
      <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u7528\u4EE5\u663E\u793A\u53D1\u5E16\u4EBA\u7684\u5934\u50CF\u53CA\u7528\u6237\u540D</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;/site/discuss-detail&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206" aria-hidden="true">#</a> 4.\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u90E8\u5206</h3><p>\uFF08\u8FDB\u5165\u8BE6\u60C5\u94FE\u63A5\u53CAController\u5C42\u4E2D\u7684model\uFF09</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--\u524D\u7AEF\u70B9\u51FB\u8FDB\u5165\u8BE6\u60C5\u7684\u94FE\u63A5--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${discussPosts}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/discuss/detail/\${map.post.id}|}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.title}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6807\u9898\u94FE\u63A5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

th:utext=&quot;\${post.getTitle()}&quot;     <span class="token comment">&lt;!--\u6807\u9898--&gt;</span>
th:src=&quot;\${user.getHeaderUrl()}&quot;   <span class="token comment">&lt;!--\u7528\u6237\u5934\u50CF--&gt;</span>
th:utext=&quot;\${user.getUsername()}&quot;  <span class="token comment">&lt;!--\u7528\u6237\u540D\u5B57--&gt;</span>
th:text=&quot;\${#dates.format(post.getCreateTime(),&#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;   <span class="token comment">&lt;!--\u53D1\u5E16\u65F6\u95F4--&gt;</span>
th:utext=&quot;\${post.getContent()}&quot;   <span class="token comment">&lt;!--\u53D1\u5E16\u5185\u5BB9--&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u4E8B\u52A1\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#\u4E8B\u52A1\u7BA1\u7406" aria-hidden="true">#</a> \u4E8B\u52A1\u7BA1\u7406</h2><h3 id="_1-\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_1-\u6982\u5FF5" aria-hidden="true">#</a> 1.\u6982\u5FF5</h3><h4 id="_1-1\u4E8B\u52A1\u7684\u7279\u6027" tabindex="-1"><a class="header-anchor" href="#_1-1\u4E8B\u52A1\u7684\u7279\u6027" aria-hidden="true">#</a> 1.1\u4E8B\u52A1\u7684\u7279\u6027</h4><p>\u539F\u5B50\u6027\uFF1A\u5373\u4E8B\u52A1\u662F\u5E94\u7528\u4E2D\u4E0D\u53EF\u518D\u5206\u7684\u6700\u5C0F\u6267\u884C\u4F53\u3002</p><p>\u4E00\u81F4\u6027\uFF1A\u5373\u4E8B\u52A1\u6267\u884C\u7684\u7ED3\u679C\uFF0C\u5FC5\u987B\u4F7F\u6570\u636E\u4ECE\u4E00\u4E2A\u4E00\u81F4\u6027\u72B6\u6001\uFF0C\u53D8\u4E3A\u53E6\u4E00\u4E2A\u4E00\u81F4\u6027\u72B6\u6001\u3002</p><p>\u9694\u79BB\u6027\uFF1A\u5373\u5404\u4E2A\u4E8B\u52A1\u7684\u6267\u884C\u4E92\u4E0D\u5E72\u6270\uFF0C\u4EFB\u4F55\u4E8B\u52A1\u7684\u5185\u90E8\u64CD\u4F5C\u5BF9\u5176\u4ED6\u7684\u4E8B\u52A1\u90FD\u662F\u9694\u79BB\u7684\u3002</p><p>\u6301\u4E45\u6027\uFF1A\u4E8B\u52A1\u4E00\u65E6\u63D0\u4EA4\uFF0C\u5BF9\u6570\u636E\u6240\u505A\u7684\u4EFB\u4F55\u6539\u53D8\u90FD\u8981\u8BB0\u5F55\u5230\u6C38\u4E45\u5B58\u50A8\u5668\u3002</p><h4 id="_1-2\u4E8B\u52A1\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" tabindex="-1"><a class="header-anchor" href="#_1-2\u4E8B\u52A1\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B" aria-hidden="true">#</a> 1.2\u4E8B\u52A1\u7684\u56DB\u79CD\u9694\u79BB\u7EA7\u522B</h4><p>Read Uncommitted\uFF1A \u8BFB\u672A\u63D0\u4EA4\uFF08\u7EA7\u522B\u6700\u4F4E\uFF09</p><p>Read Committed\uFF1A \u8BFB\u5DF2\u63D0\u4EA4</p><p>Repeatable Read\uFF1A \u53EF\u91CD\u590D\u8BFB</p><p>Serializable\uFF1A \u4E32\u884C\u5316\uFF08\u7EA7\u522B\u6700\u9AD8 \uFF0C<em>\u6027\u80FD\u6700\u4F4E\uFF0C\u56E0\u4E3A\u8981\u52A0\u9501\uFF09</em></p><h4 id="_1-3\u5E76\u53D1\u5F02\u5E38" tabindex="-1"><a class="header-anchor" href="#_1-3\u5E76\u53D1\u5F02\u5E38" aria-hidden="true">#</a> 1.3\u5E76\u53D1\u5F02\u5E38</h4><ul><li><p>\u7B2C\u4E00\u7C7B\u4E22\u5931\u66F4\u65B0</p></li><li><p>\u7B2C\u4E8C\u7C7B\u4E22\u5931\u66F4\u65B0</p></li><li><p>\u810F\u8BFB</p></li><li><p>\u4E0D\u53EF\u91CD\u590D\u8BFB</p></li><li><p>\u5E7B\u8BFB</p></li></ul><h3 id="_2-spring\u58F0\u660E\u5F0F\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-spring\u58F0\u660E\u5F0F\u4E8B\u52A1" aria-hidden="true">#</a> 2.Spring\u58F0\u660E\u5F0F\u4E8B\u52A1</h3><p>\u65B9\u6CD5\uFF1A 1.\u901A\u8FC7XML\u914D\u7F6E 2.\u901A\u8FC7\u6CE8\u89E3@Transaction\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/* REQUIRED: \u652F\u6301\u5F53\u524D\u4E8B\u52A1\uFF08\u5916\u90E8\u4E8B\u52A1\uFF09\uFF0C\u5982\u679C\u4E0D\u5B58\u5728\u5219\u521B\u5EFA\u65B0\u4E8B\u52A1
 * REQUIRED_NEW: \u521B\u5EFA\u4E00\u4E2A\u65B0\u4E8B\u52A1\uFF0C\u5E76\u4E14\u6682\u505C\u5F53\u524D\u4E8B\u52A1\uFF08\u5916\u90E8\u4E8B\u52A1\uFF09
 * NESTED: \u5982\u679C\u5F53\u524D\u5B58\u5728\u4E8B\u52A1\uFF08\u5916\u90E8\u4E8B\u52A1\uFF09\uFF0C\u5219\u5D4C\u5957\u5728\u8BE5\u4E8B\u52A1\u4E2D\u6267\u884C\uFF08\u72EC\u7ACB\u7684\u63D0\u4EA4\u548C\u56DE\u6EDA\uFF09\uFF0C\u5426\u5219\u5C31\u4F1A\u548CREQUIRED\u4E00\u6837
 * \u9047\u5230\u9519\u8BEF\uFF0CSql\u56DE\u6EDA  \uFF08A-&gt;B\uFF09
 */</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">READ_COMMITTED</span><span class="token punctuation">,</span> propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-spring\u7F16\u7A0B\u5F0F\u4E8B\u52A1" tabindex="-1"><a class="header-anchor" href="#_3-spring\u7F16\u7A0B\u5F0F\u4E8B\u52A1" aria-hidden="true">#</a> 3.Spring\u7F16\u7A0B\u5F0F\u4E8B\u52A1</h3><p>(\u901A\u5E38\u7528\u6765\u7BA1\u7406\u4E2D\u95F4\u67D0\u4E00\u5C0F\u90E8\u5206\u4E8B\u52A1)</p><p>\u65B9\u6CD5\uFF1A \u901A\u8FC7TransactionTemplate\u7EC4\u4EF6\u6267\u884CSQL\u7BA1\u7406\u4E8B\u52A1\uFF0C\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">save2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      transactionTemplate<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_READ_COMMITTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      transactionTemplate<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> transactionTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doInTransaction</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;Marry&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setSalt</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">md5</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span>user<span class="token punctuation">.</span><span class="token function">getSalt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setHeaderUrl</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/2.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              user<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              userMapper<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//\u8BBE\u7F6Eerror,\u9A8C\u8BC1\u4E8B\u52A1\u56DE\u6EDA</span>
              <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u8BC4\u8BBA\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u8BC4\u8BBA\u529F\u80FD" aria-hidden="true">#</a> \u8BC4\u8BBA\u529F\u80FD</h2><p>\u663E\u793A\u8BC4\u8BBA\uFF08\u8BC4\u8BBA\u548C\u8BC4\u8BBA\u4E2D\u7684\u56DE\u590D\uFF09</p><h3 id="_1-\u7F16\u5199dao\u5C42\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42\u63A5\u53E3" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42\u63A5\u53E3</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>
   <span class="token operator">*</span> \u6839\u636E\u8BC4\u8BBA\u7C7B\u578B<span class="token punctuation">(</span>\u5E16\u5B50\u8BC4\u8BBA\u548C\u56DE\u590D\u8BC4\u8BBA<span class="token punctuation">)</span>\u548C\u8BC4\u8BBA<span class="token class-name">Id</span><span class="token operator">--</span>\u5206\u9875\u67E5\u8BE2\u8BC4\u8BBA
   <span class="token operator">*</span> <span class="token annotation punctuation">@return</span> <span class="token class-name">Comment</span>\u7C7B\u578B\u96C6\u5408
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectCommentsByEntity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> entityId<span class="token punctuation">,</span>
                                       <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">selectCountByEntity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token class-name">Mapper</span><span class="token punctuation">.</span>xml<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span> 
    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectCommentsByEntity&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;Comment&quot;</span><span class="token operator">&gt;</span>
        select <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
        from comment
        where status <span class="token operator">=</span> <span class="token number">0</span>
        and entity_type <span class="token operator">=</span> #<span class="token punctuation">{</span>entityType<span class="token punctuation">}</span>
        and entity_Id <span class="token operator">=</span> #<span class="token punctuation">{</span>entityId<span class="token punctuation">}</span>
        order by create_time asc
        limit  #<span class="token punctuation">{</span>offset<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>limit<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">&quot;selectCountByEntity&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
        select <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        from comment
        where status <span class="token operator">=</span> <span class="token number">0</span>
        and entity_type <span class="token operator">=</span> #<span class="token punctuation">{</span>entityType<span class="token punctuation">}</span>
        and entity_id <span class="token operator">=</span> #<span class="token punctuation">{</span>entityId<span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199\u4E1A\u52A1service\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199\u4E1A\u52A1service\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199\u4E1A\u52A1Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCommentsByEntity</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> commentMapper<span class="token punctuation">.</span><span class="token function">selectCommentsByEntity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findCommentCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> commentMapper<span class="token punctuation">.</span><span class="token function">selectCountByEntity</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u63A7\u5236\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u63A7\u5236\u5C42-1" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u63A7\u5236\u5C42</h3><p>\uFF08\u63A5\u67E5\u770B\u5E16\u5B50\u8BE6\u60C5\uFF0C\u5982\u4E0A\uFF09\u96BE\u70B9\uFF08\u7C7B\u4F3C\u4E8E\u5957\u5A03\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/detail/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDiscusspost</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//\u901A\u8FC7\u524D\u7AEF\u4F20\u6765\u7684Id\u67E5\u8BE2\u5E16\u5B50</span>
      <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u67E5\u8BE2\u53D1\u5E16\u4EBA\u7684\u5934\u50CF\u53CA\u7528\u6237\u540D</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
      <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// \u70B9\u8D5E\u72B6\u6001 (\u6CA1\u767B\u5F55\u5C31\u663E\u793A0)</span>
      <span class="token keyword">int</span> likeStatus <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token char">&#39;0&#39;</span> <span class="token operator">:</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u8BBE\u7F6E\u8BC4\u8BBA\u5206\u9875\u4FE1\u606F</span>
      page<span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/discuss/detail/&quot;</span><span class="token operator">+</span>discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getCommentCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// \u8BC4\u8BBA: \u7ED9\u5E16\u5B50\u7684\u8BC4\u8BBA</span>
      <span class="token comment">// \u56DE\u590D: \u7ED9\u8BC4\u8BBA\u7684\u8BC4\u8BBA</span>
      <span class="token comment">// \u8BC4\u8BBA\u5217\u8868\u96C6\u5408</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> commentList <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentsByEntity</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// \u8BC4\u8BBAVO(viewObject)\u5217\u8868 (\u5C06comment,user\u4FE1\u606F\u5C01\u88C5\u5230\u6BCF\u4E00\u4E2AMap\uFF0C\u6BCF\u4E00\u4E2AMap\u518D\u5C01\u88C5\u5230\u4E00\u4E2AList\u4E2D)</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> commentVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>commentList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// \u6BCF\u4E00\u6761\u8BC4\u8BBA\u53CA\u8BE5\u8BC4\u8BBA\u7684\u7528\u6237\u5C01\u88C5\u8FDBmap\u96C6\u5408</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Comment</span> comment <span class="token operator">:</span> commentList<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token comment">// \u8BC4\u8BBAMap--&gt;commentVo</span>
              <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> commentVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u8BC4\u8BBA</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">,</span> comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u4F5C\u8005(\u7531comment\u8868\u4E2D entity = 1 \u67E5user\u8868)</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              
              <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
              likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u70B9\u8D5E\u72B6\u6001 (\u6CA1\u767B\u5F55\u5C31\u663E\u793A0)</span>
              likeStatus <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token char">&#39;0&#39;</span> <span class="token operator">:</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// \u56DE\u590D\u5217\u8868\u96C6\u5408\uFF08\u6BCF\u4E00\u6761\u8BC4\u8BBA\u7684\u6240\u6709\u56DE\u590D,\u4E0D\u5206\u9875\uFF09</span>
              <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Comment</span><span class="token punctuation">&gt;</span></span> replyList <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentsByEntity</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// \u56DE\u590DVO</span>
              <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> replyVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>replyList <span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Comment</span> reply <span class="token operator">:</span> replyList<span class="token punctuation">)</span><span class="token punctuation">{</span>
                      <span class="token comment">// \u56DE\u590DMap</span>
                      <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> replyVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">// \u56DE\u590D</span>
                      replyVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reply&quot;</span><span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">// \u4F5C\u8005 (\u7531comment\u8868\u4E2D entity = 2 \u67E5user\u8868)</span>
                      replyVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>reply<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">// \u56DE\u590D\u76EE\u6807 (\u67092\u79CD\uFF1A1.\u76F4\u63A5\u56DE\u590D 2.\u8FFD\u52A0\u56DE\u590D)</span>
                      <span class="token class-name">User</span> target <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>reply<span class="token punctuation">.</span><span class="token function">getTargetId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      replyVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      
                      <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
                      likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> reply<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      replyVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token comment">// \u70B9\u8D5E\u72B6\u6001 (\u6CA1\u767B\u5F55\u5C31\u663E\u793A0)</span>
                      likeStatus <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token char">&#39;0&#39;</span> <span class="token operator">:</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> reply<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      replyVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      
                      <span class="token comment">// \u5C06\u6BCF\u4E00\u4E2A\u56DE\u590DMap\u653E\u5728\u56DE\u590DList\u4E2D</span>
                      replyVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>replyVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
              <span class="token comment">// \u5C06\u6BCF\u4E00\u4E2A\u56DE\u590DList\u653E\u5728\u8BC4\u8BBAMap\u4E2D</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;replys&quot;</span><span class="token punctuation">,</span> replyVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// \u56DE\u590D\u6570\u91CF\u7EDF\u8BA1</span>
              <span class="token keyword">int</span> replyCount <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              commentVo<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;replyCount&quot;</span><span class="token punctuation">,</span> replyCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// \u518D\u5C06\u6BCF\u4E00\u4E2A\u8BC4\u8BBAMap\u653E\u5728\u8BC4\u8BBAList\u4E2D</span>
              commentVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>commentVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// \u6700\u540E\u5C06\u6574\u4E2AList\u4F20\u7ED9\u524D\u7AEFmodel\u6E32\u67D3</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;comments&quot;</span><span class="token punctuation">,</span> commentVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token string">&quot;/site/discuss-detail&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u524D\u7AEFthymeleaf\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u524D\u7AEFthymeleaf\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 4.\u7F16\u5199\u524D\u7AEFThymeleaf\u6838\u5FC3\u9875\u9762</h3><p>\u6CE8\u610F\uFF1A xxxStat\u2014&gt;Thymeleaf\u5185\u7F6E\u5BF9\u8C61</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- \u56DE\u5E16\u5217\u8868 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>media pb-3 pt-3 mb-3 border-bottom<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cvo:\${comments}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.user.getHeaderUrl()}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.user.getUsername()}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7528\u6237\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${page.offset + cvoStat.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1 \u8BC4\u8BBA\u697C\u5C42<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>#
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.comment.content}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    \u8BC4\u8BBA\u5185\u5BB9
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u53D1\u5E03\u4E8E <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(cvo.comment.createTime,&#39;yyyy-MM-dd HH:mm:sss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u65F6\u95F4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D(<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.replyCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- \u56DE\u590D\u5217\u8868 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rvo:\${cvo.replys}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--\u76F4\u63A5\u56DE\u590D--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.target==null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D\u4EBA\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--\u8FFD\u52A0\u56DE\u590D--&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.target!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D\u4EBA\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u56DE\u590D
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.target.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u88AB\u56DE\u590D\u4EBA\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.reply.content}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D\u5185\u5BB9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(rvo.reply.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D\u65F6\u95F4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8D5E(1)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--\u5173\u8054id\u5BF9\u5E94\u56DE\u590D  \u52A8\u6001\u62FC\u63A5--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|#huifu-\${rvoStat.count}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>collapse<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
      
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|huifu-\${rvoStat.count}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|\u56DE\u590D\${rvo.user.username}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">#</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>                   
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>                
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
\u6700\u540E\u590D\u7528\u5206\u9875\uFF1Ath:replace=&quot;index::pagination&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u6DFB\u52A0\u8BC4\u8BBA\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u6DFB\u52A0\u8BC4\u8BBA\u529F\u80FD" aria-hidden="true">#</a> \u6DFB\u52A0\u8BC4\u8BBA\u529F\u80FD</h2><p>(\u7528\u5230\u4E8B\u52A1\u7BA1\u7406)</p><h3 id="_1-\u7F16\u5199dao\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42-1" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42</h3><p>\uFF081.\u589E\u52A0\u8BC4\u8BBA\u6570\u636ECommentMapper 2.\u4FEE\u6539\u5E16\u5B50\u8BC4\u8BBA\u6570\u91CFDiscussPostMapper\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">//CommentMapper </span>
 <span class="token keyword">int</span> <span class="token function">insertComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">&lt;</span>insert id<span class="token operator">=</span><span class="token string">&quot;insertComment&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;Comment&quot;</span><span class="token operator">&gt;</span>
    insert into <span class="token function">comment</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;insertFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    values <span class="token punctuation">(</span>#<span class="token punctuation">{</span>userId<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>entityType<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>entityId<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>targetId<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>status<span class="token punctuation">}</span><span class="token punctuation">,</span> #<span class="token punctuation">{</span>createTime<span class="token punctuation">}</span><span class="token punctuation">)</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>insert<span class="token operator">&gt;</span>
 
 <span class="token comment">//DiscussPostMapper</span>
 <span class="token keyword">int</span> <span class="token function">updateCommentCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;commentCount&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> commentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token operator">&lt;</span>update id<span class="token operator">=</span><span class="token string">&quot;updateCommentCount&quot;</span><span class="token operator">&gt;</span>
    update discuss_post set comment_count <span class="token operator">=</span> #<span class="token punctuation">{</span>commentCount<span class="token punctuation">}</span>
    where id <span class="token operator">=</span> #<span class="token punctuation">{</span>id<span class="token punctuation">}</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>update<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199\u4E1A\u52A1service\u5C42-1" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199\u4E1A\u52A1service\u5C42-1" aria-hidden="true">#</a> 2.\u7F16\u5199\u4E1A\u52A1Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">//DiscussPostService</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updateCommentCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> commentCount<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">updateCommentCount</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> commentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
  <span class="token comment">//CommentService</span>
  <span class="token operator">/</span>
   <span class="token operator">*</span> \u6DFB\u52A0\u8BC4\u8BBA<span class="token punctuation">(</span>\u6D89\u53CA\u4E8B\u52A1<span class="token punctuation">)</span>
   <span class="token operator">*</span> \u5148\u6DFB\u52A0\u8BC4\u8BBA\uFF0C\u540E\u4FEE\u6539discuss_post\u4E2D\u7684\u8BC4\u8BBA\u6570\uFF08\u4F5C\u4E3A\u4E00\u4E2A\u6574\u4F53\u4E8B\u52A1\uFF0C\u51FA\u9519\u9700\u8981\u6574\u4F53\u56DE\u6EDA\uFF01\uFF09
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">READ_COMMITTED</span><span class="token punctuation">,</span> propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token class-name">Comment</span> comment<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>comment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">/</span>\u6DFB\u52A0\u8BC4\u8BBA<span class="token operator">/</span>
      <span class="token comment">//\u8FC7\u6EE4\u6807\u7B7E</span>
      comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8FC7\u6EE4\u654F\u611F\u8BCD</span>
      comment<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>sensitiveFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> rows <span class="token operator">=</span>commentMapper<span class="token punctuation">.</span><span class="token function">insertComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">/</span>
       <span class="token operator">*</span> \u66F4\u65B0\u5E16\u5B50\u8BC4\u8BBA\u6570\u91CF
       <span class="token operator">*</span> \u5982\u679C\u662F\u5E16\u5B50\u7C7B\u578B\u624D\u66F4\u6539\u5E16\u5B50\u8BC4\u8BBA\u6570\u91CF\uFF0C\u5E76\u4E14\u83B7\u53D6\u5E16\u5B50\u8BC4\u8BBA\u7684id
       <span class="token operator">*</span><span class="token operator">/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">int</span> count <span class="token operator">=</span> commentMapper<span class="token punctuation">.</span><span class="token function">selectCountByEntity</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          discussPostService<span class="token punctuation">.</span><span class="token function">updateCommentCount</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u5C42-2" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u5C42-2" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">//\u9700\u8981\u4ECE\u524D\u7AEF\u5E26\u4E00\u4E2A\u53C2\u6570</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/add/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Comment</span> comment<span class="token punctuation">)</span><span class="token punctuation">{</span>
      comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      comment<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      comment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      commentService<span class="token punctuation">.</span><span class="token function">addComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;redirect:/discuss/detail/&quot;</span> <span class="token operator">+</span> discussPostId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199thymleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199thymleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 4.\u7F16\u5199Thymleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--\u5E16\u5B50\u8BC4\u8BBA\u6846--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/comment/add/\${post.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u5E16\u5B50\u8BC4\u8BBA\u6846!<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${post.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u56DE\u5E16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--\u56DE\u590D\u8F93\u5165\u6846--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/comment/add/\${post.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u56DE\u590D\u8F93\u5165\u6846<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--\u56DE\u590D\u8BC4\u8BBAid\uFF0C\u5373entityType=2\u7684\u8BC4\u8BBAid--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.comment.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">#</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--\u8FFD\u52A0\u56DE\u590D\u6846--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/comment/add/\${post.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|\u56DE\u590D\${rvo.user.username}|<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityType<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.comment.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--\u56DE\u590D\u8BC4\u8BBA\u7684\u4F5C\u8005id--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>targetId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.user.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript">#</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>\u56DE\u590D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u79C1\u4FE1\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u79C1\u4FE1\u529F\u80FD" aria-hidden="true">#</a> \u79C1\u4FE1\u529F\u80FD</h2><p>\u663E\u793A\u79C1\u4FE1\u5217\u8868\uFF08\u96BE\u5EA6\u5728\u5199SQL\uFF09</p><h3 id="_1-\u7F16\u5199dao\u5C42-2" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42-2" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u67E5\u8BE2\u5F53\u524D\u7528\u6237\u7684\u4F1A\u8BDD\u5217\u8868<span class="token punctuation">,</span>\u9488\u5BF9\u6BCF\u4E2A\u4F1A\u8BDD\u53EA\u8FD4\u56DE\u4E00\u6761\u6700\u65B0\u7684\u79C1\u4FE1<span class="token operator">/</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectConversations</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span>\u67E5\u8BE2\u5F53\u524D\u7528\u6237\u7684\u4F1A\u8BDD\u6570\u91CF<span class="token operator">/</span>
  <span class="token keyword">int</span> <span class="token function">selectConversationCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span>\u67E5\u8BE2\u67D0\u4E2A\u4F1A\u8BDD\u6240\u5305\u542B\u7684\u79C1\u4FE1\u5217\u8868<span class="token operator">/</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectLetters</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;conversationId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> conversationId<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span>\u67E5\u8BE2\u67D0\u4E2A\u4F1A\u8BDD\u6240\u5305\u542B\u7684\u79C1\u4FE1\u6570\u91CF<span class="token operator">/</span>
  <span class="token keyword">int</span> <span class="token function">selectLetterCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;conversationId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">/</span>
   <span class="token operator">*</span> \u67E5\u8BE2\u672A\u8BFB\u7684\u6570\u91CF
   <span class="token operator">*</span> <span class="token number">1.</span>\u5E26\u53C2\u6570conversationId \uFF1A\u79C1\u4FE1\u672A\u8BFB\u6570\u91CF
   <span class="token operator">*</span> <span class="token number">2.</span>\u4E0D\u5E26\u53C2\u6570conversationId \uFF1A\u5F53\u524D\u767B\u5F55\u7528\u6237 \u6240\u6709\u4F1A\u8BDD\u672A\u8BFB\u6570\u91CF
   <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token keyword">int</span> <span class="token function">selectLetterUnreadCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;conversationId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199mapper-xml-\u96BE\u5EA6" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199mapper-xml-\u96BE\u5EA6" aria-hidden="true">#</a> 2.\u7F16\u5199Mapper.xml(\u96BE\u5EA6)</h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token operator">&lt;</span><span class="token keyword">sql</span> id<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span>
    id<span class="token punctuation">,</span> from_id<span class="token punctuation">,</span> to_id<span class="token punctuation">,</span> conversation_id<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span> create_time
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">sql</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectConversations&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;Message&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span> <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
    <span class="token keyword">from</span> message
    <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>
        <span class="token comment">//\u5B50\u53E5\u6839\u636Eid\u5927\u5C0F\u67E5\u4E0E\u6BCF\u4E2A\u7528\u6237\u6700\u65B0\u7684\u79C1\u4FE1\uFF08\u540C\u4E00\u4F1A\u8BDDid\u8D8A\u5927\uFF0C\u79C1\u4FE1\u8D8A\u65B0\uFF09</span>
        <span class="token comment">//\u4E5F\u53EF\u6839\u636E\u65F6\u95F4\u6233\u5224\u65AD</span>
        <span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> message
        <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
        <span class="token operator">and</span> from_id <span class="token operator">!=</span> <span class="token number">1</span>
        <span class="token operator">and</span> <span class="token punctuation">(</span>from_id <span class="token operator">=</span> <span class="token comment">#{userId} or to_id = #{userId})</span>
        <span class="token keyword">group</span> <span class="token keyword">by</span> conversation_id   <span class="token comment">//\u540C\u4E00\u4F1A\u8BDD\u53EA\u663E\u793A\u4E00\u6761</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">desc</span>
    <span class="token keyword">limit</span> <span class="token comment">#{offset}, #{limit}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectConversationCount&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>maxid<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
       <span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">as</span> maxid <span class="token keyword">from</span> message
       <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
       <span class="token operator">and</span> from_id <span class="token operator">!=</span> <span class="token number">1</span>
       <span class="token operator">and</span> <span class="token punctuation">(</span>from_id <span class="token operator">=</span> <span class="token comment">#{userId} or to_id = #{userId})</span>
       <span class="token keyword">group</span> <span class="token keyword">by</span> conversation_id
   <span class="token punctuation">)</span> <span class="token keyword">as</span> m
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectLetters&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;Message&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span> <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
    <span class="token keyword">from</span> message
    <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
    <span class="token operator">and</span> from_id <span class="token operator">!=</span> <span class="token number">1</span>
    <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{conversationId}</span>
    <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">asc</span>
    <span class="token keyword">limit</span> <span class="token comment">#{offset}, #{limit}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectLetterCount&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">from</span> message
    <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
    <span class="token operator">and</span> from_id <span class="token operator">!=</span> <span class="token number">1</span>
    <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{conversationId}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectLetterUnreadCount&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">from</span> message
    <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token operator">and</span> from_id <span class="token operator">!=</span> <span class="token number">1</span>
    <span class="token operator">and</span> to_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
    <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;conversationId!=null&quot;</span><span class="token operator">&gt;</span> <span class="token comment">//=null:\u6240\u6709\u4F1A\u8BDD\u672A\u8BFB\u6570 !=null:\u6BCF\u6761\u4F1A\u8BDD\u672A\u8BFB\u6570</span>
        <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{conversationId}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199service\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199service\u5C42" aria-hidden="true">#</a> 3.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">MessageMapper</span> messageMapper<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">findConversations</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectConversations</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findConversationCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectConversationCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">findLetters</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectLetters</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLetterCount</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectLetterCount</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findLetterUnreadCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectLetterUnreadCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199controller\u5C42-2" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199controller\u5C42-2" aria-hidden="true">#</a> 4.\u7F16\u5199Controller\u5C42</h3><h4 id="_4-1\u79C1\u4FE1\u5217\u8868controller" tabindex="-1"><a class="header-anchor" href="#_4-1\u79C1\u4FE1\u5217\u8868controller" aria-hidden="true">#</a> 4.1\u79C1\u4FE1\u5217\u8868Controller</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u79C1\u4FE1\u5217\u8868<span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/letter/list&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLetterList</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u5206\u9875\u4FE1\u606F</span>
      page<span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/letter/list&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>messageService<span class="token punctuation">.</span><span class="token function">findConversationCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u4F1A\u8BDD\u5217\u8868</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> conversationList <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findConversations</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> conversations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>conversationList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">:</span> conversationList<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u4E0E\u5F53\u524D\u767B\u5F55\u7528\u6237\u6BCF\u4E00\u6761\u4F1A\u8BDD\u7684\u6240\u6709\u4FE1\u606F</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;conversation&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u5F53\u524D\u767B\u5F55\u7528\u6237\u4E0E\u6BCF\u4E00\u4E2A\u4F1A\u8BDD\u4EBA\u7684\u79C1\u4FE1\u6761\u6570</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;letterCount&quot;</span><span class="token punctuation">,</span> messageService<span class="token punctuation">.</span><span class="token function">findLetterCount</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getConversationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u5F53\u524D\u767B\u5F55\u7528\u6237\u4E0E\u6BCF\u4E00\u4E2A\u4F1A\u8BDD\u4EBA\u7684\u672A\u8BFB\u6761\u6570</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;unreadCount&quot;</span><span class="token punctuation">,</span> messageService<span class="token punctuation">.</span><span class="token function">findLetterUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getConversationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// \u5F53\u524D\u767B\u5F55\u7528\u6237\u82E5\u4E0E\u5F53\u524D\u4F1A\u8BDD\u4FE1\u606F\u4E2DfromId\u76F8\u540C\uFF0C\u5219\u76EE\u6807id\u4E3AToId;</span>
              <span class="token keyword">int</span> targetId <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> message<span class="token punctuation">.</span><span class="token function">getToId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">User</span> target <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
              
              conversations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;conversations&quot;</span><span class="token punctuation">,</span> conversations<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u5F53\u524D\u767B\u5F55\u7528\u6237\u603B\u672A\u8BFB\u6761\u6570</span>
      <span class="token keyword">int</span> letterUnreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLetterUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;letterUnreadCount&quot;</span><span class="token punctuation">,</span> letterUnreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token string">&quot;/site/letter&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2\u79C1\u4FE1\u8BE6\u60C5controller" tabindex="-1"><a class="header-anchor" href="#_4-2\u79C1\u4FE1\u8BE6\u60C5controller" aria-hidden="true">#</a> 4.2\u79C1\u4FE1\u8BE6\u60C5Controller</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u79C1\u4FE1\u8BE6\u60C5<span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/letter/detail/{conversationId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLetterDetail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;conversationId&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u5206\u9875\u4FE1\u606F</span>
      page<span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/letter/detail/&quot;</span><span class="token operator">+</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>messageService<span class="token punctuation">.</span><span class="token function">findLetterCount</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">//\u83B7\u53D6\u79C1\u4FE1\u4FE1\u606F</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> letterlist <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLetters</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> letters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>letterlist <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">:</span> letterlist<span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//map\u5C01\u88C5\u6BCF\u6761\u79C1\u4FE1</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;letter&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;fromUser&quot;</span><span class="token punctuation">,</span>userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              letters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;letters&quot;</span><span class="token punctuation">,</span>letters<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u79C1\u4FE1\u76EE\u6807</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token function">getLetterTarget</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">&quot;/site/letter-detail&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">/</span>\u5C01\u88C5\u83B7\u53D6\u76EE\u6807\u4F1A\u8BDD\u7528\u6237<span class="token punctuation">(</span>\u5C06\u5982\uFF1A<span class="token number">101_107</span>\u62C6\u5F00<span class="token punctuation">)</span> <span class="token operator">/</span>
  <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">getLetterTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> conversationId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ids <span class="token operator">=</span> conversationId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; _&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> id0 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>ids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> id1 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>ids<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> id0<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>id1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>id0<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199thymeleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199thymeleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 5.\u7F16\u5199Thymeleaf\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><h4 id="_5-1\u79C1\u4FE1\u5217\u8868\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-1\u79C1\u4FE1\u5217\u8868\u9875\u9762" aria-hidden="true">#</a> 5.1\u79C1\u4FE1\u5217\u8868\u9875\u9762</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/letter/list}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  \u670B\u53CB\u79C1\u4FE1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${letterUnreadCount}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${letterUnreadCount!=0}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u603B\u79C1\u4FE1\u672A\u8BFB\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${conversations}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.unreadCount}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.unreadCount!=0}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5355\u4E2A\u4F1A\u8BDD\u672A\u8BFB\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/profile}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.target.headerUrl}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.target.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4F1A\u8BDD\u76EE\u6807\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.conversation.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4F1A\u8BDD\u6700\u65B0\u65F6\u95F4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/letter/detail/\${map.conversation.conversationId}|}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.conversation.content}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4F1A\u8BDD\u5185\u5BB9\uFF0C\u53EF\u8FDB\u5165\u8BE6\u60C5\u9875<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5171<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.letterCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>\u6761\u4F1A\u8BDD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2\u79C1\u4FE1\u8BE6\u60C5\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-2\u79C1\u4FE1\u8BE6\u60C5\u9875\u9762" aria-hidden="true">#</a> 5.2\u79C1\u4FE1\u8BE6\u60C5\u9875\u9762</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>\u6765\u81EA <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${target.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u76EE\u6807\u4F1A\u8BDD\u7528\u6237<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u7684\u79C1\u4FE1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${letters}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.fromUser.headerUrl}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.fromUser.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u4F1A\u8BDD\u53D1\u8D77\u4EBA\u59D3\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.letter.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u65F6\u95F4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.letter.content}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   \u79C1\u4FE1\u5185\u5BB9
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u53D1\u9001\u79C1\u4FE1\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u53D1\u9001\u79C1\u4FE1\u529F\u80FD" aria-hidden="true">#</a> \u53D1\u9001\u79C1\u4FE1\u529F\u80FD</h2><p>(\u5F02\u6B65)</p><h3 id="_1-\u7F16\u5199dao\u5C42-3" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42-3" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42</h3><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>  <span class="token operator">/</span>\u63D2\u5165\u4F1A\u8BDD<span class="token operator">/</span>
  <span class="token keyword">int</span> insertMessage<span class="token punctuation">(</span>Message message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">/</span>\u6279\u91CF\u66F4\u6539\u6BCF\u4E2A\u4F1A\u8BDD\u7684\u6240\u6709\u672A\u8BFB\u6D88\u606F\u4E3A\u5DF2\u8BFB<span class="token operator">/</span>
  <span class="token keyword">int</span> updateStatus<span class="token punctuation">(</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> List<span class="token operator">&lt;</span><span class="token keyword">Integer</span><span class="token operator">&gt;</span> ids<span class="token punctuation">,</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">-----------------------Mapper.xml-----------------------------</span>
  <span class="token operator">&lt;</span><span class="token keyword">insert</span> id<span class="token operator">=</span><span class="token string">&quot;insertMessage&quot;</span> parameterType<span class="token operator">=</span><span class="token string">&quot;Message&quot;</span> keyProperty<span class="token operator">=</span><span class="token string">&quot;id&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">insert</span> <span class="token keyword">into</span> message<span class="token punctuation">(</span><span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;insertFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token comment">#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime})</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">insert</span><span class="token operator">&gt;</span>
  
  <span class="token operator">&lt;</span><span class="token keyword">update</span> id<span class="token operator">=</span><span class="token string">&quot;updateStatus&quot;</span><span class="token operator">&gt;</span>
      <span class="token keyword">update</span> message <span class="token keyword">set</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token comment">#{status}</span>
      <span class="token keyword">where</span> id <span class="token operator">in</span>
      <span class="token comment">-----\u6279\u91CF\u4F20\u5165id\u5199\u6CD5</span>
      <span class="token operator">&lt;</span>foreach collection<span class="token operator">=</span><span class="token string">&quot;ids&quot;</span> item<span class="token operator">=</span><span class="token string">&quot;id&quot;</span> <span class="token keyword">open</span><span class="token operator">=</span><span class="token string">&quot;(&quot;</span> separator<span class="token operator">=</span><span class="token string">&quot;,&quot;</span> <span class="token keyword">close</span><span class="token operator">=</span><span class="token string">&quot;)&quot;</span><span class="token operator">&gt;</span>
          <span class="token comment">#{id}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>foreach<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">&gt;</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42-4" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42-4" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u8F6C\u4E49\u6807\u7B7E</span>
      message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlEscape</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//\u8FC7\u6EE4\u654F\u611F\u8BCD</span>
      message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>sensitiveFilter<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">insertMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">readMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>ids<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u5C42-3" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u5C42-3" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u5C42</h3><h4 id="_3-1\u8BBE\u7F6E\u5DF2\u8BFB" tabindex="-1"><a class="header-anchor" href="#_3-1\u8BBE\u7F6E\u5DF2\u8BFB" aria-hidden="true">#</a> 3.1\u8BBE\u7F6E\u5DF2\u8BFB</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/letter/detail/{conversationId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLetterDetail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;conversationId&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> conversationId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">/</span>
        <span class="token operator">*</span> \u4EE5\u4E0A\u7701\u7565\u3002\u3002\u3002\u3002\u3002\u3002
        <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token comment">//\u8BBE\u7F6E\u5DF2\u8BFB(\u5F53\u6253\u5F00\u8FD9\u4E2A\u9875\u9762\u662F\u5C31\u66F4\u6539status =1)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token function">getLetterIds</span><span class="token punctuation">(</span>letterlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ids<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageService<span class="token punctuation">.</span><span class="token function">readMessage</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

  <span class="token operator">/</span>\u83B7\u5F97\u6279\u91CF\u79C1\u4FE1\u7684\u672A\u8BFB\u6570id<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLetterIds</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> letterList<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>letterList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> message <span class="token operator">:</span> letterList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">//\u53EA\u6709\u5F53\u524D\u767B\u5F55\u7528\u6237\u4E0Emessage\u5217\u8868\u4E2D\u76EE\u6807\u7528\u6237\u4E00\u81F4\u5E76\u4E14staus = 0 \u65F6\u624D\u662F\u672A\u8BFB\u6570\uFF0C\u52A0\u5165\u672A\u8BFB\u79C1\u4FE1\u96C6\u5408</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> message<span class="token punctuation">.</span><span class="token function">getToId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  ids<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> ids<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-\u53D1\u9001\u79C1\u4FE1" tabindex="-1"><a class="header-anchor" href="#_3-2-\u53D1\u9001\u79C1\u4FE1" aria-hidden="true">#</a> 3.2 \u53D1\u9001\u79C1\u4FE1</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span>\u53D1\u9001\u79C1\u4FE1<span class="token operator">*</span> <span class="token operator">*</span><span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/letter/send&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ResponseBody</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendLetter</span><span class="token punctuation">(</span><span class="token class-name">String</span> toName<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">//\u6839\u636E\u76EE\u6807\u53D1\u9001\u4EBA\u59D3\u540D\u83B7\u53D6\u5176id</span>
      <span class="token class-name">User</span> target <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserByName</span><span class="token punctuation">(</span>toName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;\u76EE\u6807\u7528\u6237\u4E0D\u5B58\u5728!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">//\u8BBE\u7F6Emessage\u5C5E\u6027</span>
      <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setFromId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setToId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
      message<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// conversationId (\u5982101_102: \u5C0F_\u5927)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> message<span class="token punctuation">.</span><span class="token function">getToId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          message<span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; _&quot;</span> <span class="token operator">+</span>message<span class="token punctuation">.</span><span class="token function">getToId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          message<span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getToId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span>message<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      messageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u524D\u7AEFjs\u5F02\u6B65\u8BF7\u6C42-ajax" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u524D\u7AEFjs\u5F02\u6B65\u8BF7\u6C42-ajax" aria-hidden="true">#</a> 4.\u7F16\u5199\u524D\u7AEFJS\u5F02\u6B65\u8BF7\u6C42\uFF08ajax\uFF09</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">send_letter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#sendModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//\u82E5\u7528JS\u5F02\u6B65\u8BF7\u6C42\uFF0C\u524D\u7AEF\u53C2\u6570\u4E0D\u7528name= &quot;xxx&quot;,\u7528\u5982\u4E0B\u65B9\u6CD5</span>
  <span class="token keyword">var</span> toName <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#recipient-name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#message-text&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
    <span class="token comment">// \u63A5\u53E3\u8DEF\u5F84(\u4E0E@RequestMapping(value = &quot;/letter/send&quot;, method = RequestMethod.POST)\u8DEF\u5F84\u4E00\u81F4)</span>
    <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/letter/send&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// \u63A5\u53E3\u53C2\u6570(\u4E0Epublic String sendLetter(String toName, String content)\u53C2\u6570\u4E00\u81F4)</span>
    <span class="token punctuation">{</span><span class="token string-property property">&quot;toName&quot;</span><span class="token operator">:</span>toName<span class="token punctuation">,</span> <span class="token string-property property">&quot;content&quot;</span><span class="token operator">:</span>content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u628A{&quot;toName&quot;:toName, &quot;content&quot;:content}\u8F6C\u6362\u6210JS\u5BF9\u8C61</span>
      data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u4E0ECommunityUtil.getJSONString(0,&quot;msg&quot;)\u5339\u914D--0\uFF1A\u6210\u529F</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintBody&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;\u53D1\u9001\u6210\u529F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintBody&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;show&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#hintModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5237\u65B0\u9875\u9762</span>
        location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u70B9\u8D5E\u529F\u80FD-redis-\u5F02\u6B65ajax" tabindex="-1"><a class="header-anchor" href="#\u70B9\u8D5E\u529F\u80FD-redis-\u5F02\u6B65ajax" aria-hidden="true">#</a> \u70B9\u8D5E\u529F\u80FD\uFF08Redis+\u5F02\u6B65ajax\uFF09</h1><h2 id="\u70B9\u8D5E\u3001\u53D6\u6D88\u70B9\u8D5E" tabindex="-1"><a class="header-anchor" href="#\u70B9\u8D5E\u3001\u53D6\u6D88\u70B9\u8D5E" aria-hidden="true">#</a> \u70B9\u8D5E\u3001\u53D6\u6D88\u70B9\u8D5E</h2><p>\u6CE8\u610F\uFF1A</p><ol><li>\u5F15\u5165pom,\u914D\u7F6EYaml</li><li>\u56E0\u4E3A\u8BBF\u95EE\u7684\u662FRedis\uFF0C\u65E0\u9700\u7F16\u5199Dao\u5C42</li></ol><h3 id="_1-\u521B\u5EFArediskeyutil\u5DE5\u5177\u7C7B" tabindex="-1"><a class="header-anchor" href="#_1-\u521B\u5EFArediskeyutil\u5DE5\u5177\u7C7B" aria-hidden="true">#</a> 1.\u521B\u5EFARedisKeyUtil\u5DE5\u5177\u7C7B</h3><p>(\u7EDF\u4E00\u683C\u5F0F\u5316redis\u7684key)</p><p>k:v = like:entity:entityType:entityId -&gt; set(userId)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPLIT</span> <span class="token operator">=</span> <span class="token string">&quot;:&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_ENTITY_LIKE</span> <span class="token operator">=</span> <span class="token string">&quot;like:entity&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_USER_LIKE</span> <span class="token operator">=</span> <span class="token string">&quot;like:user&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
    <span class="token operator">*</span> \u67D0\u4E2A\u5B9E\u4F53\u7684\u8D5E
    <span class="token operator">*</span> key<span class="token operator">=</span> like<span class="token operator">:</span>entity<span class="token operator">:</span>entityType<span class="token operator">:</span>entityId <span class="token operator">-&gt;</span> value<span class="token operator">=</span> userId
    <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getEntityLikeKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_ENTITY_LIKE</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> entityType <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> entityId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u76F4\u63A5\u7F16\u5199service\u4E1A\u52A1\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u76F4\u63A5\u7F16\u5199service\u4E1A\u52A1\u5C42" aria-hidden="true">#</a> 2.\u76F4\u63A5\u7F16\u5199Service\u4E1A\u52A1\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">// \u70B9\u8D5E (\u8BB0\u5F55\u8C01\u70B9\u4E86\u54EA\u4E2A\u7C7B\u578B\u54EA\u4E2A\u7559\u8A00/\u5E16\u5B50id)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> entityLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getEntityLikeKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//\u5224\u65ADlike:entity:entityType:entityId \u662F\u5426\u6709\u5BF9\u5E94\u7684 userId</span>
        <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u7B2C\u4E00\u6B21\u70B9\u8D5E\uFF0C\u7B2C\u4E8C\u6B21\u53D6\u6D88\u70B9\u8D5E</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isMember<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// \u82E5\u5DF2\u88AB\u70B9\u8D5E(\u5373entityLikeKey\u91CC\u9762\u6709userId)\u5219\u53D6\u6D88\u70B9\u8D5E-&gt;\u5C06userId\u4ECE\u4E2D\u79FB\u9664</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u67E5\u8BE2\u67D0\u5B9E\u4F53(\u5E16\u5B50\u3001\u7559\u8A00)\u70B9\u8D5E\u7684\u6570\u91CF --&gt; scard like:entity:1:110</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> entityLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getEntityLikeKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u663E\u793A\u67D0\u4EBA\u5BF9\u67D0\u5B9E\u4F53\u7684\u70B9\u8D5E\u72B6\u6001</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> entityLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getEntityLikeKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1\uFF1A\u5DF2\u70B9\u8D5E , 0\uFF1A\u8D5E</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199\u70B9\u8D5Econtroller\u5C42\u63A5\u53E3-\u5F02\u6B65" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199\u70B9\u8D5Econtroller\u5C42\u63A5\u53E3-\u5F02\u6B65" aria-hidden="true">#</a> 3.\u7F16\u5199\u70B9\u8D5EController\u5C42\u63A5\u53E3\uFF08\u5F02\u6B65\uFF09</h3><p>\u8FD4\u56DE\uFF1ACommunityUtil.getJSONString(0,null, map) \u2014&gt;\u5BF9\u5E94\u54CD\u5E94\u7684js\u7684ajax</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LikeController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E</span>
        likeService<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType <span class="token punctuation">,</span>entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5BF9\u5E94\u5E16\u5B50\u3001\u7559\u8A00\u7684\u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237\u70B9\u8D5E\u72B6\u6001\uFF081\uFF1A\u5DF2\u70B9\u8D5E 0\uFF1A\u8D5E\uFF09</span>
        <span class="token keyword">int</span> likeStatus <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5C01\u88C5\u7ED3\u679C\u5230Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199\u5F02\u6B65js" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199\u5F02\u6B65js" aria-hidden="true">#</a> 4.\u7F16\u5199\u5F02\u6B65js</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// btn --&gt;\u5BF9\u5E94this</span>
<span class="token keyword">function</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&quot;entityType&quot;</span><span class="token operator">:</span>entityType<span class="token punctuation">,</span><span class="token string-property property">&quot;entityId&quot;</span><span class="token operator">:</span>entityId<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>likeStatus<span class="token operator">==</span><span class="token number">1</span><span class="token operator">?</span><span class="token string">&#39;\u5DF2\u8D5E&#39;</span><span class="token operator">:</span><span class="token string">&quot;\u8D5E&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u524D\u7AEF\u2014\u8BE6\u60C5\u9875\u70B9\u8D5E\u6570\u91CF" tabindex="-1"><a class="header-anchor" href="#_5-\u524D\u7AEF\u2014\u8BE6\u60C5\u9875\u70B9\u8D5E\u6570\u91CF" aria-hidden="true">#</a> 5.\u524D\u7AEF\u2014\u8BE6\u60C5\u9875\u70B9\u8D5E\u6570\u91CF</h3><p>\u5BF9\u5E94\u7684Controll\u5C42\uFF0C\u663E\u793A\u70B9\u8D5E\u5728\u4E3B\u9875Controller\u5C42\u53CA*\\ *\u663E\u793A\u8BC4\u8BBA\u529F\u80FDController\u5C42</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!--\u5F15\u5165Js--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/js/discuss.js}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!---href=&quot;javascript:;&quot;\u5F03\u7528href\u4F7F\u7528onclick\u6309\u94AE
   th:onclick=&quot;|like(this,1,\${post.id})|&quot;, this\u6307\u4EE3\u5F53\u524D\u6309\u94AE,1\u6307\u4EE3\u5E16\u5B50\u7C7B\u578B---&gt;</span>
  <span class="token comment">&lt;!--\u5E16\u5B50\u70B9\u8D5E--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|like(this,1,\${post.id});|<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeStatus==1?&#39;\u5DF2\u8D5E&#39;:&#39;\u8D5E&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8D5E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!--\u8BC4\u8BBA\u70B9\u8D5E--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|like(this,2,\${cvo.comment.id});|<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.likeStatus==1?&#39;\u5DF2\u8D5E&#39;:&#39;\u8D5E&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8D5E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>(<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${cvo.likeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>)
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!--\u56DE\u590D\u70B9\u8D5E--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>javascript:;<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|like(this,2,\${rvo.reply.id});|<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.likeStatus==1?&#39;\u5DF2\u8D5E&#39;:&#39;\u8D5E&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8D5E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>(<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${rvo.likeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>)
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u6211\u6536\u5230\u7684\u8D5E" tabindex="-1"><a class="header-anchor" href="#\u6211\u6536\u5230\u7684\u8D5E" aria-hidden="true">#</a> \u6211\u6536\u5230\u7684\u8D5E</h2><p>\uFF08\u57FA\u4E8E\u70B9\u8D5E\u57FA\u7840\u4E0A\u4FEE\u6539\uFF09</p><p>\u6CE8\u610F\uFF1A</p><ol><li>\u4EE5\u7528\u6237\u4E3Akey, \u8BB0\u5F55\u70B9\u8D5E\u6570\u91CF</li><li>opsForValue.increment(key) /decrement(key)</li></ol><h3 id="_1-\u5728\u5DE5\u5177\u7C7Brediskeyutil\u6DFB\u52A0\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_1-\u5728\u5DE5\u5177\u7C7Brediskeyutil\u6DFB\u52A0\u65B9\u6CD5" aria-hidden="true">#</a> 1.\u5728\u5DE5\u5177\u7C7BRedisKeyUtil\u6DFB\u52A0\u65B9\u6CD5</h3><p>k:v = like:user:userId -&gt; set(int)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_USER_LIKE</span> <span class="token operator">=</span> <span class="token string">&quot;like:user&quot;</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u67D0\u4E2A\u7528\u6237\u7684\u8D5E
     <span class="token operator">*</span> like<span class="token operator">:</span>user<span class="token operator">:</span>userId <span class="token operator">-&gt;</span> <span class="token keyword">int</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUserLikeKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_USER_LIKE</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u4FEE\u6539service\u4E1A\u52A1\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u4FEE\u6539service\u4E1A\u52A1\u5C42" aria-hidden="true">#</a> 2.\u4FEE\u6539Service\u4E1A\u52A1\u5C42</h3><p>\uFF08\u6DFB\u52A0entityUserId\u5C5E\u6027\uFF0C\u4E8B\u52A1\u548C\u67E5\u8BE2\u83B7\u7528\u6237\u8D5E\u4E2A\u6570\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

  <span class="token comment">// \u70B9\u8D5E (\u8BB0\u5F55\u8C01\u70B9\u4E86\u54EA\u4E2A\u7C7B\u578B\u54EA\u4E2A\u7559\u8A00/\u5E16\u5B50id)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token operator">/</span>\u56E0\u4E3A\u8981\u7528\u5230\u4E24\u4E2Aredis\u64CD\u4F5C\uFF0C\u9700\u4F7F\u7528\u4E8B\u52A1<span class="token operator">/</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span> redisOperations<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
              <span class="token class-name">String</span> entityLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getEntityLikeKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">String</span> userLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserLikeKey</span><span class="token punctuation">(</span>entityUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">//\u5224\u65ADlike:entity:entityType:entityId \u662F\u5426\u6709\u5BF9\u5E94\u7684 userId</span>
              <span class="token class-name">Boolean</span> isMember <span class="token operator">=</span> redisOperations<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMember</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token comment">// \u5148\u67E5\u518D\u5F00\u542F\u4E8B\u52A1</span>
              redisOperations<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>isMember<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// \u82E5\u5DF2\u88AB\u70B9\u8D5E(\u5373entityLikeKey\u91CC\u9762\u6709userId)\u5219\u53D6\u6D88\u70B9\u8D5E-&gt;\u5C06userId\u4ECE\u4E2D\u79FB\u9664</span>
                  redisOperations<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">// \u8BE5\u5E16\u5B50\u7684\u7528\u6237\u6536\u5230\u7684\u70B9\u8D5E-1</span>
                  redisOperations<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span>userLikeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                  redisOperations<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>entityLikeKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  redisOperations<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>userLikeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>

              <span class="token keyword">return</span> redisOperations<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u67E5\u8BE2\u67D0\u4E2A\u7528\u6237\u83B7\u5F97\u7684\u8D5E</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findUserLikeCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userLikeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserLikeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6CE8\u610F\u8FD9\u91CCInteget\u5C01\u88C5\u7C7B\u578B\uFF01\uFF01\uFF01\uFF01</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userLikeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> count <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> count<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u4FEE\u6539likecontroller\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u4FEE\u6539likecontroller\u5C42" aria-hidden="true">#</a> 3.\u4FEE\u6539LikeController\u5C42</h3><p>\uFF08\u6DFB\u52A0entityUserId\u5C5E\u6027\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E</span>
        likeService<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">,</span> entityUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5BF9\u5E94\u5E16\u5B50\u3001\u7559\u8A00\u7684\u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237\u70B9\u8D5E\u72B6\u6001\uFF081\uFF1A\u5DF2\u70B9\u8D5E 0\uFF1A\u8D5E\uFF09</span>
        <span class="token keyword">int</span> likeStatus <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5C01\u88C5\u7ED3\u679C\u5230Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u540C\u6837\u5728js\u6DFB\u52A0entityuserid\u5C5E\u6027" tabindex="-1"><a class="header-anchor" href="#_4-\u540C\u6837\u5728js\u6DFB\u52A0entityuserid\u5C5E\u6027" aria-hidden="true">#</a> 4.\u540C\u6837\u5728JS\u6DFB\u52A0entityUserId\u5C5E\u6027</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">,</span> entityUserId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&quot;entityType&quot;</span><span class="token operator">:</span>entityType<span class="token punctuation">,</span><span class="token string-property property">&quot;entityId&quot;</span><span class="token operator">:</span>entityId<span class="token punctuation">,</span><span class="token string-property property">&quot;entityUserId&quot;</span><span class="token operator">:</span>entityUserId<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>likeStatus<span class="token operator">==</span><span class="token number">1</span><span class="token operator">?</span><span class="token string">&#39;\u5DF2\u8D5E&#39;</span><span class="token operator">:</span><span class="token string">&quot;\u8D5E&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199\u4E2A\u4EBA\u4E3B\u9875usercontroller\u5C42" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199\u4E2A\u4EBA\u4E3B\u9875usercontroller\u5C42" aria-hidden="true">#</a> 5.\u7F16\u5199\u4E2A\u4EBA\u4E3B\u9875UserController\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u4E2A\u4EBA\u4E3B\u9875
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/profile/{userId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProfilePage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u7528\u6237\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8FDB\u5165\u67D0\u7528\u6237\u4E3B\u9875\u83B7\u53D6\u4ED6(\u6211)\u7684\u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">int</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findUserLikeCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/profile&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-\u7F16\u5199\u524D\u7AEF\u4E2A\u4EBA\u4E3B\u9875-\u6838\u5FC3\u90E8\u5206" tabindex="-1"><a class="header-anchor" href="#_6-\u7F16\u5199\u524D\u7AEF\u4E2A\u4EBA\u4E3B\u9875-\u6838\u5FC3\u90E8\u5206" aria-hidden="true">#</a> 6.\u7F16\u5199\u524D\u7AEF\u4E2A\u4EBA\u4E3B\u9875\uFF08\u6838\u5FC3\u90E8\u5206\uFF09</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u83B7\u5F97\u4E86 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>87<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u4E2A\u8D5E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/user/profile/\${map.user.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  \u70B9\u51FB\u5934\u50CF\u8FDB\u5165\u67D0\u7528\u6237\u4E3B\u9875
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u5173\u6CE8\u529F\u80FD-redis-\u5F02\u6B65ajax" tabindex="-1"><a class="header-anchor" href="#\u5173\u6CE8\u529F\u80FD-redis-\u5F02\u6B65ajax" aria-hidden="true">#</a> \u5173\u6CE8\u529F\u80FD\uFF08Redis+\u5F02\u6B65ajax\uFF09</h1><h2 id="\u5173\u6CE8\u3001\u53D6\u6D88\u5173\u6CE8" tabindex="-1"><a class="header-anchor" href="#\u5173\u6CE8\u3001\u53D6\u6D88\u5173\u6CE8" aria-hidden="true">#</a> \u5173\u6CE8\u3001\u53D6\u6D88\u5173\u6CE8</h2><h3 id="_1-\u7F16\u5199\u5DE5\u5177\u7C7Brediskeyutil\u7EDF\u4E00\u5173\u6CE8redis\u7684key" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199\u5DE5\u5177\u7C7Brediskeyutil\u7EDF\u4E00\u5173\u6CE8redis\u7684key" aria-hidden="true">#</a> 1.\u7F16\u5199\u5DE5\u5177\u7C7BRedisKeyUtil\u7EDF\u4E00\u5173\u6CE8Redis\u7684key</h3><p>\u5173\u6CE8\uFF1Ak:v = followee:userId:entityType --&gt; zset(entityId, date)</p><p>\u7C89\u4E1D\uFF1Ak:v = follower:entityType:entityId --&gt;zset(userId, date)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisKeyUtil</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5173\u6CE8</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_FOLLOWEE</span> <span class="token operator">=</span> <span class="token string">&quot;followee&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// \u7C89\u4E1D</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_FOLLOWER</span> <span class="token operator">=</span> <span class="token string">&quot;follower&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u67D0\u4E2A\u7528\u6237\u5173\u6CE8\u7684\u5B9E\u4F53<span class="token punctuation">(</span>\u7528\u6237\uFF0C\u5E16\u5B50<span class="token punctuation">)</span>
     <span class="token operator">*</span> followee<span class="token operator">:</span>userId<span class="token operator">:</span>entityType <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token function">zset</span><span class="token punctuation">(</span>entityId<span class="token punctuation">,</span> date<span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFolloweeKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_FOLLOWEE</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> entityType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u67D0\u4E2A\u5B9E\u4F53\u62E5\u6709\u7684\u7C89\u4E1D
     <span class="token operator">*</span> follower<span class="token operator">:</span>entityType<span class="token operator">:</span>entityId <span class="token operator">--</span><span class="token operator">&gt;</span><span class="token function">zset</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> date<span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFollowerKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_FOLLOWER</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span>entityType <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span>entityId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u5C42\u4E1A\u52A1" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u5C42\u4E1A\u52A1" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u5C42\u4E1A\u52A1</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token operator">/</span>\u5173\u6CE8<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span> redisOperations<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> followeeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFolloweeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> followerKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFollowerKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// \u5F00\u542F\u4E8B\u52A1</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">/</span>
                 <span class="token operator">*</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>\u7528\u4E8E\u83B7\u53D6\u5F53\u524D\u7CFB\u7EDF\u65F6\u95F4<span class="token punctuation">,</span>\u4EE5\u6BEB\u79D2\u4E3A\u5355\u4F4D
                 <span class="token operator">*</span> \u5173\u6CE8\u65F6\uFF0C\u9996\u5148\u5C06\u5B9E\u4F53<span class="token punctuation">(</span>\u7528\u6237\u6216\u5E16\u5B50<span class="token punctuation">)</span>id\u6DFB\u52A0\u7528\u6237\u5173\u6CE8\u7684\u96C6\u5408\u4E2D\uFF0C\u518D\u5C06\u7528\u6237id\u6DFB\u52A0\u8FDB\u5B9E\u4F53\u7C89\u4E1D\u7684\u96C6\u5408\u4E2D
                 <span class="token operator">*</span><span class="token operator">/</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">,</span> entityId<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>followerKey<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> redisOperations<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u53D6\u6D88\u5173\u6CE8<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unfollow</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisOperations</span> redisOperations<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> followeeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFolloweeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> followerKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFollowerKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5F00\u542F\u4E8B\u52A1</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">/</span>\u5173\u6CE8\u65F6\uFF0C\u9996\u5148\u5C06\u5B9E\u4F53<span class="token punctuation">(</span>\u7528\u6237\u6216\u5E16\u5B50<span class="token punctuation">)</span>id\u79FB\u9664\u7528\u6237\u5173\u6CE8\u7684\u96C6\u5408\u4E2D\uFF0C\u518D\u5C06\u7528\u6237id\u79FB\u9664\u8FDB\u5B9E\u4F53\u7C89\u4E1D\u7684\u96C6\u5408\u4E2D<span class="token operator">/</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                redisOperations<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>followerKey<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> redisOperations<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u67E5\u8BE2\u5173\u6CE8\u7684\u5B9E\u4F53<span class="token punctuation">(</span>\u7528\u6237<span class="token punctuation">)</span>\u6570\u91CF<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">findFolloweeCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> followeeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFolloweeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// opsForZSet().zCard\u83B7\u53D6\u6709\u5E8F\u96C6\u5408\u4E2D\u7684\u6570\u91CF</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zCard</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u67E5\u8BE2\u7C89\u4E1D\u7684\u5B9E\u4F53\u6570\u91CF<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">findFollowerCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> followerKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFollowerKey</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">zCard</span><span class="token punctuation">(</span>followerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u67E5\u8BE2\u5F53\u524D\u7528\u6237\u662F\u5426\u5DF2\u5173\u6CE8\u8BE5\u5B9E\u4F53<span class="token operator">/</span>
    <span class="token comment">// userId-&gt;\u5F53\u524D\u767B\u5F55\u7528\u6237  entityType-&gt;\u7528\u6237\u7C7B\u578B entityId-&gt;\u5173\u6CE8\u7684\u7528\u6237id</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasFollowed</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> followeeKey <span class="token operator">=</span><span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFolloweeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> entityType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> <span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>score \u83B7\u53D6\u6709\u5E8F\u96C6\u5408\u4E2D\u6307\u5B9A\u5143\u7D20\u6743\u91CD\u5206\u6570  followee<span class="token operator">:</span>userId<span class="token operator">:</span>entityType <span class="token operator">=</span> entityId\u7684\u5206\u6570\uFF08\u8FD9\u91CC\u662F\u65F6\u95F4\uFF09
         <span class="token operator">*</span> \u82E5\u6709\u65F6\u95F4\uFF0C\u5219\u8868\u660E\u5DF2\u5173\u6CE8\uFF1B
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199controller\u5C42-4" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199controller\u5C42-4" aria-hidden="true">#</a> 3.\u7F16\u5199Controller\u5C42</h3><h4 id="_3-1\u5173\u6CE8\u4E0E\u53D6\u6D88\u5173\u6CE8\u6309\u94AE\u7684\u5B9E\u73B0-followcontroller" tabindex="-1"><a class="header-anchor" href="#_3-1\u5173\u6CE8\u4E0E\u53D6\u6D88\u5173\u6CE8\u6309\u94AE\u7684\u5B9E\u73B0-followcontroller" aria-hidden="true">#</a> 3.1\u5173\u6CE8\u4E0E\u53D6\u6D88\u5173\u6CE8\u6309\u94AE\u7684\u5B9E\u73B0\uFF08FollowController\uFF09</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>\u5173\u6CE8<span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/follow&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span> <span class="token comment">// \u5173\u6CE8\u662F\u5F02\u6B65\u8BF7\u6C42</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        followService<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;\u5DF2\u5173\u6CE8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u53D6\u6D88\u5173\u6CE8<span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/unfollow&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span> <span class="token comment">// \u5173\u6CE8\u662F\u5F02\u6B65\u8BF7\u6C42</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">unfollow</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        followService<span class="token punctuation">.</span><span class="token function">unfollow</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;\u5DF2\u53D6\u6D88\u5173\u6CE8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2\u4E3B\u9875\u4E2D\u663E\u793A\u5173\u6CE8\u6570\u91CF-\u7C89\u4E1D\u6570\u91CF-usercontroller" tabindex="-1"><a class="header-anchor" href="#_3-2\u4E3B\u9875\u4E2D\u663E\u793A\u5173\u6CE8\u6570\u91CF-\u7C89\u4E1D\u6570\u91CF-usercontroller" aria-hidden="true">#</a> 3.2\u4E3B\u9875\u4E2D\u663E\u793A\u5173\u6CE8\u6570\u91CF\uFF0C\u7C89\u4E1D\u6570\u91CF\uFF08UserController\uFF09</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u4E2A\u4EBA\u4E3B\u9875
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/profile/{userId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getProfilePage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u7528\u6237\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// \u5173\u6CE8\u6570\u91CF(\u8FD9\u91CC\u53EA\u8003\u8651\u5173\u6CE8\u7528\u6237\u7C7B\u578B\u7684\u60C5\u51B5)</span>
        <span class="token keyword">long</span> followeeCount <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">findFolloweeCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;followeeCount&quot;</span><span class="token punctuation">,</span> followeeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u7C89\u4E1D\u6570\u91CF</span>
        <span class="token keyword">long</span> followerCount <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">findFollowerCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;followerCount&quot;</span><span class="token punctuation">,</span> followerCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u662F\u5426\u5DF2\u5173\u6CE8 (\u5FC5\u987B\u662F\u7528\u6237\u767B\u5F55\u7684\u60C5\u51B5)</span>
        <span class="token keyword">boolean</span> hasFollowed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hasFollowed <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">hasFollowed</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;hasFollowed&quot;</span><span class="token punctuation">,</span> hasFollowed<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/profile&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199js\u5F02\u6B65\u8BF7\u6C42\u548C\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199js\u5F02\u6B65\u8BF7\u6C42\u548C\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 4.\u7F16\u5199JS\u5F02\u6B65\u8BF7\u6C42\u548C\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;.follow-btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> btn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasClass</span><span class="token punctuation">(</span><span class="token string">&quot;btn-info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u5173\u6CE8TA</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/follow&quot;</span><span class="token punctuation">,</span>
      <span class="token comment">// &quot;entityId&quot;:$(btn).prev().val() \u83B7\u53D6btn\u6309\u94AE\u4E0A\u4E00\u4E2A\u7684\u503C</span>
      <span class="token punctuation">{</span><span class="token string-property property">&quot;entityType&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string-property property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u53D6\u6D88\u5173\u6CE8</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/unfollow&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string-property property">&quot;entityType&quot;</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string-property property">&quot;entityId&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${user.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              <span class="token comment">&lt;!-- hasFollowed\u4E3Atrue:\u5DF2\u5173\u6CE8 -&gt;\u6309\u94AE\u53D8\u7070 \uFF0Cfalse:\u672A\u5173\u6CE8 -&gt;\u6309\u94AE\u53D8\u84DD  --&gt;</span>
&lt;button type=&quot;button&quot; th:class=&quot;|btn \${hasFollowed?&#39;btn-secondary&#39;:&#39;btn-info&#39;} btn-sm float-right mr-5 follow-btn|&quot;
              <span class="token comment">&lt;!-- \u53EA\u6709\u767B\u5F55\u8FC7\u4E14\u5F53\u524D\u767B\u5F55\u7528\u6237\u4E0D\u662F\u770B\u7684\u81EA\u5DF1\u7684\u4E3B\u9875\u5C31\u663E\u793A\u5DF2\u5173\u6CE8/\u5173\u6CE8TA --&gt;</span>
    th:text=&quot;\${hasFollowed?&#39;\u5DF2\u5173\u6CE8&#39;:&#39;\u5173\u6CE8TA&#39;}&quot; th:if=&quot;\${loginUser!=null &amp;&amp; loginUser.id!=user.id}&quot;&gt;\u5173\u6CE8TA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8\u4E86 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followeeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> \u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8\u8005 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followerCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> \u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5173\u6CE8\u5217\u8868" tabindex="-1"><a class="header-anchor" href="#\u5173\u6CE8\u5217\u8868" aria-hidden="true">#</a> \u5173\u6CE8\u5217\u8868</h2><p>\uFF08\u540C\u7C89\u4E1D\u5217\u8868\uFF09</p><h3 id="_1-\u7F16\u5199service\u5C42-\u67E5\u8BE2\u67D0\u7528\u6237\u5173\u6CE8\u7684\u4EBA" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199service\u5C42-\u67E5\u8BE2\u67D0\u7528\u6237\u5173\u6CE8\u7684\u4EBA" aria-hidden="true">#</a> 1.\u7F16\u5199Service\u5C42\uFF08\u67E5\u8BE2\u67D0\u7528\u6237\u5173\u6CE8\u7684\u4EBA\uFF09</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>\u67E5\u8BE2\u67D0\u7528\u6237\u5173\u6CE8\u7684\u4EBA<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">findFollowees</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> followeeKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getFolloweeKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6309\u6700\u65B0\u65F6\u95F4\u5012\u5E8F\u67E5\u8BE2\u76EE\u6807\u7528\u6237id\u5C01\u88C5\u5728set&lt;Integet&gt;\u4E2D</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> targetIds <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverseRange</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> offset <span class="token operator">+</span> limit <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetIds <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5C06user\u4FE1\u606FMap\u548Credis\u7528\u6237\u5173\u6CE8\u65F6\u95F4Map\u4E00\u8D77\u5C01\u88C5\u5230list</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> targetId<span class="token operator">:</span> targetIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u7528\u6237\u4FE1\u606Fmap</span>
            <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u76EE\u6807\u7528\u6237\u5173\u6CE8\u65F6\u95F4map(\u5C06long\u578B\u62C6\u7BB1\u6210\u57FA\u672C\u6570\u636E\u7C7B\u578B)</span>
            <span class="token class-name">Double</span> score <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForZSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">score</span><span class="token punctuation">(</span>followeeKey<span class="token punctuation">,</span> targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;followeeTime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>score<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199controller\u5C42-2" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199controller\u5C42-2" aria-hidden="true">#</a> 2.\u7F16\u5199Controller\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token operator">/</span> \u67E5\u8BE2\u67D0\u7528\u6237\u5173\u6CE8\u5217\u8868<span class="token operator">/</span>
  <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/followees/{userId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFollowees</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \u5F53\u524D\u8BBF\u95EE\u7684\u7528\u6237\u4FE1\u606F</span>
      <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Controller\u5C42\u7EDF\u4E00\u5904\u7406\u5F02\u5E38</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u7528\u6237\u4E0D\u5B58\u5728\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// \u8BBE\u7F6E\u5206\u9875\u4FE1\u606F</span>
      page<span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/followees/&quot;</span> <span class="token operator">+</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> followService<span class="token punctuation">.</span><span class="token function">findFolloweeCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> userList <span class="token operator">=</span> followService<span class="token punctuation">.</span><span class="token function">findFollowees</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">:</span> userList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;hasFollowed&quot;</span><span class="token punctuation">,</span> <span class="token function">hasFollowed</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> userList<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token string">&quot;/site/followee&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token operator">/</span>\u5224\u7AEF\u5F53\u524D\u767B\u5F55\u7528\u6237\u4E0E\u5173\u6CE8\u3001\u7C89\u4E1D\u5217\u8868\u7684\u5173\u6CE8\u5173\u7CFB<span class="token operator">/</span>
  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> <span class="token function">hasFollowed</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// \u8C03\u7528\u5F53\u524D\u7528\u6237\u662F\u5426\u5DF2\u5173\u6CE8user\u5B9E\u4F53Service</span>
      <span class="token keyword">return</span> followService<span class="token punctuation">.</span><span class="token function">hasFollowed</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ENTITY_TYPE_USER</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199\u524D\u7AEF\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199\u524D\u7AEF\u9875\u9762" aria-hidden="true">#</a> 3.\u7F16\u5199\u524D\u7AEF\u9875\u9762</h3><h4 id="_3-1\u5E26\u53C2\u6570\u8DEF\u5F84\u8DF3\u8F6C" tabindex="-1"><a class="header-anchor" href="#_3-1\u5E26\u53C2\u6570\u8DEF\u5F84\u8DF3\u8F6C" aria-hidden="true">#</a> 3.1\u5E26\u53C2\u6570\u8DEF\u5F84\u8DF3\u8F6C</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8\u4E86 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/followees/\${user.id}|}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followeeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> \u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8\u8005 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/followers/\${user.id}|}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followerCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>123<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> \u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2\u5217\u8868\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_3-2\u5217\u8868\u9875\u9762" aria-hidden="true">#</a> 3.2\u5217\u8868\u9875\u9762</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${users}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/user/profile/{map.user.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.headerUrl}<span class="token punctuation">&quot;</span></span><span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u843D\u57FA\u5C71\u8109\u4E0B\u7684\u95F2\u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
          \u5173\u6CE8\u4E8E <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.followerTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-28 14:13:25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>entityId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|\${map.hasFollowed?&#39;btn-secondary&#39;:&#39;btn-info&#39;}|<span class="token punctuation">&quot;</span></span>
            <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.hasFollowed?&#39;\u5DF2\u5173\u6CE8&#39;:&#39;\u5173\u6CE8TA&#39;}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${loginUser!=null &amp;&amp; loginUser.id!=map.user.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8TA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u7CFB\u7EDF\u901A\u77E5\u529F\u80FD-kafka\u6D88\u606F\u961F\u5217" tabindex="-1"><a class="header-anchor" href="#\u7CFB\u7EDF\u901A\u77E5\u529F\u80FD-kafka\u6D88\u606F\u961F\u5217" aria-hidden="true">#</a> \u7CFB\u7EDF\u901A\u77E5\u529F\u80FD\uFF08Kafka\u6D88\u606F\u961F\u5217\uFF09</h1><h2 id="\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5\u529F\u80FD" aria-hidden="true">#</a> \u53D1\u9001\u7CFB\u7EDF\u901A\u77E5\u529F\u80FD</h2><p>\uFF08\u70B9\u8D5E\u3001\u5173\u6CE8\u3001\u8BC4\u8BBA\u65F6\u901A\u77E5\uFF09</p><h3 id="_1-\u7F16\u5199kafka\u6D88\u606F\u961F\u5217\u4E8B\u4EF6event\u5B9E\u4F53\u7C7B" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199kafka\u6D88\u606F\u961F\u5217\u4E8B\u4EF6event\u5B9E\u4F53\u7C7B" aria-hidden="true">#</a> 1.\u7F16\u5199Kafka\u6D88\u606F\u961F\u5217\u4E8B\u4EF6Event\u5B9E\u4F53\u7C7B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u6D88\u606F\u961F\u5217\u4E8B\u4EF6\uFF08\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8\u4E8B\u4EF6
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>

    <span class="token comment">// Kafka\u5FC5\u8981\u7684\u4E3B\u9898\u53D8\u91CF</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>
    <span class="token comment">// \u53D1\u8D77\u4E8B\u4EF6\u7684\u7528\u6237id</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token comment">// \u7528\u6237\u53D1\u8D77\u4E8B\u4EF6\u7684\u5B9E\u4F53\u7C7B\u578B\uFF08\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8\u7C7B\u578B\uFF09</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityType<span class="token punctuation">;</span>
    <span class="token comment">// \u7528\u6237\u53D1\u8D77\u4E8B\u4EF6\u7684\u5B9E\u4F53(\u5E16\u5B50\u3001\u8BC4\u8BBA\u3001\u7528\u6237)id</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityId<span class="token punctuation">;</span>
    <span class="token comment">// \u88AB\u53D1\u8D77\u4E8B\u4EF6\u7684\u7528\u6237id(\u88AB\u8BC4\u8BBA\u3001\u88AB\u70B9\u8D5E\u3001\u88AB\u5173\u6CE8\u7528\u6237)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">;</span>
    <span class="token comment">// \u5176\u4ED6\u53EF\u6269\u5145\u5185\u5BB9\u5BF9\u5E94Comment\u4E2D\u7684content-&gt;\u663E\u793A\u7528\u6237xxx\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8\u4E86xxx</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> topic<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u6CE8\u610F\u8FD9\u91CC\u6240\u6709set\u65B9\u6CD5\u8FD4\u56DEEvent\u7C7B\u578B,\u53D8\u6210\u94FE\u5F0F\u7F16\u7A0B</span>
    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topic<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entityType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entityType <span class="token operator">=</span> entityType<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entityId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setEntityId</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entityId <span class="token operator">=</span> entityId<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getEntityUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entityUserId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setEntityUserId</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityUserId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>entityUserId <span class="token operator">=</span> entityUserId<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u65B9\u4FBF\u5916\u754C\u76F4\u63A5\u8C03\u7528key-value,\u800C\u4E0D\u7528\u518D\u5C01\u88C5\u4E00\u4E0B\u4F20\u6574\u4E2AMap\u96C6\u5408</span>
    <span class="token keyword">public</span> <span class="token class-name">Event</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199kafka\u751F\u4EA7\u8005" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199kafka\u751F\u4EA7\u8005" aria-hidden="true">#</a> 2.\u7F16\u5199Kafka\u751F\u4EA7\u8005</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E8B\u4EF6\u751F\u4EA7\u8005\uFF08\u4E3B\u52A8\u8C03\u7528\uFF09\u76F8\u5F53\u4E8E\u4E00\u4E2A\u5F00\u5173
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventProducer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token comment">// \u5904\u7406\u4E8B\u4EF6</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireMessage</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5C06\u4E8B\u4EF6\u53D1\u5E03\u5230\u6307\u5B9A\u7684\u4E3B\u9898,\u5185\u5BB9\u4E3Aevent\u5BF9\u8C61\u8F6C\u5316\u7684json\u683C\u5F0F\u5B57\u7B26\u4E32</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199kafka\u6D88\u8D39\u8005" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199kafka\u6D88\u8D39\u8005" aria-hidden="true">#</a> 3.\u7F16\u5199Kafka\u6D88\u8D39\u8005</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token constant">QQ</span><span class="token operator">:</span><span class="token number">260602448</span><span class="token operator">--</span>xumingyu
 <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E8B\u4EF6\u6D88\u8D39\u8005<span class="token punctuation">(</span>\u88AB\u52A8\u8C03\u7528<span class="token punctuation">)</span>
 <span class="token operator">*</span> \u5BF9<span class="token class-name">Message</span>\u8868\u6269\u5145\uFF1A<span class="token number">1</span>\uFF1A\u7CFB\u7EDF\u901A\u77E5\uFF0C\u5F53\u751F\u4EA7\u8005\u8C03\u7528\u65F6\uFF0C\u5B58\u5165\u6D88\u606F\u961F\u5217\uFF0C\u6D88\u8D39\u8005\u81EA\u52A8\u8C03\u7528\u5C06event\u4E8B\u4EF6\u76F8\u5173\u4FE1\u606F\u5B58\u5165<span class="token class-name">Message</span>\u8868
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EventConsumer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageService</span> messageService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">TOPIC_COMMENT</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_LIKE</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_FOLLOW</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleCommentMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u7684\u5185\u5BB9\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5C06record.value\u5B57\u7B26\u4E32\u683C\u5F0F\u8F6C\u5316\u4E3AEvent\u5BF9\u8C61</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6CE8\u610F\uFF1Aevent\u4E2D\u82E5data = null,\u662Ffastjson\u4F9D\u8D56\u7248\u672C\u7684\u95EE\u9898(\u4E0D\u80FD\u592A\u9AD81.0.xx)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u683C\u5F0F\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setFromId</span><span class="token punctuation">(</span><span class="token constant">SYSTEM_USER_ID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Message\u8868\u4E2DToId\u8BBE\u7F6E\u4E3A\u88AB\u53D1\u8D77\u4E8B\u4EF6\u7684\u7528\u6237id</span>
        message<span class="token punctuation">.</span><span class="token function">setToId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEntityUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ConversationId\u8BBE\u7F6E\u4E3A\u4E8B\u4EF6\u7684\u4E3B\u9898\uFF08\u70B9\u8D5E\u3001\u8BC4\u8BBA\u3001\u5173\u6CE8\uFF09</span>
        message<span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8BBE\u7F6Econtent\u4E3A\u53EF\u6269\u5C55\u5185\u5BB9\uFF0C\u5C01\u88C5\u5728Map\u96C6\u5408\u4E2D,\u7528\u4E8E\u663E\u793Axxx\u8BC4\u8BBA..\u4E86\u4F60\u7684\u5E16\u5B50</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5C06event.getData\u91CC\u7684k-v\u5B58\u5230context\u8FD9\u4E2AMap\u4E2D\uFF0C\u518D\u5C01\u88C5\u8FDBmessage</span>
        <span class="token comment">// Map.Entry\u662F\u4E3A\u4E86\u66F4\u65B9\u4FBF\u7684\u8F93\u51FAmap\u952E\u503C\u5BF9,Entry\u53EF\u4EE5\u4E00\u6B21\u6027\u83B7\u5F97key\u548Cvalue\u8005\u4E24\u4E2A\u503C</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5C06content(map\u7C7B\u578B)\u8F6C\u5316\u6210\u5B57\u7B26\u4E32\u7C7B\u578B\u5C01\u88C5\u8FDBmessage</span>
        message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u5728communityconstant\u6DFB\u52A0kafka\u4E3B\u9898\u9759\u6001\u5E38\u91CF" tabindex="-1"><a class="header-anchor" href="#_4-\u5728communityconstant\u6DFB\u52A0kafka\u4E3B\u9898\u9759\u6001\u5E38\u91CF" aria-hidden="true">#</a> 4.\u5728CommunityConstant\u6DFB\u52A0Kafka\u4E3B\u9898\u9759\u6001\u5E38\u91CF</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>
     <span class="token operator">/</span>
     <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E3B\u9898<span class="token operator">:</span> \u8BC4\u8BBA
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token class-name">String</span> <span class="token constant">TOPIC_COMMENT</span> <span class="token operator">=</span> <span class="token string">&quot;comment&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E3B\u9898<span class="token operator">:</span> \u70B9\u8D5E
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token class-name">String</span> <span class="token constant">TOPIC_LIKE</span> <span class="token operator">=</span> <span class="token string">&quot;like&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E3B\u9898<span class="token operator">:</span> \u5173\u6CE8
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token class-name">String</span> <span class="token constant">TOPIC_FOLLOW</span> <span class="token operator">=</span> <span class="token string">&quot;follow&quot;</span><span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u7CFB\u7EDF\u7528\u6237<span class="token constant">ID</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">int</span> <span class="token constant">SYSTEM_USER_ID</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u5904\u7406\u89E6\u53D1\u8BC4\u8BBA\u4E8B\u4EF6commentcontroller" tabindex="-1"><a class="header-anchor" href="#_5-\u5904\u7406\u89E6\u53D1\u8BC4\u8BBA\u4E8B\u4EF6commentcontroller" aria-hidden="true">#</a> 5.\u5904\u7406\u89E6\u53D1\u8BC4\u8BBA\u4E8B\u4EF6CommentController</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/add/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        commentService<span class="token punctuation">.</span><span class="token function">addComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> \u89E6\u53D1\u8BC4\u8BBA\u4E8B\u4EF6
         <span class="token operator">*</span> \u8BC4\u8BBA\u5B8C\u540E\uFF0C\u8C03\u7528<span class="token class-name">Kafka</span>\u751F\u4EA7\u8005\uFF0C\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_COMMENT</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> event<span class="token punctuation">.</span>setEntityUserId\u8981\u5206\u60C5\u51B5\u8BBE\u7F6E\u88AB\u53D1\u8D77\u4E8B\u4EF6\u7684\u7528\u6237id
         <span class="token operator">*</span> <span class="token number">1.</span>\u8BC4\u8BBA\u7684\u662F\u5E16\u5B50\uFF0C\u88AB\u53D1\u8D77\u4E8B\u4EF6\uFF08\u8BC4\u8BBA\uFF09\u7684\u7528\u6237<span class="token operator">-&gt;</span>\u8BE5\u5E16\u5B50\u53D1\u5E03\u4EBAid
         <span class="token operator">*</span> <span class="token number">2.</span>\u8BC4\u8BBA\u7684\u662F\u7528\u6237\u7684\u8BC4\u8BBA\uFF0C\u88AB\u53D1\u8D77\u4E8B\u4EF6\uFF08\u8BC4\u8BBA\uFF09\u7684\u7528\u6237<span class="token operator">-&gt;</span>\u8BE5\u8BC4\u8BBA\u53D1\u5E03\u4EBAid
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5148\u627E\u8BC4\u8BBA\u8868\u5BF9\u5E94\u7684\u5E16\u5B50id,\u5728\u6839\u636E\u5E16\u5B50\u8868id\u627E\u5230\u53D1\u5E16\u4EBAid</span>
            <span class="token class-name">DiscussPost</span> target <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_COMMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> target <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/discuss/detail/&quot;</span> <span class="token operator">+</span> discussPostId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-\u5904\u7406\u89E6\u53D1\u5173\u6CE8\u4E8B\u4EF6followcontroller" tabindex="-1"><a class="header-anchor" href="#_6-\u5904\u7406\u89E6\u53D1\u5173\u6CE8\u4E8B\u4EF6followcontroller" aria-hidden="true">#</a> 6.\u5904\u7406\u89E6\u53D1\u5173\u6CE8\u4E8B\u4EF6FollowController</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/follow&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span> <span class="token comment">// \u5173\u6CE8\u662F\u5F02\u6B65\u8BF7\u6C42</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">follow</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        followService<span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> \u89E6\u53D1\u5173\u6CE8\u4E8B\u4EF6
         <span class="token operator">*</span> \u5173\u6CE8\u5B8C\u540E\uFF0C\u8C03\u7528<span class="token class-name">Kafka</span>\u751F\u4EA7\u8005\uFF0C\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_FOLLOW</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>entityId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u7528\u6237\u5173\u6CE8\u5B9E\u4F53\u7684id\u5C31\u662F\u88AB\u5173\u6CE8\u7684\u7528\u6237id-&gt;EntityId=EntityUserId</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;\u5DF2\u5173\u6CE8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-\u5904\u7406\u89E6\u53D1\u70B9\u8D5E\u4E8B\u4EF6likecontroller" tabindex="-1"><a class="header-anchor" href="#_7-\u5904\u7406\u89E6\u53D1\u70B9\u8D5E\u4E8B\u4EF6likecontroller" aria-hidden="true">#</a> 7.\u5904\u7406\u89E6\u53D1\u70B9\u8D5E\u4E8B\u4EF6LikeController</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token comment">// \u52A0\u4E86\u4E00\u4E2ApostId\u53D8\u91CF\uFF0C\u5BF9\u5E94\u7684\u524D\u7AEF\u548Cjs\u9700\u8981\u4FEE\u6539</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">like</span><span class="token punctuation">(</span><span class="token keyword">int</span> entityType<span class="token punctuation">,</span> <span class="token keyword">int</span> entityId<span class="token punctuation">,</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">,</span> <span class="token keyword">int</span> postId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E</span>
        likeService<span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">,</span> entityUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5BF9\u5E94\u5E16\u5B50\u3001\u7559\u8A00\u7684\u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span>entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u767B\u5F55\u7528\u6237\u70B9\u8D5E\u72B6\u6001\uFF081\uFF1A\u5DF2\u70B9\u8D5E 0\uFF1A\u8D5E\uFF09</span>
        <span class="token keyword">int</span> likeStatus <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeStatus</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entityType<span class="token punctuation">,</span> entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5C01\u88C5\u7ED3\u679C\u5230Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeStatus&quot;</span><span class="token punctuation">,</span> likeStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> \u89E6\u53D1\u70B9\u8D5E\u4E8B\u4EF6
         <span class="token operator">*</span> \u53EA\u6709\u70B9\u8D5E\u5B8C\u540E\uFF0C\u624D\u4F1A\u8C03\u7528<span class="token class-name">Kafka</span>\u751F\u4EA7\u8005\uFF0C\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5\uFF0C\u53D6\u6D88\u70B9\u8D5E\u4E0D\u4F1A\u8C03\u7528\u4E8B\u4EF6
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>likeStatus <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_LIKE</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>entityId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span>entityType<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>entityUserId<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u6CE8\u610F\uFF1Adata\u91CC\u9762\u5B58postId\u662F\u56E0\u4E3A\u70B9\u51FB\u67E5\u770B\u540E\u94FE\u63A5\u5230\u5177\u4F53\u5E16\u5B50\u7684\u9875\u9762</span>
            eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!--\u5BF9\u5E94\u7684\u524D\u7AEFpostId\u53D8\u91CF\u4EE5\u53CAjs\u7684\u4FEE\u6539--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> 
  <span class="token attr-name"><span class="token namespace">th:</span>onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|like(this,1,\${post.id},\${post.userId},\${post.id});|<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
function like(btn, entityType, entityId, entityUserId, postId) {
  $.post(
      CONTEXT_PATH + &quot;/like&quot;,
      {&quot;entityType&quot;: entityType, &quot;entityId&quot;: entityId, &quot;entityUserId&quot;: entityUserId, &quot;postId&quot;:postId},
      function(data) {
      .....}
  );}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5" aria-hidden="true">#</a> \u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5</h2><h3 id="_1-\u7F16\u5199dao\u5C42\u63A5\u53E3-1" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199dao\u5C42\u63A5\u53E3-1" aria-hidden="true">#</a> 1.\u7F16\u5199Dao\u5C42\u63A5\u53E3</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> \u67E5\u8BE2\u67D0\u4E2A\u4E3B\u9898\u6700\u65B0\u901A\u77E5
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token class-name">Message</span> <span class="token function">selectLatestNotice</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
 <span class="token operator">*</span> \u67E5\u8BE2\u67D0\u4E2A\u4E3B\u9898\u901A\u77E5\u4E2A\u6570
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">int</span> <span class="token function">selectNoticeCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
 <span class="token operator">*</span> \u67E5\u8BE2\u67D0\u4E2A\u4E3B\u9898\u672A\u8BFB\u4E2A\u6570<span class="token punctuation">(</span>topic\u53EF\u4E3A<span class="token keyword">null</span><span class="token punctuation">,</span>\u82E5\u4E3A<span class="token keyword">null</span><span class="token operator">:</span>\u67E5\u8BE2\u6240\u6709\u7C7B\u7CFB\u7EDF\u672A\u8BFB\u901A\u77E5\u4E2A\u6570<span class="token punctuation">)</span>
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token keyword">int</span> <span class="token function">selectNoticeUnreadCount</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
<span class="token operator">*</span> \u5206\u9875\u67E5\u8BE2\u67D0\u4E2A\u4E3B\u9898\u7684\u8BE6\u60C5
<span class="token operator">*</span><span class="token operator">/</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectNotices</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--\u7CFB\u7EDF\u901A\u77E5--&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectLatestNotice&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;Message&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">select</span> <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
        <span class="token keyword">from</span> message
        <span class="token keyword">where</span> id <span class="token operator">in</span> <span class="token punctuation">(</span>
          <span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> message
          <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
          <span class="token operator">and</span> from_id <span class="token operator">=</span> <span class="token number">1</span>
          <span class="token operator">and</span> to_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
          <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{topic}</span>
        <span class="token punctuation">)</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectNoticeCount&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> message
        <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
        <span class="token operator">and</span> from_id <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token operator">and</span> to_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
        <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{topic}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--topic\u4E3Anull\u65F6\u67E5\u8BE2\u6240\u6709\u7C7B\u7CFB\u7EDF\u672A\u8BFB\u901A\u77E5---&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectNoticeUnreadCount&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;int&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">from</span> message
        <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token operator">and</span> from_id <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token operator">and</span> to_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;topic!=null&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{topic}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectNotices&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;Message&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">select</span> <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
        <span class="token keyword">from</span> message
        <span class="token keyword">where</span> <span class="token keyword">status</span> <span class="token operator">!=</span> <span class="token number">2</span>
        <span class="token operator">and</span> from_id <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token operator">and</span> to_id <span class="token operator">=</span> <span class="token comment">#{userId}</span>
        <span class="token operator">and</span> conversation_id <span class="token operator">=</span> <span class="token comment">#{topic}</span>
        <span class="token keyword">order</span> <span class="token keyword">by</span> create_time <span class="token keyword">desc</span>
        <span class="token keyword">limit</span> <span class="token comment">#{offset}, #{limit}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199service\u4E1A\u52A1\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199service\u4E1A\u52A1\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199Service\u4E1A\u52A1\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Message</span> <span class="token function">findLatestNotice</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectLatestNotice</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findNoticeCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectNoticeCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectNoticeUnreadCount</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token function">findNotices</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageMapper<span class="token punctuation">.</span><span class="token function">selectNotices</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199messagecontroller\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199messagecontroller\u5C42" aria-hidden="true">#</a> 3.\u7F16\u5199MessageController\u5C42</h3><h4 id="_3-1\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u63A5\u53E3-\u8BC4\u8BBA\u7C7B\u901A\u77E5\u3001\u70B9\u8D5E\u7C7B\u901A\u77E5\u3001\u5173\u6CE8\u7C7B\u901A\u77E5\u4E09\u79CD\u7C7B\u4F3C" tabindex="-1"><a class="header-anchor" href="#_3-1\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u63A5\u53E3-\u8BC4\u8BBA\u7C7B\u901A\u77E5\u3001\u70B9\u8D5E\u7C7B\u901A\u77E5\u3001\u5173\u6CE8\u7C7B\u901A\u77E5\u4E09\u79CD\u7C7B\u4F3C" aria-hidden="true">#</a> 3.1\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u63A5\u53E3\uFF08\u8BC4\u8BBA\u7C7B\u901A\u77E5\u3001\u70B9\u8D5E\u7C7B\u901A\u77E5\u3001\u5173\u6CE8\u7C7B\u901A\u77E5\u4E09\u79CD\u7C7B\u4F3C\uFF09</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/notice/list&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNoticeList</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>\u67E5\u8BE2\u8BC4\u8BBA\u7C7B\u901A\u77E5<span class="token operator">/</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLatestNotice</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> messageVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// \u8F6C\u5316message\u8868\u4E2Dcontent\u4E3AHashMap&lt;k,v&gt;\u7C7B\u578B</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlUnescape</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5C06content\u6570\u636E\u4E2D\u7684\u6BCF\u4E00\u4E2A\u5B57\u6BB5\u90FD\u5B58\u5165map</span>
            <span class="token comment">// \u7528\u4E8E\u663E\u793A-&gt;\u7528\u6237[user] (\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8[entityType])...\u4E86\u4F60\u7684(\u5E16\u5B50\u3001\u56DE\u590D\u3001\u7528\u6237[entityId]) \u67E5\u770B\u8BE6\u60C5\u8FDE\u63A5[postId]</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// \u5171\u51E0\u6761\u4F1A\u8BDD</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8BC4\u8BBA\u7C7B\u672A\u8BFB\u6570</span>
            <span class="token keyword">int</span> unreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_COMMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;unreadCount&quot;</span><span class="token punctuation">,</span> unreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;commentNotice&quot;</span><span class="token punctuation">,</span> messageVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">/</span>\u67E5\u8BE2\u70B9\u8D5E\u7C7B\u901A\u77E5<span class="token operator">/</span>
        message <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLatestNotice</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_LIKE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> messageVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8F6C\u5316message\u8868\u4E2Dcontent\u4E3AHashMap&lt;k,v&gt;\u7C7B\u578B</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlUnescape</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5C06content\u6570\u636E\u4E2D\u7684\u6BCF\u4E00\u4E2A\u5B57\u6BB5\u90FD\u5B58\u5165map</span>
            <span class="token comment">// \u7528\u4E8E\u663E\u793A-&gt;\u7528\u6237[user] (\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8[entityType])...\u4E86\u4F60\u7684(\u5E16\u5B50\u3001\u56DE\u590D\u3001\u7528\u6237[entityId]) \u67E5\u770B\u8BE6\u60C5\u8FDE\u63A5[postId]</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// \u5171\u51E0\u6761\u4F1A\u8BDD</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_LIKE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u70B9\u8D5E\u7C7B\u672A\u8BFB\u6570</span>
            <span class="token keyword">int</span> unreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_LIKE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;unreadCount&quot;</span><span class="token punctuation">,</span> unreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;likeNotice&quot;</span><span class="token punctuation">,</span> messageVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">/</span>\u67E5\u8BE2\u5173\u6CE8\u7C7B\u901A\u77E5<span class="token operator">/</span>
        message <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLatestNotice</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_FOLLOW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> messageVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8F6C\u5316message\u8868\u4E2Dcontent\u4E3AHashMap&lt;k,v&gt;\u7C7B\u578B</span>
            <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlUnescape</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5C06content\u6570\u636E\u4E2D\u7684\u6BCF\u4E00\u4E2A\u5B57\u6BB5\u90FD\u5B58\u5165map</span>
            <span class="token comment">// \u7528\u4E8E\u663E\u793A-&gt;\u7528\u6237[user] (\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8)...\u4E86\u4F60\u7684(\u5E16\u5B50\u3001\u56DE\u590D\u3001\u7528\u6237[entityType]) \u67E5\u770B\u8BE6\u60C5\u8FDE\u63A5[postId]</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// \u5171\u51E0\u6761\u4F1A\u8BDD</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_FOLLOW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5173\u6CE8\u7C7B\u672A\u8BFB\u6570</span>
            <span class="token keyword">int</span> unreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TOPIC_FOLLOW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            messageVO<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;unreadCount&quot;</span><span class="token punctuation">,</span> unreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;followNotice&quot;</span><span class="token punctuation">,</span> messageVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u67E5\u8BE2\u672A\u8BFB\u79C1\u4FE1\u6570\u91CF</span>
        <span class="token keyword">int</span> letterUnreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLetterUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;letterUnreadCount&quot;</span><span class="token punctuation">,</span> letterUnreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u67E5\u8BE2\u6240\u6709\u672A\u8BFB\u7CFB\u7EDF\u901A\u77E5\u6570\u91CF</span>
        <span class="token keyword">int</span> noticeUnreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;noticeUnreadCount&quot;</span><span class="token punctuation">,</span> noticeUnreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/notice&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_3-2\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875\u63A5\u53E3" aria-hidden="true">#</a> 3.2\u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875\u63A5\u53E3</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u67E5\u8BE2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875\uFF08\u5206\u9875\uFF09
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/notice/detail/{topic}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getNoticeDetail</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;topic&quot;</span><span class="token punctuation">)</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        page<span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/notice/detail/&quot;</span> <span class="token operator">+</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>messageService<span class="token punctuation">.</span><span class="token function">findNoticeCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> noticeList <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNotices</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u805A\u5408\u62FC\u63A5User</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> noticeVoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>noticeList <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Message</span> notice <span class="token operator">:</span> noticeList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5C06\u67E5\u8BE2\u51FA\u6765\u7684\u6BCF\u4E00\u4E2A\u901A\u77E5\u5C01\u88C5Map</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notice&quot;</span><span class="token punctuation">,</span> notice<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u53D1\u8D77\u4E8B\u4EF6\u7684user</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// \u628Amessage\u4E2D\u7684content\u5185\u5BB9\u8F6C\u5316Object</span>
                <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token class-name">HtmlUtils</span><span class="token punctuation">.</span><span class="token function">htmlUnescape</span><span class="token punctuation">(</span>notice<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u7CFB\u7EDF\u901A\u77E5-&gt;id=1\u7684\u7CFB\u7EDF\u7528\u6237</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;fromUser&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>notice<span class="token punctuation">.</span><span class="token function">getFromId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                noticeVoList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;notices&quot;</span><span class="token punctuation">,</span> noticeVoList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u8BBE\u7F6E\u5DF2\u8BFB(\u5F53\u6253\u5F00\u8FD9\u4E2A\u9875\u9762\u662F\u5C31\u66F4\u6539status =1)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> ids <span class="token operator">=</span> <span class="token function">getLetterIds</span><span class="token punctuation">(</span>noticeList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ids<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageService<span class="token punctuation">.</span><span class="token function">readMessage</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/notice-detail&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u901A\u8FC7aop\u7F16\u7A0B\u5B9E\u73B0\u67E5\u8BE2\u672A\u8BFB\u6D88\u606F\u603B\u6570-\u79C1\u4FE1\u6D88\u606F-\u7CFB\u7EDF\u6D88\u606F" tabindex="-1"><a class="header-anchor" href="#_4-\u901A\u8FC7aop\u7F16\u7A0B\u5B9E\u73B0\u67E5\u8BE2\u672A\u8BFB\u6D88\u606F\u603B\u6570-\u79C1\u4FE1\u6D88\u606F-\u7CFB\u7EDF\u6D88\u606F" aria-hidden="true">#</a> 4.\u901A\u8FC7AOP\u7F16\u7A0B\u5B9E\u73B0\u67E5\u8BE2\u672A\u8BFB\u6D88\u606F\u603B\u6570(\u79C1\u4FE1\u6D88\u606F+\u7CFB\u7EDF\u6D88\u606F)</h3><h4 id="_4-1\u7F16\u5199messageinterceptor\u62E6\u622A\u5668" tabindex="-1"><a class="header-anchor" href="#_4-1\u7F16\u5199messageinterceptor\u62E6\u622A\u5668" aria-hidden="true">#</a> 4.1\u7F16\u5199MessageInterceptor\u62E6\u622A\u5668</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageService</span> messageService<span class="token punctuation">;</span>
    <span class="token comment">// \u67E5\u8BE2\u672A\u8BFB\u6D88\u606F\u603B\u6570(AOP),controller\u4E4B\u540E\uFF0C\u6E32\u67D3\u6A21\u677F\u4E4B\u524D</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> modelAndView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> letterUnreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findLetterUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> noticeUnreadCount <span class="token operator">=</span> messageService<span class="token punctuation">.</span><span class="token function">findNoticeUnreadCount</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;allUnreadCount&quot;</span><span class="token punctuation">,</span> letterUnreadCount <span class="token operator">+</span> noticeUnreadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token comment">// index\u9875\u524D\u7AEF\u5BF9\u5E94\u4EE3\u7801</span>
<span class="token operator">&lt;</span>li th<span class="token operator">:</span><span class="token keyword">if</span><span class="token operator">=</span><span class="token string">&quot;\${loginUser!=null}&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>a th<span class="token operator">:</span>href<span class="token operator">=</span><span class="token string">&quot;@{/letter/list}&quot;</span><span class="token operator">&gt;</span>\u6D88\u606F
    <span class="token operator">&lt;</span>span th<span class="token operator">:</span>text<span class="token operator">=</span><span class="token string">&quot;\${allUnreadCount!=0?allUnreadCount:&#39;&#39;}&quot;</span><span class="token operator">&gt;</span>\u6D88\u606F\u672A\u8BFB\u603B\u6570<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2\u6CE8\u518C\u62E6\u622A\u5668" tabindex="-1"><a class="header-anchor" href="#_4-2\u6CE8\u518C\u62E6\u622A\u5668" aria-hidden="true">#</a> 4.2\u6CE8\u518C\u62E6\u622A\u5668</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
  <span class="token keyword">private</span> <span class="token class-name">MessageInterceptor</span> messageInterceptor<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>messageInterceptor<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/* */*.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;// *.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/* */*.png&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/ / *.jpg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/* */*.jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 5.\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><h4 id="_5-1\u7CFB\u7EDF\u901A\u77E5\u9875" tabindex="-1"><a class="header-anchor" href="#_5-1\u7CFB\u7EDF\u901A\u77E5\u9875" aria-hidden="true">#</a> 5.1\u7CFB\u7EDF\u901A\u77E5\u9875</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>active<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/notice/list}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    \u7CFB\u7EDF\u901A\u77E5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${noticeUnreadCount}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${noticeUnreadCount!=0}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7CFB\u7EDF\u901A\u77E5\u672A\u8BFB\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- \u901A\u77E5\u5217\u8868 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list-unstyled<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--\u8BC4\u8BBA\u7C7B\u901A\u77E5--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${commentNotice!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${commentNotice.unreadCount!=0?commentNotice.unreadCount:&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8BC4\u8BBA\u901A\u77E5\u672A\u8BFB\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://xxx.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u901A\u77E5\u56FE\u6807<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u8BC4\u8BBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(commentNotice.message.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-28 14:13:25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/notice/detail/comment}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          \u7528\u6237 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${commentNotice.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8BC4\u8BBA\u53D1\u8D77\u4EBA\u7528\u6237\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
          \u8BC4\u8BBA\u4E86\u4F60\u7684<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${commentNotice.entityType==1?&#39;\u5E16\u5B50&#39;:&#39;\u56DE\u590D&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5E16\u5B50<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5171 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${commentNotice.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u6761\u4F1A\u8BDD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--\u70B9\u8D5E\u7C7B\u901A\u77E5--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeNotice!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeNotice.unreadCount!=0?likeNotice.unreadCount:&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://like.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u901A\u77E5\u56FE\u6807<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u8D5E<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(likeNotice.message.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-28 14:13:25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/notice/detail/like}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              \u7528\u6237
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeNotice.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>nowcoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
              \u70B9\u8D5E\u4E86\u4F60\u7684<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeNotice.entityType==1?&#39;\u5E16\u5B50&#39;:&#39;\u56DE\u590D&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5E16\u5B50<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span> ...
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5171 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${likeNotice.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u6761\u4F1A\u8BDD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token comment">&lt;!--\u5173\u6CE8\u7C7B\u901A\u77E5--&gt;</span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followNotice!=null}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followNotice.unreadCount!=0?followNotice.unreadCount:&#39;&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://follow.png<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mr-4 user-header<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u901A\u77E5\u56FE\u6807<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>\u5173\u6CE8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(followNotice.message.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-28 14:13:25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/notice/detail/follow}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
              \u7528\u6237
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followNotice.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>nowcoder<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
              \u5173\u6CE8\u4E86\u4F60 ...
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text-primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5171 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${followNotice.count}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span> \u6761\u4F1A\u8BDD<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875" tabindex="-1"><a class="header-anchor" href="#_5-2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875" aria-hidden="true">#</a> 5.2\u7CFB\u7EDF\u901A\u77E5\u8BE6\u60C5\u9875</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-4 text-right<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn btn-secondary btn-sm<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>\u8FD4\u56DE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- \u901A\u77E5\u5217\u8868 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${notices}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.fromUser.headerUrl}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7CFB\u7EDF\u56FE\u6807<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.fromUser.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7CFB\u7EDF\u540D<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.notice.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-04-25 15:49:32<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--\u663E\u793A\u8BC4\u8BBA\u4FE1\u606F--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${topic.equals(&#39;comment&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          \u7528\u6237
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u53D1\u8D77\u4E8B\u4EF6\u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
          \u8BC4\u8BBA\u4E86\u4F60\u7684<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.entityType==1?&#39;\u5E16\u5B50&#39;:&#39;\u56DE\u590D&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5E16\u5B50<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>,
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/discuss/detail/\${map.postId}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u70B9\u51FB\u67E5\u770B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> !
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--\u663E\u793A\u70B9\u8D5E\u4FE1\u606F--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${topic.equals(&#39;like&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          \u7528\u6237
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u53D1\u8D77\u4E8B\u4EF6\u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
          \u70B9\u8D5E\u4E86\u4F60\u7684<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.entityType==1?&#39;\u5E16\u5B50&#39;:&#39;\u56DE\u590D&#39;}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5E16\u5B50<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>,
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/discuss/detail/\${map.postId}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u70B9\u51FB\u67E5\u770B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> !
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--\u663E\u793A\u5173\u6CE8\u4FE1\u606F--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${topic.equals(&#39;follow&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          \u7528\u6237
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u53D1\u8D77\u4E8B\u4EF6\u4EBA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>
          \u5173\u6CE8\u4E86\u4F60,
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/user/profile/\${map.user.id}|}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u70B9\u51FB\u67E5\u770B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> !
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">function</span> <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/notice/list&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u641C\u7D22\u529F\u80FD-elasticsearch-kafka" tabindex="-1"><a class="header-anchor" href="#\u641C\u7D22\u529F\u80FD-elasticsearch-kafka" aria-hidden="true">#</a> \u641C\u7D22\u529F\u80FD\uFF08Elasticsearch+Kafka\uFF09</h2><h3 id="_1-\u7F16\u5199\u5B9E\u4F53\u7C7B\u6620\u5C04\u5230elasticsearch\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199\u5B9E\u4F53\u7C7B\u6620\u5C04\u5230elasticsearch\u670D\u52A1\u5668" aria-hidden="true">#</a> 1.\u7F16\u5199\u5B9E\u4F53\u7C7B\u6620\u5C04\u5230Elasticsearch\u670D\u52A1\u5668</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Elasticsearch\u8868\u540D</span>
<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>indexName <span class="token operator">=</span> <span class="token string">&quot;discusspost&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">&quot;_doc&quot;</span><span class="token punctuation">,</span> shards <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> replicas <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscussPost</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>

    <span class="token comment">// Elaticsearch\u4E0E\u6570\u636E\u5E93\u8868\u6620\u5C04</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Integer</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>

    <span class="token comment">// analyzer\uFF1A\u6700\u5927\u4E2D\u6587\u5206\u8BCD\u89E3\u6790\u5668, searchAnalyzer\uFF1A\u667A\u80FD\u4E2D\u6587\u5206\u8BCD\u89E3\u6790\u5668</span>
    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span> searchAnalyzer <span class="token operator">=</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Text</span><span class="token punctuation">,</span> analyzer <span class="token operator">=</span> <span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">,</span> searchAnalyzer <span class="token operator">=</span> <span class="token string">&quot;ik_smart&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Integer</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> type<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Integer</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Date</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Integer</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> commentCount<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Field</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FieldType<span class="token punctuation">.</span>Double</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> score<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199xxxrepository\u63A5\u53E3" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199xxxrepository\u63A5\u53E3" aria-hidden="true">#</a> 2.\u7F16\u5199xxxRepository\u63A5\u53E3</h3><p>(\u7EE7\u627FElasticsearchRepository&lt;Class, Integer&gt;)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span>
 <span class="token operator">*</span> <span class="token class-name">DiscussPost</span>\uFF1A\u63A5\u53E3\u8981\u5904\u7406\u7684\u5B9E\u4F53\u7C7B
 <span class="token operator">*</span> <span class="token class-name">Integer</span>\uFF1A\u5B9E\u4F53\u7C7B\u4E2D\u7684\u4E3B\u952E\u662F\u4EC0\u4E48\u7C7B\u578B
 <span class="token operator">*</span> <span class="token class-name">ElasticsearchRepository</span>\uFF1A\u7236\u63A5\u53E3\uFF0C\u5176\u4E2D\u5DF2\u7ECF\u4E8B\u5148\u5B9A\u4E49\u597D\u4E86\u5BF9es\u670D\u52A1\u5668\u8BBF\u95EE\u7684\u589E\u5220\u6539\u67E5\u5404\u79CD\u65B9\u6CD5\u3002<span class="token class-name">Spring</span>\u4F1A\u7ED9\u5B83\u81EA\u52A8\u505A\u4E00\u4E2A\u5B9E\u73B0\uFF0C\u6211\u4EEC\u76F4\u63A5\u53BB\u8C03\u5C31\u53EF\u4EE5\u4E86\u3002
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DiscussPostRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199elasticsearchservice\u4E1A\u52A1\u5C42" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199elasticsearchservice\u4E1A\u52A1\u5C42" aria-hidden="true">#</a> 3.\u7F16\u5199ElasticsearchService\u4E1A\u52A1\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> \u7528<span class="token class-name">Elasticsearch</span>\u670D\u52A1\u5668\u641C\u7D22\u5E16\u5B50service
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostRepository</span> discussRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchTemplate</span> elasticTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        discussRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDiscussPost</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        discussRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> <span class="token class-name">Elasticsearch</span>\u9AD8\u4EAE\u641C\u7D22
     <span class="token operator">*</span> current\uFF1A\u5F53\u524D\u9875\uFF08\u4E0D\u662Foffset\u8D77\u59CB\u9875\uFF09
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">searchDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token keyword">int</span> current<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchQuery</span> searchQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withSort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withPageable</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withHighlightFields</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;em&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/em&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder<span class="token punctuation">.</span>Field</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;em&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/em&gt;&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// new SearchResultMapper()\u533F\u540D\u7C7B\uFF0C\u5904\u7406\u9AD8\u4EAE</span>
        <span class="token keyword">return</span> elasticTemplate<span class="token punctuation">.</span><span class="token function">queryForPage</span><span class="token punctuation">(</span>searchQuery<span class="token punctuation">,</span> <span class="token class-name">DiscussPost</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SearchResultMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">AggregatedPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">mapResults</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> aClass<span class="token punctuation">,</span> <span class="token class-name">Pageable</span> pageable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiscussPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// elasticsearch\u4E2D\u5C06json\u683C\u5F0F\u6570\u636E\u5C01\u88C5\u4E3A\u4E86map,\u5728\u5C06map\u5B57\u6BB5\u5B58\u8FDBpost\u4E2D</span>
                    <span class="token class-name">String</span> id <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> userId <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> title <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> content <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> status <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// createTime\u5B57\u7B26\u4E32\u662FLong\u7C7B\u578B</span>
                    <span class="token class-name">String</span> createTime <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>createTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">String</span> commentCount <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;commentCount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    post<span class="token punctuation">.</span><span class="token function">setCommentCount</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>commentCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// \u5904\u7406\u9AD8\u4EAE\u663E\u793A\u7684\u7ED3\u679C</span>
                    <span class="token class-name">HighlightField</span> titleField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>titleField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// [0]-&gt;\u641C\u5BFB\u7ED3\u679C\u4E3A\u591A\u6BB5\u65F6\uFF0C\u53D6\u7B2C\u4E00\u6BB5</span>
                        post<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>titleField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token class-name">HighlightField</span> contentField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        post<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>contentField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AggregatedPageImpl</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> pageable<span class="token punctuation">,</span>
                        hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getScrollId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hits<span class="token punctuation">.</span><span class="token function">getMaxScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u4FEE\u6539\u53D1\u5E03\u5E16\u5B50\u548C\u589E\u52A0\u8BC4\u8BBAcontroller" tabindex="-1"><a class="header-anchor" href="#_4-\u4FEE\u6539\u53D1\u5E03\u5E16\u5B50\u548C\u589E\u52A0\u8BC4\u8BBAcontroller" aria-hidden="true">#</a> 4.\u4FEE\u6539\u53D1\u5E03\u5E16\u5B50\u548C\u589E\u52A0\u8BC4\u8BBAController</h3><p>\u53D1\u5E03\u5E16\u5B50\u65F6\uFF0C\u5C06\u5E16\u5B50\u5F02\u6B65\u63D0\u4EA4\u5230Elasticsearch\u670D\u52A1\u5668</p><p>\u589E\u52A0\u8BC4\u8BBA\u65F6\uFF0C\u5C06\u5E16\u5B50\u5F02\u6B65\u63D0\u4EA4\u5230Elasticsearch\u670D\u52A1\u5668</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>     <span class="token operator">/</span>
      <span class="token operator">*</span> <span class="token class-name">Kafka</span>\u4E3B\u9898<span class="token operator">:</span> \u53D1\u5E03\u5E16\u5B50<span class="token punctuation">(</span>\u5E38\u91CF\u63A5\u53E3<span class="token punctuation">)</span>
      <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token class-name">String</span> <span class="token constant">TOPIC_PUBILISH</span> <span class="token operator">=</span> <span class="token string">&quot;publish&quot;</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/add/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ............</span>
      
     <span class="token operator">/</span>
      <span class="token operator">*</span> \u589E\u52A0\u8BC4\u8BBA\u65F6\uFF0C\u5C06\u5E16\u5B50\u5F02\u6B65\u63D0\u4EA4\u5230<span class="token class-name">Elasticsearch</span>\u670D\u52A1\u5668
      <span class="token operator">*</span> \u901A\u8FC7<span class="token class-name">Kafka</span>\u6D88\u606F\u961F\u5217\u53BB\u63D0\u4EA4\uFF0C\u4FEE\u6539<span class="token class-name">Elasticsearch</span>\u4E2D\u5E16\u5B50\u7684\u8BC4\u8BBA\u6570
      <span class="token operator">*</span><span class="token operator">/</span>
      <span class="token comment">//\u82E5\u8BC4\u8BBA\u4E3A\u5E16\u5B50\u7C7B\u578B\u65F6\uFF0C\u624D\u9700\u8981\u52A0\u5165\u6D88\u606F\u961F\u5217\u5904\u7406</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_PUBILISH</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
          eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token string">&quot;redirect:/discuss/detail/&quot;</span> <span class="token operator">+</span> discussPostId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token comment">// \u5F02\u6B65\u8BF7\u6C42\u8981\u52A0@ResponseBody,\u4E14\u4E0D\u8981\u5728Controller\u5C42\u7528Model</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//.................</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u53D1\u5E03\u5E16\u5B50\u65F6\uFF0C\u5C06\u5E16\u5B50\u5F02\u6B65\u63D0\u4EA4\u5230<span class="token class-name">Elasticsearch</span>\u670D\u52A1\u5668
     <span class="token operator">*</span> \u901A\u8FC7<span class="token class-name">Kafka</span>\u6D88\u606F\u961F\u5217\u53BB\u63D0\u4EA4\uFF0C\u5C06\u65B0\u53D1\u5E03\u7684\u5E16\u5B50\u5B58\u5165<span class="token class-name">Elasticsearch</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_PUBILISH</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u8FD4\u56DEJson\u683C\u5F0F\u5B57\u7B26\u4E32,\u62A5\u9519\u7684\u60C5\u51B5\u5C06\u6765\u7EDF\u4E00\u5904\u7406</span>
    <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;\u53D1\u5E03\u6210\u529F\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u5728\u6D88\u8D39\u7EC4\u4EF6\u4E2D\u589E\u52A0\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_5-\u5728\u6D88\u8D39\u7EC4\u4EF6\u4E2D\u589E\u52A0\u65B9\u6CD5" aria-hidden="true">#</a> 5.\u5728\u6D88\u8D39\u7EC4\u4EF6\u4E2D\u589E\u52A0\u65B9\u6CD5</h3><p>\uFF08\u6D88\u8D39\u5E16\u5B50\u53D1\u5E03\u4E8B\u4EF6\uFF09</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u6D88\u8D39\u5E16\u5B50\u53D1\u5E03\u4E8B\u4EF6\uFF0C\u5C06\u65B0\u589E\u7684\u5E16\u5B50\u548C\u6DFB\u52A0\u8BC4\u8BBA\u540E\u5E16\u5B50\u8BC4\u8BBA\u6570\u901A\u8FC7\u6D88\u606F\u961F\u5217\u7684\u65B9\u5F0Fsave\u8FDB<span class="token class-name">Elastisearch</span>\u670D\u52A1\u5668\u4E2D
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">TOPIC_PUBILISH</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDiscussPostMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u7684\u5185\u5BB9\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5C06record.value\u5B57\u7B26\u4E32\u683C\u5F0F\u8F6C\u5316\u4E3AEvent\u5BF9\u8C61</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6CE8\u610F\uFF1Aevent\u82E5data=null,\u662Ffastjson\u4F9D\u8D56\u7248\u672C\u7684\u95EE\u9898</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u683C\u5F0F\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        elasticsearchService<span class="token punctuation">.</span><span class="token function">saveDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-\u7F16\u5199searchcontroller\u7C7B" tabindex="-1"><a class="header-anchor" href="#_6-\u7F16\u5199searchcontroller\u7C7B" aria-hidden="true">#</a> 6.\u7F16\u5199SearchController\u7C7B</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchController</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token comment">// search?keyword=xxx</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/search&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u641C\u7D22\u5E16\u5B50</span>
        <span class="token comment">// \u5728\u8C03\u7528elasticsearchService\u5B8C\u6210\u641C\u7D22\u7684\u65F6\u5019\uFF0C\u67E5\u8BE2\u6761\u4EF6\u8BBE\u7F6E\u7684\u662F\u4ECE\u7B2C\u51E0\u9875\u5F00\u59CB\uFF0C\u6240\u4EE5\u8981\u586BgetCurrent\uFF0C\u586BgetOffset\u4F1A\u5BFC\u81F4\u7FFB\u9875\u7684\u65F6\u5019\u67E5\u8BE2\u9519\u8BEF</span>
        <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>domain<span class="token punctuation">.</span></span>Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> searchResult <span class="token operator">=</span>
                elasticsearchService<span class="token punctuation">.</span><span class="token function">searchDiscussPost</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u805A\u5408\u6570\u636E</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> discussPosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>searchResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post <span class="token operator">:</span> searchResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5E16\u5B50</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u4F5C\u8005</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                discussPosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;discussPosts&quot;</span><span class="token punctuation">,</span> discussPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u4E3A\u4E86\u9875\u9762\u4E0A\u53D6\u7684\u9ED8\u8BA4\u503C\u65B9\u4FBF</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>

        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/search?keyword=&quot;</span> <span class="token operator">+</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>searchResult <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> searchResult<span class="token punctuation">.</span><span class="token function">getTotalElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/search&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_7-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762" aria-hidden="true">#</a> 7.\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u9875\u9762</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!-- \u641C\u7D22\u8868\u5355 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>get<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/search}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--th:value-&gt;\u8BBE\u7F6E\u9ED8\u8BA4\u503C  model.addAttribute(&quot;keyword&quot;, keyword) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>search<span class="token punctuation">&quot;</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Search<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>keyword<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${keyword}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u641C\u7D22<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name"><span class="token namespace">th:</span>each</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>map:\${discussPosts}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name"><span class="token namespace">th:</span>src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.headerUrl}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\u7528\u6237\u5934\u50CF<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>50px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>50px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{|/discuss/detail/\${map.post.id}|}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.title}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>\u641C\u7D22\u8BCD\u9AD8\u4EAE\u663E\u793A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>\u53EF\u94FE\u63A5\u7684\u5E16\u5B50\u6807\u9898<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.content}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
       \u5E16\u5B50\u5185\u5BB9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>\u641C\u7D22\u8BCD\u9AD8\u4EAE\u663E\u793A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>u</span> <span class="token attr-name"><span class="token namespace">th:</span>utext</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.user.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5BD2\u6C5F\u96EA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>u</span><span class="token punctuation">&gt;</span></span>
      \u53D1\u5E03\u4E8E <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(map.post.createTime,&#39;yyyy-MM-dd HH:mm:ss&#39;)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5E16\u5B50\u53D1\u5E03\u65F6\u95F4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>\u8D5E <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.likeCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>|<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>\u56DE\u590D <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${map.post.commentCount}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u6743\u9650\u63A7\u5236" tabindex="-1"><a class="header-anchor" href="#\u6743\u9650\u63A7\u5236" aria-hidden="true">#</a> \u6743\u9650\u63A7\u5236</h2><p>\u90E8\u7F72SpringSecurity\u6743\u9650\u63A7\u5236</p><h3 id="_1-\u914D\u7F6Esecurityconfig\u7C7B" tabindex="-1"><a class="header-anchor" href="#_1-\u914D\u7F6Esecurityconfig\u7C7B" aria-hidden="true">#</a> 1.\u914D\u7F6ESecurityConfig\u7C7B</h3><p>\u767B\u5F55\u68C0\u67E5\uFF1A\u5E9F\u5F03\u4E4B\u524D\u7684\u62E6\u622A\u5668\u914D\u7F6E\uFF0C\u91C7\u7528SpringSecurity</p><p>\u6743\u9650\u914D\u7F6E\uFF1A\u5BF9\u6240\u6709\u8BF7\u6C42\u5206\u914D\u8BBF\u95EE\u6743\u9650</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> springsecurity\u914D\u7F6E
 <span class="token operator">*</span> \u4E4B\u6240\u4EE5\u6CA1\u6709<span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span>\uFF0C\u662F\u56E0\u4E3A\u8981\u7ED5\u8FC7security\u81EA\u5E26\u7684\u65B9\u6848
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> web<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5FFD\u7565\u9759\u6001\u8D44\u6E90</span>
        web<span class="token punctuation">.</span><span class="token function">ignoring</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/resources/* *&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u6388\u6743</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// \u9700\u8981\u6388\u6743\u7684\u8BF7\u6C42</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;/user/setting&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/user/upload&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/discuss/add&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/comment/add/* *&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/letter/* *&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/notice/* *&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/like&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/follow&quot;</span><span class="token punctuation">,</span>
                        <span class="token string">&quot;/unfollow&quot;</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// \u8FD93\u4E2D\u6743\u9650\u53EF\u4EE5\u8BBF\u95EE\u4EE5\u4E0A\u8BF7\u6C42</span>
                <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>
                        <span class="token constant">AUTHORITY_USER</span><span class="token punctuation">,</span>
                        <span class="token constant">AUTHORITY_ADMIN</span><span class="token punctuation">,</span>
                        <span class="token constant">AUTHORITY_MODERATOR</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// \u5176\u4ED6\u8BF7\u6C42\u65B9\u884C</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// \u7981\u7528 \u9632\u6B62csrf\u653B\u51FB\u529F\u80FD</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// \u6743\u9650\u4E0D\u591F\u65F6\u7684\u5904\u7406</span>
        http<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u6CA1\u6709\u767B\u5F55</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
                        <span class="token comment">// \u540C\u6B65\u8BF7\u6C42\u91CD\u5B9A\u5411\u8FD4\u56DEHTML\uFF0C\u5F02\u6B65\u8BF7\u6C42\u8FD4\u56DEjson</span>
                        <span class="token class-name">String</span> xRequestedWith <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-requested-with&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>xRequestedWith<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// \u5904\u7406\u5F02\u6B65\u8BF7\u6C42</span>
                            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/plain;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">&quot;\u4F60\u8FD8\u6CA1\u6709\u767B\u5F55\u54E6!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token comment">// \u6743\u9650\u4E0D\u8DB3</span>
                <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AccessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
                        <span class="token class-name">String</span> xRequestedWith <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-requested-with&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>xRequestedWith<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/plain;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">,</span> <span class="token string">&quot;\u4F60\u6CA1\u6709\u8BBF\u95EE\u6B64\u529F\u80FD\u7684\u6743\u9650!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/denied&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Security\u5E95\u5C42\u9ED8\u8BA4\u4F1A\u62E6\u622A/logout\u8BF7\u6C42,\u8FDB\u884C\u9000\u51FA\u5904\u7406.</span>
        <span class="token comment">// \u8986\u76D6\u5B83\u9ED8\u8BA4\u7684\u903B\u8F91,\u624D\u80FD\u6267\u884C\u6211\u4EEC\u81EA\u5DF1\u7684\u9000\u51FA\u4EE3\u7801.</span>
        <span class="token comment">//\u5E95\u5C42\uFF1Aprivate String logoutUrl = &quot;/logout&quot;;</span>
        http<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/securitylogout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199userservice" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199userservice" aria-hidden="true">#</a> 2.\u7F16\u5199UserService</h3><p>(\u589E\u52A0\u81EA\u5B9A\u4E49\u767B\u5F55\u8BA4\u8BC1\u65B9\u6CD5\u7ED5\u8FC7security\u81EA\u5E26\u8BA4\u8BC1\u6D41\u7A0B)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>\u7ED5\u8FC7<span class="token class-name">Security</span>\u8BA4\u8BC1\u6D41\u7A0B\uFF0C\u91C7\u7528\u539F\u6765\u7684\u8BA4\u8BC1\u65B9\u6848<span class="token punctuation">,</span>\u5C01\u88C5\u8BA4\u8BC1\u7ED3\u679C<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getAuthority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                        <span class="token keyword">return</span> <span class="token constant">AUTHORITY_ADMIN</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                        <span class="token keyword">return</span> <span class="token constant">AUTHORITY_MODERATOR</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">return</span> <span class="token constant">AUTHORITY_USER</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668loginticketinterceptor" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668loginticketinterceptor" aria-hidden="true">#</a> 3.\u7F16\u5199\u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668LoginTicketInterceptor</h3><p>\u6784\u5EFA\u7528\u6237\u8BA4\u8BC1\u7ED3\u679C,\u5E76\u5B58\u5165SecurityContext,\u4EE5\u4FBF\u4E8ESecurity\u8FDB\u884C\u6388\u6743</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token operator">/</span>\u5728<span class="token class-name">Controller</span>\u8BBF\u95EE\u6240\u6709\u8DEF\u5F84\u4E4B\u524D\u83B7\u53D6\u51ED\u8BC1<span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
      <span class="token comment">//...................................</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...............................</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> \u6784\u5EFA\u7528\u6237\u8BA4\u8BC1\u7ED3\u679C<span class="token punctuation">,</span>\u5E76\u5B58\u5165<span class="token class-name">SecurityContext</span><span class="token punctuation">,</span>\u4EE5\u4FBF\u4E8E<span class="token class-name">Security</span>\u8FDB\u884C\u6388\u6743
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u91CA\u653E\u7EBF\u7A0B\u8D44\u6E90</span>
        hostHolder<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u91CA\u653ESecurityContext\u8D44\u6E90</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u9000\u51FA\u767B\u5F55\u65F6\u91CA\u653Esecuritycontext\u8D44\u6E90" tabindex="-1"><a class="header-anchor" href="#_4-\u9000\u51FA\u767B\u5F55\u65F6\u91CA\u653Esecuritycontext\u8D44\u6E90" aria-hidden="true">#</a> 4.\u9000\u51FA\u767B\u5F55\u65F6\u91CA\u653ESecurityContext\u8D44\u6E90</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u9000\u51FA\u767B\u5F55\u529F\u80FD
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token annotation punctuation">@CookieValue</span><span class="token punctuation">(</span><span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> ticket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u91CA\u653ESecurityContext\u8D44\u6E90</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/login&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u6CE8\u610F-\u9632\u6B62csrf\u653B\u51FB" tabindex="-1"><a class="header-anchor" href="#_5-\u6CE8\u610F-\u9632\u6B62csrf\u653B\u51FB" aria-hidden="true">#</a> 5.\u6CE8\u610F\uFF1A\u9632\u6B62CSRF\u653B\u51FB</h3><p>CSRF\u653B\u51FB\u539F\u7406</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/\u9632\u6B62CSRF\u653B\u51FB_QpYgUwPumB.PNG" alt="CSRF\u653B\u51FB\u539F\u7406"></p><p>\u7531\u4E8E\u670D\u52A1\u7AEFSpringSecurity\u81EA\u5E26\u9632\u6B62CSRF\u653B\u51FB\uFF0C\u56E0\u6B64\u53EA\u8981\u7F16\u5199\u524D\u7AEF\u9875\u9762\u9632\u6B62CSRF\u653B\u51FB\u5373\u53EF \\ \uFF08\u5E38\u53D1\u751F\u5728\u63D0\u4EA4\u8868\u5355\u65F6\uFF09</p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!--\u8BBF\u95EE\u8BE5\u9875\u9762\u65F6,\u5728\u6B64\u5904\u751F\u6210CSRF\u4EE4\u724C.--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.token}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf_header<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${_csrf.headerName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ajax\u5F02\u6B65\u8BF7\u6C42\u65F6\u643A\u5E26\u8BE5\u53C2\u6570</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#publishModal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">&quot;hide&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// \u53D1\u9001AJAX\u8BF7\u6C42\u4E4B\u524D,\u5C06CSRF\u4EE4\u724C\u8BBE\u7F6E\u5230\u8BF7\u6C42\u7684\u6D88\u606F\u5934\u4E2D.</span>
   <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;meta[name=&#39;_csrf&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">var</span> header <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;meta[name=&#39;_csrf_header&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ajaxSend</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> xhr<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>header<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ...............................</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664" tabindex="-1"><a class="header-anchor" href="#\u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664" aria-hidden="true">#</a> \u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664</h2><h3 id="_1-\u7F16\u5199mapper\u3001service\u5C42" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199mapper\u3001service\u5C42" aria-hidden="true">#</a> 1.\u7F16\u5199Mapper\u3001Service\u5C42</h3><p>\u601D\u8DEF\uFF1A\u6539\u53D8\u5E16\u5B50\u72B6\u6001</p><p>\u7F6E\u9876\uFF1Atype = (0-\u6B63\u5E38\uFF0C1-\u7F6E\u9876\uFF09 \u52A0\u7CBE\uFF1Astatus = (0-\u6B63\u5E38\uFF0C1-\u52A0\u7CBE\uFF0C2-\u5220\u9664)</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>    <span class="token keyword">int</span> updateType<span class="token punctuation">(</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> id<span class="token punctuation">,</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> updateStatus<span class="token punctuation">(</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> id<span class="token punctuation">,</span><span class="token variable">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--------------------Mapper.xml-------------------------&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">update</span> id<span class="token operator">=</span><span class="token string">&quot;updateType&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">update</span> discuss_post <span class="token keyword">set</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token comment">#{type} where id = #{id}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">update</span> id<span class="token operator">=</span><span class="token string">&quot;updateStatus&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">update</span> discuss_post <span class="token keyword">set</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token comment">#{status} where id = #{id}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">update</span><span class="token operator">&gt;</span>
    
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token comment">--------------------Service\u5C42-------------------------&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> updateType<span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">type</span><span class="token punctuation">)</span> {
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span>updateType<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }

    <span class="token keyword">public</span> <span class="token keyword">int</span> updateStatus<span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">status</span><span class="token punctuation">)</span> {
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span>updateStatus<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199discusspostcontroller\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199discusspostcontroller\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199DiscussPostController\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u7F6E\u9876\u3001\u53D6\u6D88\u7F6E\u9876(\u4E0E\u4EE5\u4E0B\u7C7B\u4F3C)</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/top&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setTop</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u7F6E\u9876\u72B6\u6001\uFF0C1\u4E3A\u7F6E\u9876\uFF0C0\u4E3A\u6B63\u5E38\u72B6\u6001,1^1=0 0^1=1</span>
        <span class="token keyword">int</span> type <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">;</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateType</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8FD4\u56DE\u7ED3\u679C\u7ED9JS\u5F02\u6B65\u8BF7\u6C42</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u89E6\u53D1\u4E8B\u4EF6\uFF0C\u4FEE\u6539Elasticsearch\u4E2D\u7684\u5E16\u5B50type</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_PUBILISH</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u52A0\u7CBE\u3001\u53D6\u6D88\u52A0\u7CBE</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/wonderful&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setWonderful</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">;</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8FD4\u56DE\u7ED3\u679C\u7ED9JS\u5F02\u6B65\u8BF7\u6C42</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u89E6\u53D1\u4E8B\u4EF6\uFF0C\u4FEE\u6539Elasticsearch\u4E2D\u7684\u5E16\u5B50status</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_PUBILISH</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u5220\u9664</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/delete&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">setDelete</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u89E6\u53D1\u5220\u5E16\u4E8B\u4EF6,\u5C06\u5E16\u5B50\u4ECEElasticsearch\u4E2D\u5220\u9664</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_DELETE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199kafka\u6D88\u8D39\u8005\u4E2D" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199kafka\u6D88\u8D39\u8005\u4E2D" aria-hidden="true">#</a> 3.\u7F16\u5199Kafka\u6D88\u8D39\u8005\u4E2D</h3><p>\u5220\u9664\uFF08TOPIC_DELETE\uFF09\u7684\u4E3B\u9898\u4E8B\u4EF6</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>\u5E16\u5B50\u5220\u9664\u4E8B\u4EF6<span class="token operator">/</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token constant">TOPIC_DELETE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDeleteMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u7684\u5185\u5BB9\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5C06record.value\u5B57\u7B26\u4E32\u683C\u5F0F\u8F6C\u5316\u4E3AEvent\u5BF9\u8C61</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6CE8\u610F\uFF1Aevent\u82E5data=null,\u662Ffastjson\u4F9D\u8D56\u7248\u672C\u7684\u95EE\u9898</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u683C\u5F0F\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        elasticsearchService<span class="token punctuation">.</span><span class="token function">deleteDiscussPost</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u5728securityconfig\u4E2D\u7ED9\u4E88-\u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664-\u6743\u9650" tabindex="-1"><a class="header-anchor" href="#_4-\u5728securityconfig\u4E2D\u7ED9\u4E88-\u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664-\u6743\u9650" aria-hidden="true">#</a> 4.\u5728SecurityConfig\u4E2D\u7ED9\u4E88\uFF08\u7F6E\u9876\u3001\u52A0\u7CBE\u3001\u5220\u9664\uFF09\u6743\u9650</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>  <span class="token comment">// \u6388\u6743</span>
  http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// \u9700\u8981\u6388\u6743\u7684\u8BF7\u6C42</span>
          <span class="token comment">// ...............</span>
          <span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
                  <span class="token string">&quot;/discuss/top&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;/discuss/wonderful&quot;</span>
          <span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>
                  <span class="token constant">AUTHORITY_MODERATOR</span> <span class="token comment">// \u7248\u4E3B\u6388\u4E88\u52A0\u7CBE\u3001\u7F6E\u9876\u6743\u9650</span>
          <span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
                  <span class="token string">&quot;/discuss/delete&quot;</span>
          <span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>
                  <span class="token constant">AUTHORITY_ADMIN</span> <span class="token comment">// \u7BA1\u7406\u5458\u6388\u4E88\u5220\u9664\u5E16\u5B50\u6743\u9650</span>
          <span class="token punctuation">)</span>
          <span class="token comment">// \u5176\u4ED6\u8BF7\u6C42\u65B9\u884C</span>
          <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// \u7981\u7528 \u9632\u6B62csrf\u653B\u51FB\u529F\u80FD</span>
          <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u4EE3\u7801" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u4EE3\u7801" aria-hidden="true">#</a> 5.\u7F16\u5199\u524D\u7AEF\u6838\u5FC3\u4EE3\u7801</h3><h4 id="_5-1\u5F15\u7528pom-xml-\u4F7F\u7528sec-xxx" tabindex="-1"><a class="header-anchor" href="#_5-1\u5F15\u7528pom-xml-\u4F7F\u7528sec-xxx" aria-hidden="true">#</a> 5.1\u5F15\u7528pom.xml\uFF0C\u4F7F\u7528sec:xxx</h4><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.thymeleaf.extras<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>thymeleaf-extras-springsecurity5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-\u5F15\u5165thymeleaf\u652F\u6301security\u7684\u5934\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_5-2-\u5F15\u5165thymeleaf\u652F\u6301security\u7684\u5934\u6587\u4EF6" aria-hidden="true">#</a> 5.2 \u5F15\u5165thymeleaf\u652F\u6301security\u7684\u5934\u6587\u4EF6</h4><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>th</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>sec</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.thymeleaf.org/extras/spring-security<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>postId<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${post.id}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>topBtn<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${post.type==1?&#39;\u53D6\u6D88\u7F6E\u9876&#39;:&#39;\u7F6E\u9876&#39;}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasAnyAuthority(&#39;moderator&#39;)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u7F6E\u9876<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>wonderfulBtn<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${post.status==1?&#39;\u53D6\u6D88\u52A0\u7CBE&#39;:&#39;\u52A0\u7CBE&#39;}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasAnyAuthority(&#39;moderator&#39;)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u52A0\u7CBE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>deleteBtn<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">th:</span>disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${post.status==2}<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">sec:</span>authorize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hasAnyAuthority(&#39;admin&#39;)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5220\u9664<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-\u7F16\u5199js\u4E2D\u7684\u5F02\u6B65ajax\u8BF7\u6C42" tabindex="-1"><a class="header-anchor" href="#_5-3-\u7F16\u5199js\u4E2D\u7684\u5F02\u6B65ajax\u8BF7\u6C42" aria-hidden="true">#</a> 5.3 \u7F16\u5199JS\u4E2D\u7684\u5F02\u6B65Ajax\u8BF7\u6C42</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \u9875\u9762\u52A0\u8F7D\u5B8C\u4EE5\u540E\u8C03\u7528</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#topBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>setTop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#wonderfulBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>setWonderful<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#deleteBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span>setDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// \u7F6E\u9876\u3001\u53D6\u6D88\u7F6E\u9876</span>
<span class="token keyword">function</span> <span class="token function">setTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/discuss/top&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#topBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&#39;\u53D6\u6D88\u7F6E\u9876&#39;</span><span class="token operator">:</span><span class="token string">&#39;\u7F6E\u9876&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// \u52A0\u7CBE\u3001\u53D6\u6D88\u52A0\u7CBE</span>
<span class="token keyword">function</span> <span class="token function">setWonderful</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/discuss/wonderful&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#wonderfulBtn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&#39;\u53D6\u6D88\u52A0\u7CBE&#39;</span><span class="token operator">:</span><span class="token string">&#39;\u52A0\u7CBE&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// \u5220\u9664</span>
<span class="token keyword">function</span> <span class="token function">setDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
        <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/discuss/delete&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#postId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u7F51\u7AD9\u6570\u636E\u7EDF\u8BA1" tabindex="-1"><a class="header-anchor" href="#\u7F51\u7AD9\u6570\u636E\u7EDF\u8BA1" aria-hidden="true">#</a> \u7F51\u7AD9\u6570\u636E\u7EDF\u8BA1</h2><p>\uFF08Redis\uFF1AHyperLogLog\u3001BitMap\uFF09</p><h3 id="_1-\u7F16\u5199redisutil\u89C4\u8303key\u503C" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199redisutil\u89C4\u8303key\u503C" aria-hidden="true">#</a> 1.\u7F16\u5199RedisUtil\u89C4\u8303Key\u503C</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// UV (\u7F51\u7AD9\u8BBF\u95EE\u7528\u6237\u6570\u91CF---\u6839\u636EIp\u5730\u5740\u7EDF\u8BA1(\u5305\u62EC\u6CA1\u6709\u767B\u5F55\u7684\u7528\u6237))</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_UV</span> <span class="token operator">=</span> <span class="token string">&quot;uv&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// DAU (\u6D3B\u8DC3\u7528\u6237\u6570\u91CF---\u6839\u636EuserId)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_DAU</span> <span class="token operator">=</span> <span class="token string">&quot;dau&quot;</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u5B58\u50A8\u5355\u65E5ip\u8BBF\u95EE\u6570\u91CF\uFF08uv\uFF09<span class="token operator">--</span><span class="token class-name">HyperLogLog</span> <span class="token operator">--</span><span class="token operator">-</span>k<span class="token operator">:</span>\u65F6\u95F4 v<span class="token operator">:</span>ip  <span class="token punctuation">(</span><span class="token class-name">HyperLogLog</span><span class="token punctuation">)</span>
     <span class="token operator">*</span> \u793A\u4F8B\uFF1Auv<span class="token operator">:</span><span class="token number">20220526</span> <span class="token operator">=</span> ip1<span class="token punctuation">,</span>ip2<span class="token punctuation">,</span>ip3<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUVKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_UV</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u83B7\u53D6\u533A\u95F4ip\u8BBF\u95EE\u6570\u91CF\uFF08uv\uFF09
     <span class="token operator">*</span> \u793A\u4F8B\uFF1Auv<span class="token operator">:</span><span class="token number">20220525</span><span class="token operator">:</span><span class="token number">20220526</span> <span class="token operator">=</span> ip1<span class="token punctuation">,</span>ip2<span class="token punctuation">,</span>ip3<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUVKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> startDate<span class="token punctuation">,</span> <span class="token class-name">String</span> endDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_UV</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> startDate <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> endDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u5B58\u50A8\u5355\u65E5\u6D3B\u8DC3\u7528\u6237\uFF08dau\uFF09<span class="token operator">--</span><span class="token class-name">BitMap</span> <span class="token operator">--</span><span class="token operator">-</span>k<span class="token operator">:</span>date v<span class="token operator">:</span>userId\u7D22\u5F15\u4E0B\u4E3A<span class="token boolean">true</span>  <span class="token punctuation">(</span><span class="token class-name">BitMap</span><span class="token punctuation">)</span>
     <span class="token operator">*</span> \u793A\u4F8B\uFF1Adau<span class="token operator">:</span><span class="token number">20220526</span> <span class="token operator">=</span> userId1\u7D22\u5F15<span class="token operator">--</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>userId2\u7D22\u5F15<span class="token operator">--</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDAUKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_DAU</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> date<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u83B7\u53D6\u533A\u95F4\u6D3B\u8DC3\u7528\u6237
     <span class="token operator">*</span> \u793A\u4F8B\uFF1Adau<span class="token operator">:</span><span class="token number">20220526</span><span class="token operator">:</span><span class="token number">20220526</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDAUKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> startDate<span class="token punctuation">,</span> <span class="token class-name">String</span> endDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_DAU</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> startDate <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> endDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199dataservice\u4E1A\u52A1\u5C42" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199dataservice\u4E1A\u52A1\u5C42" aria-hidden="true">#</a> 2.\u7F16\u5199DataService\u4E1A\u52A1\u5C42</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">// \u5C06Date\u7C7B\u578B\u8F6C\u5316\u4E3AString\u7C7B\u578B</span>
    <span class="token keyword">private</span> <span class="token class-name">SimpleDateFormat</span> df <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyyMMdd&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* HypeLogLog*/</span>
    <span class="token comment">// \u5C06\u6307\u5B9Aip\u8BA1\u5165UV---k:\u5F53\u524D\u65F6\u95F4 v:ip</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordUV</span><span class="token punctuation">(</span><span class="token class-name">String</span> ip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u7EDF\u8BA1\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\u7684ip\u8BBF\u95EE\u6570UV</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateUV</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u65F6\u95F4\u6BB5\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u6574\u7406\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u7684Key</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u83B7\u53D6\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u7684\u6BCF\u4E00\u5929\u7684Key\u5B58\u5165\u96C6\u5408</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u65E5\u671F+1(\u6309\u7167\u65E5\u5386\u683C\u5F0F)</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u5408\u5E76\u65E5\u671F\u8303\u56F4\u5185\u76F8\u540C\u7684ip</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6keyList\u4E2D\u7684\u6BCF\u4E00\u5217key\u8FDB\u884C\u5408\u5E76</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8FD4\u56DE\u7EDF\u8BA1\u7ED3\u679C</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* BitMap */</span>
    <span class="token comment">// \u5C06\u6307\u5B9A\u7528\u6237\u8BA1\u5165DAU --k:\u5F53\u524D\u65F6\u95F4 v:userId</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordDAU</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBit</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> userId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u7EDF\u8BA1\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\u7684DAU\u65E5\u6D3B\u8DC3\u7528\u6237</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateDAU</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BF7\u8F93\u5165\u6B63\u786E\u7684\u65F6\u95F4\u6BB5\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u6574\u7406\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u7684Key</span>
        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u65E5\u671F+1(\u6309\u7167\u65E5\u5386\u683C\u5F0F)</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u8FDB\u884COR\u8FD0\u7B97</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedisCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doInRedis</span><span class="token punctuation">(</span><span class="token class-name">RedisConnection</span> connection<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DataAccessException</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> df<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                connection<span class="token punctuation">.</span><span class="token function">bitOp</span><span class="token punctuation">(</span><span class="token class-name">RedisStringCommands<span class="token punctuation">.</span>BitOperation</span><span class="token punctuation">.</span><span class="token constant">OR</span><span class="token punctuation">,</span> redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">bitCount</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u5728datainterceptor\u62E6\u622A\u5668\u4E2D\u8C03\u7528service-\u6BCF\u6B21\u8BF7\u6C42\u6700\u5F00\u59CB\u8C03\u7528" tabindex="-1"><a class="header-anchor" href="#_3-\u5728datainterceptor\u62E6\u622A\u5668\u4E2D\u8C03\u7528service-\u6BCF\u6B21\u8BF7\u6C42\u6700\u5F00\u59CB\u8C03\u7528" aria-hidden="true">#</a> 3.\u5728DataInterceptor\u62E6\u622A\u5668\u4E2D\u8C03\u7528Service(\u6BCF\u6B21\u8BF7\u6C42\u6700\u5F00\u59CB\u8C03\u7528)</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">HostHolder</span> hostHolder<span class="token punctuation">;</span>
    <span class="token comment">// \u5728\u6240\u6709\u8BF7\u6C42\u4E4B\u524D\u5B58\u7528\u6237\u8BBF\u95EE\u6570\u548C\u65E5\u6D3B\u8DC3\u4EBA\u6570</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u83B7\u53D6\u8BF7\u6C42\u7528\u6237\u7684ip\u5730\u5740\uFF0C\u7EDF\u8BA1UV</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataService<span class="token punctuation">.</span><span class="token function">recordUV</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u7EDF\u8BA1DAU</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataService<span class="token punctuation">.</span><span class="token function">recordDAU</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*\u6CE8\u518C\u62E6\u622A\u5668*/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMvcConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataInterceptor</span> dataInterceptor<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>dataInterceptor<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">excludePathPatterns</span><span class="token punctuation">(</span><span class="token string">&quot;/* */*.css&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/ / *.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/* */*.png&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;// *.jpg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/* */*.jpeg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u7F16\u5199datacontroller\u7528\u4EE5\u6E32\u67D3\u6A21\u677F" tabindex="-1"><a class="header-anchor" href="#_4-\u7F16\u5199datacontroller\u7528\u4EE5\u6E32\u67D3\u6A21\u677F" aria-hidden="true">#</a> 4.\u7F16\u5199DataController\u7528\u4EE5\u6E32\u67D3\u6A21\u677F</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u7EDF\u8BA1\u9875\u9762
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/data&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDataPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/admin/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u7EDF\u8BA1\u7F51\u7AD9<span class="token function">UV</span><span class="token punctuation">(</span>ip\u8BBF\u95EE\u6570\u91CF<span class="token punctuation">)</span>
     <span class="token operator">*</span> <span class="token annotation punctuation">@DateTimeFormat</span>\u5C06\u65F6\u95F4\u53C2\u6570\u8F6C\u5316\u4E3A\u5B57\u7B26\u4E32
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/uv&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUV</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> uv <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateUV</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvResult&quot;</span><span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8F6C\u53D1\u5230 /data\u8BF7\u6C42</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u7EDF\u8BA1\u7F51\u7AD9<span class="token function">DAU</span><span class="token punctuation">(</span>\u767B\u5F55\u7528\u6237\u8BBF\u95EE\u6570\u91CF<span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/dau&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDAU</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> dau <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateDAU</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauResult&quot;</span><span class="token punctuation">,</span> dau<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u7F16\u5199securityconfig\u8FDB\u884C\u6743\u9650\u63A7\u5236" tabindex="-1"><a class="header-anchor" href="#_5-\u7F16\u5199securityconfig\u8FDB\u884C\u6743\u9650\u63A7\u5236" aria-hidden="true">#</a> 5.\u7F16\u5199SecurityConfig\u8FDB\u884C\u6743\u9650\u63A7\u5236</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
            <span class="token string">&quot;/discuss/delete&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;/data/* *&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>
            <span class="token constant">AUTHORITY_ADMIN</span>
    <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-\u7F16\u5199\u524D\u7AEF\u7BA1\u7406\u5458\u4E13\u7528\u9875\u9762" tabindex="-1"><a class="header-anchor" href="#_6-\u7F16\u5199\u524D\u7AEF\u7BA1\u7406\u5458\u4E13\u7528\u9875\u9762" aria-hidden="true">#</a> 6.\u7F16\u5199\u524D\u7AEF\u7BA1\u7406\u5458\u4E13\u7528\u9875\u9762</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!-- \u7F51\u7AD9UV (\u6D3B\u8DC3\u7528\u6237\u7C7B\u4F3C)--&gt;</span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h6</span><span class="token punctuation">&gt;</span></span> \u7F51\u7AD9 \u8BBF\u95EE\u4EBA\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h6</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/data/uv}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>start<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(uvStartDate,&#39;yyyy-MM-dd&#39;)}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>date<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>end<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${#dates.format(uvEndDate,&#39;yyyy-MM-dd&#39;)}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>date<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u5F00\u59CB\u7EDF\u8BA1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
          \u7EDF\u8BA1\u7ED3\u679C
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name"><span class="token namespace">th:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>\${uvResult}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u8BBF\u95EE\u4EBA\u6570<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span> 
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u70ED\u5E16\u6392\u884C" tabindex="-1"><a class="header-anchor" href="#\u70ED\u5E16\u6392\u884C" aria-hidden="true">#</a> \u70ED\u5E16\u6392\u884C</h2><p>\uFF08Quartz\u7EBF\u7A0B\u6C60\u3001Redis\uFF09</p><h3 id="_1-\u7F16\u5199redisutil\u89C4\u8303key\u503C-1" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199redisutil\u89C4\u8303key\u503C-1" aria-hidden="true">#</a> 1.\u7F16\u5199RedisUtil\u89C4\u8303Key\u503C</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u70ED\u5E16\u5206\u6570 (\u628A\u9700\u8981\u66F4\u65B0\u7684\u5E16\u5B50id\u5B58\u5165Redis\u5F53\u4F5C\u7F13\u5B58)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_POST</span> <span class="token operator">=</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">;</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span>  \u5E16\u5B50\u5206\u6570 <span class="token punctuation">(</span>\u53D1\u5E03\u3001\u70B9\u8D5E\u3001\u52A0\u7CBE\u3001\u8BC4\u8BBA\u65F6\u653E\u5165<span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">PREFIX_POST</span> <span class="token operator">+</span> <span class="token constant">SPLIT</span> <span class="token operator">+</span> <span class="token string">&quot;score&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u5904\u7406\u53D1\u5E03\u3001\u70B9\u8D5E\u3001\u52A0\u7CBE\u3001\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5206\u6570-\u5C06\u5E16\u5B50id\u5B58\u5165key" tabindex="-1"><a class="header-anchor" href="#_2-\u5904\u7406\u53D1\u5E03\u3001\u70B9\u8D5E\u3001\u52A0\u7CBE\u3001\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5206\u6570-\u5C06\u5E16\u5B50id\u5B58\u5165key" aria-hidden="true">#</a> 2.\u5904\u7406\u53D1\u5E03\u3001\u70B9\u8D5E\u3001\u52A0\u7CBE\u3001\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5206\u6570\uFF0C\u5C06\u5E16\u5B50id\u5B58\u5165Key</h3><h4 id="_2-1\u53D1\u5E03\u5E16\u5B50\u65F6\u521D\u59CB\u5316\u5206\u6570" tabindex="-1"><a class="header-anchor" href="#_2-1\u53D1\u5E03\u5E16\u5B50\u65F6\u521D\u59CB\u5316\u5206\u6570" aria-hidden="true">#</a> 2.1\u53D1\u5E03\u5E16\u5B50\u65F6\u521D\u59CB\u5316\u5206\u6570</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>      <span class="token operator">/</span>
       <span class="token operator">*</span> \u8BA1\u7B97\u5E16\u5B50\u5206\u6570
       <span class="token operator">*</span> \u5C06\u65B0\u53D1\u5E03\u7684\u5E16\u5B50id\u5B58\u5165set\u53BB\u91CD\u7684redis\u96C6\u5408<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token function">addDiscussPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token operator">*</span><span class="token operator">/</span>
      <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2\u70B9\u8D5E\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" tabindex="-1"><a class="header-anchor" href="#_2-2\u70B9\u8D5E\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" aria-hidden="true">#</a> 2.2\u70B9\u8D5E\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>      <span class="token operator">/</span>
       <span class="token operator">*</span> \u8BA1\u7B97\u5E16\u5B50\u5206\u6570
       <span class="token operator">*</span> \u5C06\u70B9\u8D5E\u8FC7\u7684\u5E16\u5B50id\u5B58\u5165set\u53BB\u91CD\u7684redis\u96C6\u5408<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token operator">*</span><span class="token operator">/</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entityType <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" tabindex="-1"><a class="header-anchor" href="#_2-3\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" aria-hidden="true">#</a> 2.3\u8BC4\u8BBA\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>      <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token operator">/</span>
          <span class="token operator">*</span> \u8BA1\u7B97\u5E16\u5B50\u5206\u6570
          <span class="token operator">*</span> \u5C06\u8BC4\u8BBA\u8FC7\u7684\u5E16\u5B50id\u5B58\u5165set\u53BB\u91CD\u7684redis\u96C6\u5408<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token function">addComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token operator">*</span><span class="token operator">/</span>
          <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-4\u52A0\u7CBE\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" tabindex="-1"><a class="header-anchor" href="#_2-4\u52A0\u7CBE\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570" aria-hidden="true">#</a> 2.4\u52A0\u7CBE\u65F6\u8BA1\u7B97\u5E16\u5B50\u5206\u6570</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>      <span class="token operator">/</span>
       <span class="token operator">*</span> \u8BA1\u7B97\u5E16\u5B50\u5206\u6570
       <span class="token operator">*</span> \u5C06\u52A0\u7CBE\u7684\u5E16\u5B50id\u5B58\u5165set\u53BB\u91CD\u7684redis\u96C6\u5408<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token function">setWonderful</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token operator">*</span><span class="token operator">/</span>
      <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u5B9A\u4E49quartz\u70ED\u5E16\u6392\u884Cjob" tabindex="-1"><a class="header-anchor" href="#_3-\u5B9A\u4E49quartz\u70ED\u5E16\u6392\u884Cjob" aria-hidden="true">#</a> 3.\u5B9A\u4E49Quartz\u70ED\u5E16\u6392\u884CJob</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>\u70ED\u5E16\u6392\u884C\u5B9A\u65F6\u5237\u65B0\u4EFB\u52A1<span class="token operator">/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostScoreRefreshJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span><span class="token punctuation">,</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostService</span> discussPostService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token comment">// \u7F51\u7AD9\u521B\u5EFA\u65F6\u95F4</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> epoch<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            epoch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2014-10-22 00:00:00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u521D\u59CB\u5316\u65F6\u95F4\u5931\u8D25!&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5904\u7406\u6BCF\u4E00\u4E2Akey</span>
        <span class="token class-name">BoundSetOperations</span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u53D6\u6D88] \u6CA1\u6709\u9700\u8981\u5237\u65B0\u7684\u5E16\u5B50&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u5F00\u59CB] \u6B63\u5728\u5237\u65B0\u5E16\u5B50\u5206\u6570&quot;</span> <span class="token operator">+</span> operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u5237\u65B0\u6BCF\u4E00\u4E2A\u4ECEset\u96C6\u5408\u91CC\u5F39\u51FA\u7684postId</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span>operations<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u7ED3\u675F] \u5E16\u5B50\u5206\u6570\u5237\u65B0\u5B8C\u6BD5\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// \u4ECEredis\u4E2D\u53D6\u51FA\u6BCF\u4E00\u4E2Avalue:postId</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span> postId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>post <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u5E16\u5B50\u4E0D\u5B58\u5728\uFF1Aid = &quot;</span> <span class="token operator">+</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u5E16\u5B50\u5DF2\u88AB\u5220\u9664&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">/</span>
         <span class="token operator">*</span> \u5E16\u5B50\u5206\u6570\u8BA1\u7B97\u516C\u5F0F\uFF1A<span class="token punctuation">[</span>\u52A0\u7CBE\uFF08<span class="token number">75</span>\uFF09<span class="token operator">+</span> \u8BC4\u8BBA\u6570<span class="token operator">*</span>  <span class="token number">10</span> <span class="token operator">+</span> \u70B9\u8D5E\u6570<span class="token operator">*</span>  <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> \u8DDD\u79BB\u5929\u6570
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token comment">// \u662F\u5426\u52A0\u7CBE\u5E16\u5B50</span>
        <span class="token keyword">boolean</span> wonderful <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">long</span> liketCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8BC4\u8BBA\u6570\u91CF</span>
        <span class="token keyword">int</span> commentCount <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getCommentCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8BA1\u7B97\u6743\u91CD</span>
        <span class="token keyword">double</span> weight <span class="token operator">=</span> <span class="token punctuation">(</span>wonderful <span class="token operator">?</span> <span class="token number">75</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> commentCount<span class="token operator">*</span>  <span class="token number">10</span> <span class="token operator">+</span> liketCount<span class="token operator">*</span>  <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5206\u6570 = \u53D6\u5BF9\u6570(\u5E16\u5B50\u6743\u91CD) + \u8DDD\u79BB\u5929\u6570</span>
        <span class="token keyword">double</span> score <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log10</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> epoch<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">*</span>  <span class="token number">3600</span><span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u66F4\u65B0\u5E16\u5B50\u5206\u6570</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateScore</span><span class="token punctuation">(</span>postId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u540C\u6B65\u641C\u7D22\u6570\u636E</span>
        post<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
        elasticsearchService<span class="token punctuation">.</span><span class="token function">saveDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u914D\u7F6Equartz\u7684postscorerefreshjob" tabindex="-1"><a class="header-anchor" href="#_4-\u914D\u7F6Equartz\u7684postscorerefreshjob" aria-hidden="true">#</a> 4.\u914D\u7F6EQuartz\u7684PostScoreRefreshJob</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JobDetailFactoryBean</span> <span class="token function">postScoreRefreshJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JobDetailFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobDetailFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobClass</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshJob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;communityGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setDurability</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRequestsRecovery</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SimpleTriggerFactoryBean</span> <span class="token class-name">PostScoreRefreshTrigger</span><span class="token punctuation">(</span><span class="token class-name">JobDetail</span> postScoreRefreshJobDetail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleTriggerFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTriggerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDetail</span><span class="token punctuation">(</span>postScoreRefreshJobDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshTrigger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;communityTriggerGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRepeatInterval</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDataMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-\u4FEE\u6539\u4E3B\u9875\u5E16\u5B50\u663E\u793A" tabindex="-1"><a class="header-anchor" href="#_5-\u4FEE\u6539\u4E3B\u9875\u5E16\u5B50\u663E\u793A" aria-hidden="true">#</a> 5.\u4FEE\u6539\u4E3B\u9875\u5E16\u5B50\u663E\u793A</h3><p>(Mapper\u3001Service\u3001Controller\u4E2D)</p><h4 id="_5-1-mapper" tabindex="-1"><a class="header-anchor" href="#_5-1-mapper" aria-hidden="true">#</a> 5.1 Mapper</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// orderMode=0\uFF1A\u6700\u65B0  orderMode=1\uFF1A\u6700\u70ED</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;offset&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;limit&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;orderMode&quot;</span><span class="token punctuation">)</span><span class="token keyword">int</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code>    <span class="token operator">&lt;</span><span class="token keyword">select</span> id<span class="token operator">=</span><span class="token string">&quot;selectDiscussPosts&quot;</span> resultType<span class="token operator">=</span><span class="token string">&quot;DiscussPost&quot;</span><span class="token operator">&gt;</span>
        <span class="token keyword">select</span>
        <span class="token operator">&lt;</span>include refid<span class="token operator">=</span><span class="token string">&quot;selectFields&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>
        <span class="token keyword">from</span> discuss_post
        <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">!=</span><span class="token number">2</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;userId!=0&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">and</span> user_id<span class="token operator">=</span><span class="token comment">#{userId}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;orderMode==0&quot;</span><span class="token operator">&gt;</span>
            <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">type</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>create_time <span class="token keyword">desc</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token keyword">if</span> test<span class="token operator">=</span><span class="token string">&quot;orderMode==1&quot;</span><span class="token operator">&gt;</span>
            <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">type</span> <span class="token keyword">desc</span><span class="token punctuation">,</span>score <span class="token keyword">desc</span><span class="token punctuation">,</span>create_time <span class="token keyword">desc</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">if</span><span class="token operator">&gt;</span>
        <span class="token keyword">limit</span> <span class="token comment">#{offset},#{limit}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">select</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-service" tabindex="-1"><a class="header-anchor" href="#_5-2-service" aria-hidden="true">#</a> 5.2 Service</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> orderMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-controller" tabindex="-1"><a class="header-anchor" href="#_5-3-controller" aria-hidden="true">#</a> 5.3 Controller</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token comment">// @RequestParam(name = &quot;orderMode&quot;) \u8FD9\u662F\u4ECE\u524D\u7AEF\u4F20\u53C2\u6570\u65B9\u6CD5\u662F\uFF1A/index?xx \u4E0EController\u7ED1\u5B9A</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getIndexPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;orderMode&quot;</span><span class="token punctuation">,</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> orderMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/index?orderMode=&quot;</span> <span class="token operator">+</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> discussPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post<span class="token operator">:</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token constant">ENTITY_TYPE_POST</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                discussPost<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;discussPosts&quot;</span><span class="token punctuation">,</span> discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;orderMode&quot;</span><span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/index&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-\u7F16\u5199\u524D\u7AEF\u9875\u9762\u5B9E\u73B0\u5207\u6362\u6700\u65B0-\u6700\u70ED\u5E16\u5B50\u663E\u793A" tabindex="-1"><a class="header-anchor" href="#_6-\u7F16\u5199\u524D\u7AEF\u9875\u9762\u5B9E\u73B0\u5207\u6362\u6700\u65B0-\u6700\u70ED\u5E16\u5B50\u663E\u793A" aria-hidden="true">#</a> 6.\u7F16\u5199\u524D\u7AEF\u9875\u9762\u5B9E\u73B0\u5207\u6362\u6700\u65B0/\u6700\u70ED\u5E16\u5B50\u663E\u793A</h3><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>  <span class="token comment">&lt;!-- \u5207\u6362\u6700\u65B0/\u6700\u70ED\u5E16\u5B50 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|nav-link \${orderMode==0?&#39;active&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/index(orderMode=0)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6700\u65B0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav-item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name"><span class="token namespace">th:</span>class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>|nav-link \${orderMode==1?&#39;active&#39;:&#39;&#39;}|<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">th:</span>href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>@{/index(orderMode=1)}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>\u6700\u70ED<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="\u6587\u4EF6\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#\u6587\u4EF6\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" aria-hidden="true">#</a> \u6587\u4EF6\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668</h1><p>(\u7ED1\u5B9A\u4E03\u725B\u4E91\u670D\u52A1\u5668)</p><h2 id="\u7ED1\u5B9A\u4E91\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#\u7ED1\u5B9A\u4E91\u670D\u52A1\u5668" aria-hidden="true">#</a> \u7ED1\u5B9A\u4E91\u670D\u52A1\u5668</h2><h3 id="_1-\u5F15\u5165pom-xml-1" tabindex="-1"><a class="header-anchor" href="#_1-\u5F15\u5165pom-xml-1" aria-hidden="true">#</a> 1.\u5F15\u5165pom.xml</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token comment">&lt;!--\u4E03\u725B\u4E91\u670D\u52A1\u5668--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.qiniu<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>qiniu-java-sdk<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>7.2.28<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u914D\u7F6Eyml\u6587\u4EF6" tabindex="-1"><a class="header-anchor" href="#_2-\u914D\u7F6Eyml\u6587\u4EF6" aria-hidden="true">#</a> 2.\u914D\u7F6Eyml\u6587\u4EF6</h3><p>\uFF08\u670D\u52A1\u5668\u53C2\u6570\uFF09</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># qiniu</span>
<span class="token key atrule">qiniu</span><span class="token punctuation">:</span>
  <span class="token comment"># \u4E03\u725B\u4E91\u5BC6\u94A5(\u4E2A\u4EBA\u8BBE\u7F6E-&gt;\u5BC6\u94A5\u7BA1\u7406)</span>
  <span class="token key atrule">key</span><span class="token punctuation">:</span>
    <span class="token key atrule">access</span><span class="token punctuation">:</span> 7Ia7E86E3B9XTQ9TrlA5l_E<span class="token punctuation">-</span>_WBnkmXQhxoE3<span class="token punctuation">-</span>_n
    <span class="token key atrule">secret</span><span class="token punctuation">:</span> 17Ab9TcKnyn_jw4<span class="token punctuation">-</span>a0XyH6iD_acl0KaKGEi6_Hqc
  <span class="token key atrule">bucket</span><span class="token punctuation">:</span>
    <span class="token comment"># \u5934\u50CF\u4E0A\u4F20\u4E91\u670D\u52A1\u5668\u914D\u7F6E(\u4E03\u725B\u4E91\u5BF9\u8C61\u5B58\u50A8)</span>
    <span class="token key atrule">header</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> xmyheader
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//rcmsg2hwa.hb<span class="token punctuation">-</span>bkt.clouddn.com
    <span class="token comment"># \u5206\u4EAB\u529F\u80FD\u4E91\u670D\u52A1\u5668\u914D\u7F6E</span>
    <span class="token key atrule">share</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> xmyshare
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//rcmscfkkw.hb<span class="token punctuation">-</span>bkt.clouddn.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5C06\u5934\u50CF\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#\u5C06\u5934\u50CF\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" aria-hidden="true">#</a> \u5C06\u5934\u50CF\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668</h2><h3 id="\u5BA2\u6237\u7AEF\u4E0A\u4F20" tabindex="-1"><a class="header-anchor" href="#\u5BA2\u6237\u7AEF\u4E0A\u4F20" aria-hidden="true">#</a> \u5BA2\u6237\u7AEF\u4E0A\u4F20</h3><ul><li><p>\u5C06\u5BA2\u6237\u7AEF\u6570\u636E\u63D0\u4EA4\u7ED9\u4E91\u670D\u52A1\u5668\uFF0C\u5E76\u7B49\u5F85\u5176\u54CD\u5E94</p></li><li><p>\u7528\u6237\u4E0A\u4F20\u5934\u50CF\u65F6\uFF0C\u5C06\u8868\u5355\u6570\u636E\u63D0\u4EA4\u7ED9\u670D\u52A1\u5668</p></li></ul><h3 id="_1-\u4FEE\u6539\u6587\u4EF6\u4E0A\u4F20\u76F8\u5E94\u7684controller" tabindex="-1"><a class="header-anchor" href="#_1-\u4FEE\u6539\u6587\u4EF6\u4E0A\u4F20\u76F8\u5E94\u7684controller" aria-hidden="true">#</a> 1.\u4FEE\u6539\u6587\u4EF6\u4E0A\u4F20\u76F8\u5E94\u7684Controller</h3><p>(\u8FD9\u91CC\u662FUserController)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@LoginRequired</span><span class="token comment">//\u81EA\u5B9A\u4E49\u6CE8\u89E3</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/setting&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getSettingPage</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">/</span>\u8BBE\u7F6E\u9875\u9762\u52A0\u8F7D\u65F6\u5C31\u5F00\u59CB\u914D\u7F6E\u4E91\u670D\u52A1\u5668\u4FE1\u606F<span class="token operator">/</span>
        <span class="token comment">// \u4E0A\u4F20\u968F\u673A\u6587\u4EF6\u540D\u79F0</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8BBE\u7F6E\u8FD4\u56DE\u7ED9\u4E91\u670D\u52A1\u5668\u7684\u54CD\u5E94\u4FE1\u606F\uFF08\u89C4\u5B9A\u7528StringMap\uFF09</span>
        <span class="token class-name">StringMap</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        policy<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;returnBody&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u751F\u6210\u4E0A\u4F20\u4E91\u670D\u52A1\u5668\u7684\u51ED\u8BC1</span>
        <span class="token class-name">Auth</span> auth <span class="token operator">=</span> <span class="token class-name">Auth</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u4E0A\u4F20\u6307\u5B9A\u6587\u4EF6\u540D\u5230\u4E91\u670D\u52A1\u5668\u6307\u5B9A\u7A7A\u95F4\uFF0C\u4F20\u5165\u5BC6\u94A5\uFF0C\u8FC7\u671F\u65F6\u95F4</span>
        <span class="token class-name">String</span> uploadToken <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">uploadToken</span><span class="token punctuation">(</span>headerBucketName<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u4E03\u725B\u4E91\u89C4\u5B9A\uFF1A\u8868\u5355\u9700\u8981\u643A\u5E26\u7684\u53C2\u6570</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uploadToken&quot;</span><span class="token punctuation">,</span> uploadToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/setting&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u5F02\u6B65\u66F4\u65B0\u5934\u50CF\u8DEF\u5F84\uFF08\u4E91\u670D\u52A1\u5668\u5F02\u6B65\u8FD4\u56DE<span class="token class-name">Json</span><span class="token punctuation">,</span>\u800C\u4E0D\u662F\u8FD4\u56DE\u9875\u9762\uFF0C\u4E0D\u7136\u4E71\u5957\uFF09
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/header/url&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">updateHeaderUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;\u6587\u4EF6\u540D\u4E0D\u80FD\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> headerBucketUrl <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">;</span>
        <span class="token comment">// \u5C06\u6570\u636E\u5E93\u5934\u50CFurl\u66F4\u6362\u6210\u4E91\u670D\u52A1\u5668\u56FE\u7247url</span>
        userService<span class="token punctuation">.</span><span class="token function">updateHeader</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199\u66F4\u65B0\u5934\u50CF\u8DEF\u5F84\u65F6js\u5F02\u6B65ajax" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199\u66F4\u65B0\u5934\u50CF\u8DEF\u5F84\u65F6js\u5F02\u6B65ajax" aria-hidden="true">#</a> 2.\u7F16\u5199\u66F4\u65B0\u5934\u50CF\u8DEF\u5F84\u65F6js\u5F02\u6B65ajax</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \u4E0A\u4F20\u5230\u4E03\u725B\u4E91\u670D\u52A1\u5668\u7684\u5F02\u6B65\u5904\u7406\u65B9\u6CD5</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#uploadForm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>upload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u8868\u5355\u5F02\u6B65\u63D0\u4EA4\u6587\u4EF6\u4E0D\u80FD\u7528$.post--\u4E0D\u80FD\u6620\u5C04\u6587\u4EF6\u7C7B\u578B\uFF0C\u6240\u4EE5\u7528\u539F\u751F$.ajax</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// \u4E03\u725B\u4E91\u534E\u5317\u5730\u533A\u4E0A\u4F20\u5730\u5740</span>
        <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;http://upload-z1.qiniup.com&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// \u4E0D\u8981\u628A\u8868\u5355\u5185\u5BB9\u8F6C\u4E3A\u5B57\u7B26\u4E32\uFF08\u56E0\u4E3A\u662F\u4E0A\u4F20\u56FE\u7247\u6587\u4EF6\uFF09</span>
        <span class="token literal-property property">processData</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// \u4E0D\u8BA9JQuery\u8BBE\u7F6E\u4E0A\u4F20\u7C7B\u578B(\u4F7F\u7528\u6D4F\u89C8\u5668\u9ED8\u8BA4\u5904\u7406\u65B9\u6CD5\u5C06\u4E8C\u8FDB\u5236\u6587\u4EF6\u968F\u673A\u52A0\u8FB9\u754C\u5B57\u7B26\u4E32)</span>
        <span class="token literal-property property">contentType</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// \u4F20\u6587\u4EF6\u65F6\u9700\u8981\u8FD9\u6837\u4F20data</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#uploadForm&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u66F4\u65B0\u5934\u50CF\u8BBF\u95EE\u8DEF\u5F84</span>
                $<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
                    <span class="token constant">CONTEXT_PATH</span> <span class="token operator">+</span> <span class="token string">&quot;/user/header/url&quot;</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span><span class="token string-property property">&quot;fileName&quot;</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;input[name=&#39;key&#39;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        data <span class="token operator">=</span> $<span class="token punctuation">.</span><span class="token function">parseJSON</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>code <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u5931\u8D25!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// &lt;form&gt;\u8868\u5355\u6CA1\u5199action\uFF0C\u5C31\u5FC5\u987B\u8FD4\u56DEfalse</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u5C06\u5206\u4EAB\u56FE\u7247\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#\u5C06\u5206\u4EAB\u56FE\u7247\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668" aria-hidden="true">#</a> \u5C06\u5206\u4EAB\u56FE\u7247\u4E0A\u4F20\u81F3\u4E91\u670D\u52A1\u5668</h2><h3 id="\u670D\u52A1\u5668\u76F4\u4F20" tabindex="-1"><a class="header-anchor" href="#\u670D\u52A1\u5668\u76F4\u4F20" aria-hidden="true">#</a> \u670D\u52A1\u5668\u76F4\u4F20</h3><ul><li><p>\u672C\u5730\u5E94\u7528\u670D\u52A1\u5668\u5C06\u6570\u636E\u76F4\u63A5\u63D0\u4EA4\u7ED9\u4E91\u670D\u52A1\u5668\uFF0C\u5E76\u7B49\u5F85\u5176\u54CD\u5E94</p></li><li><p>\u5206\u4EAB\u65F6\uFF0C\u670D\u52A1\u7AEF\u5C06\u81EA\u52A8\u751F\u6210\u7684\u56FE\u7247\uFF0C\u76F4\u63A5\u63D0\u4EA4\u7ED9\u4E91\u670D\u52A1\u5668</p></li></ul><h3 id="_1-\u7F16\u5199\u751F\u6210\u957F\u56FE\u5230\u672C\u5730controller" tabindex="-1"><a class="header-anchor" href="#_1-\u7F16\u5199\u751F\u6210\u957F\u56FE\u5230\u672C\u5730controller" aria-hidden="true">#</a> 1.\u7F16\u5199\u751F\u6210\u957F\u56FE\u5230\u672C\u5730Controller</h3><p>(\u4F7F\u7528\u6D88\u606F\u961F\u5217\u5904\u7406\u5E76\u53D1)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> wkhtmltopdf\u5B9E\u73B0\u751F\u6210\u5206\u4EAB\u957F\u56FE\u529F\u80FD
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShareController</span> <span class="token keyword">implements</span> <span class="token class-name">CommunityConstant</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ShareController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">EventProducer</span> eventProducer<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${community.path.domain}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${server.servlet.context-path}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> contextPath<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${wk.image.storage}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> wkImageStorage<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${qiniu.bucket.share.url}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> shareBucketUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/share&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">share</span><span class="token punctuation">(</span><span class="token class-name">String</span> htmlUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u6587\u4EF6\u540D</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">generateUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5F02\u6B65\u751F\u6210\u957F\u56FE</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token constant">TOPIC_SHARE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;htmlUrl&quot;</span><span class="token punctuation">,</span> htmlUrl<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;suffix&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8FD4\u56DE\u8BBF\u95EE\u8DEF\u5F84</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//map.put(&quot;shareUrl&quot;, domain + contextPath + &quot;/share/image/&quot; + fileName);</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;shareUrl&quot;</span><span class="token punctuation">,</span> shareBucketUrl <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u7F16\u5199kafka\u6D88\u8D39\u8005\u2014\u4E0A\u4F20\u5230\u4E91\u670D\u52A1\u5668" tabindex="-1"><a class="header-anchor" href="#_2-\u7F16\u5199kafka\u6D88\u8D39\u8005\u2014\u4E0A\u4F20\u5230\u4E91\u670D\u52A1\u5668" aria-hidden="true">#</a> 2.\u7F16\u5199Kafka\u6D88\u8D39\u8005\u2014\u4E0A\u4F20\u5230\u4E91\u670D\u52A1\u5668</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>\u6267\u884Cwk\u547D\u4EE4\u884C\u7684\u4F4D\u7F6E<span class="token operator">/</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${wk.image.command}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> wkImageCommand<span class="token punctuation">;</span>

    <span class="token operator">/</span>\u5B58\u50A8wk\u56FE\u7247\u4F4D\u7F6E<span class="token operator">/</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${wk.image.storage}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> wkImageStorage<span class="token punctuation">;</span>
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u4F7F\u7528\u4E91\u670D\u52A1\u5668\u83B7\u53D6\u957F\u56FE
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${qiniu.key.access}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> accessKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${qiniu.key.secret}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> secretKey<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${qiniu.bucket.share.name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> shareBucketName<span class="token punctuation">;</span>

    <span class="token operator">/</span>\u5B9A\u65F6\u5668\u907F\u514D\u8FD8\u6CA1\u751F\u6210\u56FE\u7247\u5C31\u4E0A\u4F20\u670D\u52A1\u5668<span class="token operator">/</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadPoolTaskScheduler</span> taskScheduler<span class="token punctuation">;</span>
    
    <span class="token operator">/</span>
     <span class="token operator">*</span> \u6D88\u8D39wkhtmltopdf\u5206\u4EAB\u4E8B\u4EF6
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token constant">TOPIC_SHARE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleShareMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u7684\u5185\u5BB9\u4E3A\u7A7A!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u683C\u5F0F\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> htmlUrl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;htmlUrl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;fileName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> suffix <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;suffix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u6267\u884Ccmd d:/wkhtmltopdf/bin/wkhtmltoimage --quality 75 https://www.nowcoder.com d:/wkhtmltopdf/wk-images/2.png\u547D\u4EE4</span>
        <span class="token class-name">String</span> cmd <span class="token operator">=</span> wkImageCommand <span class="token operator">+</span> <span class="token string">&quot; --quality 75 &quot;</span>
                <span class="token operator">+</span> htmlUrl <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> wkImageStorage <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u751F\u6210\u957F\u56FE\u6210\u529F: &quot;</span> <span class="token operator">+</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u751F\u6210\u957F\u56FE\u5931\u8D25: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u542F\u7528\u5B9A\u65F6\u5668,\u76D1\u89C6\u8BE5\u56FE\u7247,\u4E00\u65E6\u751F\u6210\u4E86,\u5219\u4E0A\u4F20\u81F3\u4E03\u725B\u4E91.</span>
        <span class="token class-name">UploadTask</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadTask</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Future</span> future <span class="token operator">=</span> taskScheduler<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">UploadTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u6587\u4EF6\u540D\u79F0</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> fileName<span class="token punctuation">;</span>
        <span class="token comment">// \u6587\u4EF6\u540E\u7F00</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> suffix<span class="token punctuation">;</span>
        <span class="token comment">// \u542F\u52A8\u4EFB\u52A1\u7684\u8FD4\u56DE\u503C</span>
        <span class="token keyword">private</span> <span class="token class-name">Future</span> future<span class="token punctuation">;</span>
        <span class="token comment">// \u5F00\u59CB\u65F6\u95F4</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> startTime<span class="token punctuation">;</span>
        <span class="token comment">// \u4E0A\u4F20\u6B21\u6570</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> uploadTimes<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">UploadTask</span><span class="token punctuation">(</span><span class="token class-name">String</span> fileName<span class="token punctuation">,</span> <span class="token class-name">String</span> suffix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>suffix <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFuture</span><span class="token punctuation">(</span><span class="token class-name">Future</span> future<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>future <span class="token operator">=</span> future<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u751F\u6210\u5931\u8D25</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&gt;</span> <span class="token number">30000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6267\u884C\u65F6\u95F4\u8FC7\u957F,\u7EC8\u6B62\u4EFB\u52A1:&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// \u4E0A\u4F20\u5931\u8D25</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>uploadTimes <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u4E0A\u4F20\u6B21\u6570\u8FC7\u591A,\u7EC8\u6B62\u4EFB\u52A1:&quot;</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> path <span class="token operator">=</span> wkImageStorage <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> fileName <span class="token operator">+</span> suffix<span class="token punctuation">;</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u5F00\u59CB\u7B2C%d\u6B21\u4E0A\u4F20[%s].&quot;</span><span class="token punctuation">,</span> <span class="token operator">++</span>uploadTimes<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u8BBE\u7F6E\u54CD\u5E94\u4FE1\u606F</span>
                <span class="token class-name">StringMap</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                policy<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;returnBody&quot;</span><span class="token punctuation">,</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u751F\u6210\u4E0A\u4F20\u51ED\u8BC1</span>
                <span class="token class-name">Auth</span> auth <span class="token operator">=</span> <span class="token class-name">Auth</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>accessKey<span class="token punctuation">,</span> secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> uploadToken <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">uploadToken</span><span class="token punctuation">(</span>shareBucketName<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u6307\u5B9A\u4E0A\u4F20\u673A\u623F</span>
                <span class="token class-name">UploadManager</span> manager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UploadManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token class-name">Zone</span><span class="token punctuation">.</span><span class="token function">zone1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// \u5F00\u59CB\u4E0A\u4F20\u56FE\u7247</span>
                    <span class="token class-name">Response</span> response <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>
                            path<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> uploadToken<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;image/&quot;</span> <span class="token operator">+</span> suffix<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// \u5904\u7406\u54CD\u5E94\u7ED3\u679C</span>
                    <span class="token class-name">JSONObject</span> json <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">bodyString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>json <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> json<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>json<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B2C%d\u6B21\u4E0A\u4F20\u5931\u8D25[%s].&quot;</span><span class="token punctuation">,</span> uploadTimes<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B2C%d\u6B21\u4E0A\u4F20\u6210\u529F[%s].&quot;</span><span class="token punctuation">,</span> uploadTimes<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">QiniuException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B2C%d\u6B21\u4E0A\u4F20\u5931\u8D25[%s].&quot;</span><span class="token punctuation">,</span> uploadTimes<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;\u7B49\u5F85\u56FE\u7247\u751F\u6210[&quot;</span> <span class="token operator">+</span> fileName <span class="token operator">+</span> <span class="token string">&quot;].&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="caffine\u672C\u5730\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#caffine\u672C\u5730\u7F13\u5B58" aria-hidden="true">#</a> Caffine\u672C\u5730\u7F13\u5B58</h2><p>\u4F7F\u7528Caffine\u672C\u5730\u7F13\u5B58\u4F18\u5316\u7F51\u7AD9\u6027\u80FD(\u7F13\u5B58\u4E3B\u9875\u70ED\u95E8\u5E16\u5B50)</p><h3 id="_1-\u7F13\u5B58\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_1-\u7F13\u5B58\u6982\u5FF5" aria-hidden="true">#</a> 1.\u7F13\u5B58\u6982\u5FF5</h3><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/1_tj6xWjtzwR.PNG" alt="\u7F13\u5B58\u6982\u5FF5"></p><p>\u6CE8\u610F\uFF1A\u672C\u5730\u7F13\u5B58\u4E00\u822C\u4E0D\u7F13\u5B58\u4E0E\u7528\u6237\u76F8\u5173\u7684\u6570\u636E\uFF08\u5982\uFF1A\u767B\u5F55\u51ED\u8BC1\uFF09\u539F\u56E0\u5982\u4E0B\u56FE</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/\u7F13\u5B58_A75I7HXwOl.PNG" alt="\u672C\u5730\u7F13\u5B58"></p><p>\u6CE8\u610F\uFF1A\u4E8C\u7EA7\u7F13\u5B58\u6D41\u7A0B\u5982\u4E0B\u56FE\u6240\u793A</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/\u4E8C\u7EA7\u7F13\u5B58_NRiwLsumxv.PNG" alt="\u4E8C\u7EA7\u7F13\u5B58"></p><h3 id="_2-\u5F15\u5165caffine\u4F9D\u8D56\u9879" tabindex="-1"><a class="header-anchor" href="#_2-\u5F15\u5165caffine\u4F9D\u8D56\u9879" aria-hidden="true">#</a> 2.\u5F15\u5165caffine\u4F9D\u8D56\u9879</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token comment">&lt;!--caffeine\u672C\u5730\u7F13\u5B58\u4F18\u5316\u70ED\u95E8\u5E16\u5B50--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.ben-manes.caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>caffeine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.9.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u7F16\u5199yml\u914D\u7F6Ecaffine\u5168\u5C40\u53D8\u91CF" tabindex="-1"><a class="header-anchor" href="#_3-\u7F16\u5199yml\u914D\u7F6Ecaffine\u5168\u5C40\u53D8\u91CF" aria-hidden="true">#</a> 3.\u7F16\u5199yml\u914D\u7F6Ecaffine\u5168\u5C40\u53D8\u91CF</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># caffeine\u672C\u5730\u7F13\u5B58\u4F18\u5316\u70ED\u95E8\u5E16\u5B50</span>
<span class="token key atrule">caffeine</span><span class="token punctuation">:</span>
  <span class="token key atrule">posts</span><span class="token punctuation">:</span>
    <span class="token comment"># \u6700\u5927\u7F13\u5B5815\u9875</span>
    <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token number">15</span>
    <span class="token key atrule">expire-seconds</span><span class="token punctuation">:</span> <span class="token number">180</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u4FEE\u6539discusspostservice\u4E1A\u52A1\u5C42\u5206\u9875\u67E5\u8BE2\u65B9\u6CD5" tabindex="-1"><a class="header-anchor" href="#_4-\u4FEE\u6539discusspostservice\u4E1A\u52A1\u5C42\u5206\u9875\u67E5\u8BE2\u65B9\u6CD5" aria-hidden="true">#</a> 4.\u4FEE\u6539DiscussPostService\u4E1A\u52A1\u5C42\u5206\u9875\u67E5\u8BE2\u65B9\u6CD5</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token operator">/</span>
     <span class="token operator">*</span> \u4F7F\u7528caffine\u7F13\u5B58\u70ED\u95E8\u5E16\u5B50<span class="token punctuation">(</span>\u53EF\u7528<span class="token class-name">Jmeter</span>\u538B\u529B\u6D4B\u8BD5<span class="token punctuation">)</span>
     <span class="token operator">*</span> <span class="token constant">QQ</span><span class="token operator">:</span><span class="token number">260602448</span>
     <span class="token operator">*</span> <span class="token class-name">Caffeine</span>\u6838\u5FC3\u63A5\u53E3<span class="token operator">:</span> <span class="token class-name">Cache</span><span class="token punctuation">,</span> <span class="token class-name">LoadingCache</span><span class="token punctuation">(</span>\u5E38\u7528\u540C\u6B65<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">AsyncLoadingCache</span><span class="token punctuation">(</span>\u5F02\u6B65<span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.max-size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxSize<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.expire-seconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>

    <span class="token comment">// \u5E16\u5B50\u5217\u8868\u7F13\u5B58</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postListCache<span class="token punctuation">;</span>
    <span class="token comment">// \u5E16\u5B50\u603B\u6570\u7F13\u5B58</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> postRowsCache<span class="token punctuation">;</span>
    
    <span class="token comment">// \u9879\u76EE\u542F\u52A8\u65F6\u521D\u59CB\u5316\u7F13\u5B58</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u521D\u59CB\u5316\u5E16\u5B50\u5217\u8868\u7F13\u5B58</span>
        postListCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token comment">// load\u65B9\u6CD5\uFF1A\u5F53\u6CA1\u6709\u7F13\u5B58\u65F6\uFF0C\u67E5\u8BE2\u6570\u636E\u5E93</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// \u8FD9\u91CC\u53EF\u7528\u4E8C\u7EA7\u7F13\u5B58\uFF1ARedis -&gt; mysql</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECE\u6570\u636E\u5E93\u4E2D\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u521D\u59CB\u5316\u5E16\u5B50\u603B\u6570\u7F13\u5B58</span>
        postRowsCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Nullable</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Integer</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECE\u6570\u636E\u5E93\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\u603B\u6570\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussRows</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>
     <span class="token operator">*</span> \u4E3B\u9875\u5206\u9875\u67E5\u8BE2\u5E16\u5B50\uFF08\u4F7F\u7528\u7F13\u5B58\u67E5\u8BE2\u70ED\u95E8\u5E16\u5B50<span class="token operator">-&gt;</span>\u5373userId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>orderMode<span class="token operator">=</span><span class="token number">1</span>\uFF09
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> orderMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> orderMode <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECECaffeine\u7F13\u5B58\u4E2D\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> postListCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECE\u6570\u636E\u5E93\u4E2D\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// userId=0\uFF1A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECECaffeine\u7F13\u5B58\u4E2D\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> postRowsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u6B63\u5728\u4ECE\u6570\u636E\u5E93\u52A0\u8F7D\u70ED\u95E8\u5E16\u5B50\u603B\u6570\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussRows</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u7EDF\u4E00\u5904\u7406\u5F02\u5E38" tabindex="-1"><a class="header-anchor" href="#\u7EDF\u4E00\u5904\u7406\u5F02\u5E38" aria-hidden="true">#</a> \u7EDF\u4E00\u5904\u7406\u5F02\u5E38</h2><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/1_i21SWKVzkp.PNG" alt="\u5F02\u5E38\u5904\u7406\u65B9\u6CD5"></p><h3 id="_1-\u5C06error-404-html\u6216500-html\u653E\u5728templates" tabindex="-1"><a class="header-anchor" href="#_1-\u5C06error-404-html\u6216500-html\u653E\u5728templates" aria-hidden="true">#</a> 1.\u5C06error/404.html\u6216500.html\u653E\u5728templates</h3><p>\u6CE8\u610F\uFF1Aspringboot\u9ED8\u8BA4\u5728templates\u8D44\u6E90\u8DEF\u5F84\u4E0B\u9762\u65B0\u5EFAerror\u76EE\u5F55\uFF0C\u6DFB\u52A0404.html\u548C500.html\u9875\u9762\u5C31\u4F1A\u81EA\u52A8\u914D\u7F6E\u4E0A\u9519\u8BEF\u9875\u9762\u81EA\u52A8\u8DF3\u8F6C</p><h3 id="_2-\u5B9A\u4E49\u4E00\u4E2A\u63A7\u5236\u5668\u901A\u77E5\u7EC4\u4EF6-\u5904\u7406\u6240\u6709controller\u6240\u53D1\u751F\u7684\u5F02\u5E38" tabindex="-1"><a class="header-anchor" href="#_2-\u5B9A\u4E49\u4E00\u4E2A\u63A7\u5236\u5668\u901A\u77E5\u7EC4\u4EF6-\u5904\u7406\u6240\u6709controller\u6240\u53D1\u751F\u7684\u5F02\u5E38" aria-hidden="true">#</a> 2.\u5B9A\u4E49\u4E00\u4E2A\u63A7\u5236\u5668\u901A\u77E5\u7EC4\u4EF6\uFF0C\u5904\u7406\u6240\u6709Controller\u6240\u53D1\u751F\u7684\u5F02\u5E38</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ControllerAdvice</span><span class="token punctuation">(</span>annotations <span class="token operator">=</span> <span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionAdvice</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ExceptionAdvice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u670D\u52A1\u5668\u53D1\u751F\u5F02\u5E38: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5FAA\u73AF\u6253\u5370\u5F02\u5E38\u6808\u4E2D\u7684\u6BCF\u4E00\u6761\u9519\u8BEF\u4FE1\u606F\u5E76\u8BB0\u5F55</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span> element <span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u5224\u65AD\u5F02\u5E38\u8FD4\u56DE\u7684\u662FHTML\u8FD8\u662FJson\u5F02\u6B65\u683C\u5F0F\u5B57\u7B26\u4E32</span>
        <span class="token class-name">String</span> xRequestedWith <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-requested-with&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// XMLHttpRequest: Json\u683C\u5F0F\u5B57\u7B26\u4E32</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>xRequestedWith<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u9875\u9762\u54CD\u5E94\u666E\u901Aplain\u5B57\u7B26\u4E32\u683C\u5F0F</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/plain;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;\u670D\u52A1\u5668\u5F02\u5E38!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getErrorPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;/error/500&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#\u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7" aria-hidden="true">#</a> \u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7</h2><h3 id="_1-aop\u6982\u5FF5" tabindex="-1"><a class="header-anchor" href="#_1-aop\u6982\u5FF5" aria-hidden="true">#</a> 1.AOP\u6982\u5FF5</h3><p>\uFF08\u9762\u5411\u5207\u9762\u7F16\u7A0B\uFF09</p><p>\u5E38\u89C1\u7684\u4F7F\u7528\u573A\u666F\u6709\uFF1A\u6743\u9650\u68C0\u67E5\u3001\u8BB0\u5F55\u65E5\u5FD7\u3001\u4E8B\u52A1\u7BA1\u7406</p><p>Joinpoint\uFF1A\u76EE\u6807\u5BF9\u8C61\u4E0A\u7EC7\u5165\u4EE3\u7801\u7684\u4F4D\u7F6E\u53EB\u505Ajoinpoint</p><p>Pointcut\uFF1A\u662F\u7528\u6765\u5B9A\u4E49\u5F53\u524D\u7684\u6A2A\u5207\u903B\u8F91\u51C6\u5907\u7EC7\u5165\u5230\u54EA\u4E9B\u8FDE\u63A5\u70B9\u4E0A \uFF08\u5982service\u6240\u6709\u65B9\u6CD5\uFF09</p><p>Advice\uFF1A\u7528\u6765\u5B9A\u4E49\u6A2A\u5207\u903B\u8F91\uFF0C\u5373\u5728\u8FDE\u63A5\u70B9\u4E0A\u51C6\u5907\u7EC7\u5165\u4EC0\u4E48\u6837\u7684\u903B\u8F91</p><p>Aspect\uFF1A\u662F\u4E00\u4E2A\u7528\u6765\u5C01\u88C5\u5207\u70B9\u548C\u901A\u77E5\u7684\u7EC4\u4EF6</p><p>\u7EC7\u5165\uFF1A\u5C31\u662F\u5C06\u65B9\u9762\u7EC4\u4EF6\u4E2D\u5B9A\u4E49\u7684\u6A2A\u5207\u903B\u8F91\uFF0C\u7EC7\u5165\u5230\u76EE\u6807\u5BF9\u8C61\u7684\u8FDE\u63A5\u70B9\u7684\u8FC7\u7A0B</p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/4_meyoKw9Tl0.PNG" alt="AOP\u6982\u5FF5"></p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/2_sORheMmJkN.PNG" alt="AOP\u672F\u8BED"></p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/5_QUs9Pp_hv5.PNG" alt="AOP\u7684\u5B9E\u73B0"></p><p><img src="https://nevermore-picbed-1304219157.cos.ap-guangzhou.myqcloud.com/3_e4i508lART.PNG" alt="SpringAOP"></p><h3 id="_2-aop\u5207\u9762\u7F16\u7A0Bdemo\u793A\u4F8B" tabindex="-1"><a class="header-anchor" href="#_2-aop\u5207\u9762\u7F16\u7A0Bdemo\u793A\u4F8B" aria-hidden="true">#</a> 2.AOP\u5207\u9762\u7F16\u7A0BDemo\u793A\u4F8B</h3><h4 id="_2-1\u5BFC\u5165pom-xml" tabindex="-1"><a class="header-anchor" href="#_2-1\u5BFC\u5165pom-xml" aria-hidden="true">#</a> 2.1\u5BFC\u5165pom.xml</h4><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2\u7F16\u5199aspect\u7C7B" tabindex="-1"><a class="header-anchor" href="#_2-2\u7F16\u5199aspect\u7C7B" aria-hidden="true">#</a> 2.2\u7F16\u5199Aspect\u7C7B</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoAspect</span> <span class="token punctuation">{</span>
    <span class="token operator">/</span>
      <span class="token operator">*</span>\u7B2C\u4E00\u4E2A<span class="token operator">*</span> \uFF1A\u65B9\u6CD5\u7684\u4EFB\u4F55\u8FD4\u56DE\u503C
     <span class="token operator">*</span> com<span class="token punctuation">.</span>xmy<span class="token punctuation">.</span>demonowcoder<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \uFF1Aservice\u5305\u4E0B\u7684\u6240\u6709\u7C7B\u6240\u6709\u65B9\u6CD5\u6240\u6709\u53C2\u6570<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
     <span class="token operator">*</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* com.xmy.demonowcoder.service. *.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token operator">/</span>\u5207\u70B9\u65B9\u6CD5\u4E4B\u524D\u6267\u884C<span class="token punctuation">(</span>\u5E38\u7528<span class="token punctuation">)</span><span class="token operator">/</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>\u8FD4\u56DE\u503C\u4EE5\u540E\u6267\u884C<span class="token operator">/</span>
    <span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterRetuning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterRetuning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">/</span>\u629B\u51FA\u5F02\u5E38\u4EE5\u540E\u6267\u884C<span class="token operator">/</span>
    <span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterThrowing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">/</span>\u5207\u70B9\u7684\u524D\u548C\u540E\u90FD\u53EF\u4EE5\u6267\u884C<span class="token operator">/</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> obj <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around after&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-aop\u5B9E\u73B0\u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7" tabindex="-1"><a class="header-anchor" href="#_3-aop\u5B9E\u73B0\u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7" aria-hidden="true">#</a> 3.AOP\u5B9E\u73B0\u7EDF\u4E00\u8BB0\u5F55\u65E5\u5FD7</h3><p>\u5B9E\u73B0\u9700\u6C42:</p><p>\u7528\u6237ip\u5730\u5740[1.2.3.4],\u5728[xxx],\u8BBF\u95EE\u4E86[com.nowcoder.community.service.xxx](http://com.nowcoder.community.service.xxx&quot;com.nowcoder.community.service.xxx&quot;)()]\u4E1A\u52A1.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLogAspect</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ServiceLogAspect</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* com.xmy.demonowcoder.service.*. *(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// \u7528\u6237ip[1.2.3.4],\u5728[xxx],\u8BBF\u95EE\u4E86[com.nowcoder.community.service.xxx()].</span>
        <span class="token comment">// \u901A\u8FC7RequestContextHolder\u83B7\u53D6request</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u901A\u8FC7request.getRemoteHost\u83B7\u53D6\u5F53\u524D\u7528\u6237ip</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">/</span>
         <span class="token operator">*</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">--</span><span class="token operator">&gt;</span>com<span class="token punctuation">.</span>nowcoder<span class="token punctuation">.</span>community<span class="token punctuation">.</span>service
         <span class="token operator">*</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span>\u65B9\u6CD5\u540D
         <span class="token operator">*</span><span class="token operator">/</span>
        <span class="token class-name">String</span> target <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span>joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// String.format()\u52A0\u5DE5\u5B57\u7B26\u4E32</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237[%s],\u5728[%s],\u8BBF\u95EE\u4E86[%s]\u4E1A\u52A1.&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> time<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u9879\u76EE\u76D1\u63A7" tabindex="-1"><a class="header-anchor" href="#\u9879\u76EE\u76D1\u63A7" aria-hidden="true">#</a> \u9879\u76EE\u76D1\u63A7</h2><p>\uFF08Springboot actuator\uFF09</p><h3 id="_1-\u5F15\u5165pom-xml\u4F9D\u8D56" tabindex="-1"><a class="header-anchor" href="#_1-\u5F15\u5165pom-xml\u4F9D\u8D56" aria-hidden="true">#</a> 1.\u5F15\u5165pom.xml\u4F9D\u8D56</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- actuator\u9879\u76EE\u76D1\u63A7--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.7.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-\u914D\u7F6Eyml\u6587\u4EF6-1" tabindex="-1"><a class="header-anchor" href="#_2-\u914D\u7F6Eyml\u6587\u4EF6-1" aria-hidden="true">#</a> 2.\u914D\u7F6Eyml\u6587\u4EF6</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># actuator\u9879\u76EE\u76D1\u63A7</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> beans<span class="token punctuation">,</span>database<span class="token punctuation">,</span>info<span class="token punctuation">,</span>health
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-\u81EA\u5B9A\u4E49\u76D1\u63A7id" tabindex="-1"><a class="header-anchor" href="#_3-\u81EA\u5B9A\u4E49\u76D1\u63A7id" aria-hidden="true">#</a> 3.\u81EA\u5B9A\u4E49\u76D1\u63A7id</h3><p>(database\u6570\u636E\u5E93\u76D1\u63A7)</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">/</span>
 <span class="token operator">*</span> <span class="token constant">QQ</span><span class="token operator">:</span><span class="token number">260602448</span><span class="token operator">--</span>xumingyu
 <span class="token operator">*</span> \u81EA\u5B9A\u4E49\u9879\u76EE\u76D1\u63A7\u7C7B
 <span class="token operator">*</span><span class="token operator">/</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Endpoint</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">&quot;database&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatabaseEndpoint</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DatabaseEndpoint</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>

    <span class="token comment">// \u76F8\u5F53\u4E8EGET\u8BF7\u6C42</span>
    <span class="token annotation punctuation">@ReadOperation</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">checkConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token comment">// \u653E\u5230try\u8FD9\u4E2A\u4F4D\u7F6E\u5C31\u4E0D\u7528\u91CA\u653E\u8D44\u6E90\uFF0C\u5E95\u5C42\u81EA\u52A8\u91CA\u653E</span>
                <span class="token class-name">Connection</span> conn <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;\u83B7\u53D6\u8FDE\u63A5\u6210\u529F!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u83B7\u53D6\u8FDE\u63A5\u5931\u8D25:&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">CommunityUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;\u83B7\u53D6\u8FDE\u63A5\u5931\u8D25!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-\u4F7F\u7528springsecurity\u8BBE\u7F6E\u8BBF\u95EE\u6743\u9650" tabindex="-1"><a class="header-anchor" href="#_4-\u4F7F\u7528springsecurity\u8BBE\u7F6E\u8BBF\u95EE\u6743\u9650" aria-hidden="true">#</a> 4.\u4F7F\u7528SpringSecurity\u8BBE\u7F6E\u8BBF\u95EE\u6743\u9650</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>
        <span class="token string">&quot;/discuss/delete&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;/data/* *&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;/actuator/* *&quot;</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">hasAnyAuthority</span><span class="token punctuation">(</span>
        <span class="token constant">AUTHORITY_ADMIN</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#\u53C2\u8003" aria-hidden="true">#</a> \u53C2\u8003</h2>`,391),S={href:"https://blog.csdn.net/lijiaming_99/article/details/124931663",target:"_blank",rel:"noopener noreferrer"},x=s("https://blog.csdn.net/lijiaming_99/article/details/124931663");function I(T,_){const a=l("ExternalLinkIcon");return o(),c("div",null,[n("h2",i,[k,r,n("a",d,[v,t(a)])]),m,n("p",null,[b,n("a",g,[y,t(a)])]),q,n("p",null,[n("a",f,[h,t(a)])]),w,n("ul",null,[n("li",null,[n("a",S,[x,t(a)])])])])}const j=e(u,[["render",I],["__file","nowcoder.html.vue"]]);export{j as default};
